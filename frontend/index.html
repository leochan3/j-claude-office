<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobSpy Web Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }

        .auth-section {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .auth-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .auth-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .user-info {
            color: white;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            background: #f8f9ff;
            border-bottom: 2px solid #e0e6ed;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab-button:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab-button .tab-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-form {
            padding: 30px;
            background: #f8f9ff;
            border-bottom: 1px solid #e0e6ed;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #4a5568;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .multi-select {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            max-height: 120px;
            overflow-y: auto;
        }

        .site-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
        }

        .search-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 20px auto;
            display: block;
        }

        .search-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .search-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            90%, 100% { content: ''; }
        }

        /* AI Filtering Styles */
        .ai-filter-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e0;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            display: none;
        }

        .ai-filter-panel.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #cbd5e0;
        }

        .ai-panel-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .ai-form-group {
            display: flex;
            flex-direction: column;
        }

        .ai-form-group label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .ai-form-group textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
        }

        .ai-form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .ai-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-self: start;
        }

        .ai-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .ai-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ai-results {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .ai-analysis-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .ai-analysis-header {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .ai-analysis-text {
            color: #4a5568;
            line-height: 1.6;
        }

        .ai-filter-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .ai-filter-badge.pass {
            background: #c6f6d5;
            color: #22543d;
        }

        .ai-filter-badge.fail {
            background: #fed7d7;
            color: #742a2a;
        }

        .example-prompts {
            background: #edf2f7;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .example-prompts strong {
            color: #2d3748;
        }

        .example-prompts div {
            margin: 4px 0;
            color: #4a5568;
        }

        .results {
            padding: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .job-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }

        .job-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .job-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .job-company {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: 600;
        }

        .job-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .job-detail {
            background: #f7fafc;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .job-detail strong {
            color: #4a5568;
        }

        .job-description {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .job-links {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .job-link {
            background: #667eea;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .job-link:hover {
            background: #5a67d8;
        }

        /* Save Job Button Styles */
        .save-job-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .save-job-btn:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(72, 187, 120, 0.3);
        }

        .save-job-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .save-job-btn.saved {
            background: #e53e3e;
        }

        .save-job-btn.saved:hover {
            background: #c53030;
        }

        /* Saved Jobs Specific Styles */
        .saved-jobs-container {
            padding: 30px;
        }

        .saved-job-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            border-left: 4px solid #48bb78;
        }

        .saved-job-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .saved-job-meta {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #666;
            flex-wrap: wrap;
            gap: 10px;
        }

        .saved-job-meta > div:first-child {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .saved-date {
            font-weight: 500;
        }

        .saved-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .remove-job-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .remove-job-btn:hover {
            background: #c53030;
        }

        .notes-section {
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 3px solid #667eea;
        }

        .notes-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
        }

        .notes-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #4a5568;
        }

        .empty-state p {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #e53e3e;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #38a169;
        }

        /* Authentication Modal Styles */
        .auth-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .auth-modal-overlay.show {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .auth-modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .auth-modal-close:hover {
            color: #333;
        }

        .auth-modal h2 {
            margin: 0 0 25px 0;
            color: #2d3748;
            text-align: center;
            font-size: 1.8rem;
        }

        .auth-form-group {
            margin-bottom: 20px;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .auth-form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .auth-form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 15px;
        }

        .auth-submit-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .auth-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-switch {
            text-align: center;
            color: #666;
            margin-top: 15px;
        }

        .auth-switch button {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
        }

        .auth-switch button:hover {
            color: #5a67d8;
        }

        /* User Profile Modal Styles */
        .profile-modal {
            max-width: 500px;
        }

        .profile-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .profile-section h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 1.2rem;
        }

        .preference-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .preference-group label {
            flex: 1;
            margin: 0;
        }

        .preference-group input, .preference-group select {
            flex: 2;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }

        .preference-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .preference-checkbox input[type="checkbox"] {
            width: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .job-header {
                flex-direction: column;
                gap: 10px;
            }

            .job-details {
                grid-template-columns: 1fr;
            }
        }

        /* Resume Builder Styles */
        .resume-builder-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .resume-form-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-section {
            margin-bottom: 40px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 30px;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .form-section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .add-button {
            background: #e2e8f0;
            color: #4a5568;
            border: 2px dashed #cbd5e0;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .add-button:hover {
            background: #cbd5e0;
            border-color: #a0aec0;
            color: #2d3748;
        }

        .education-item,
        .experience-item,
        .project-item,
        .skill-category {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .remove-item-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fed7d7;
            color: #c53030;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .remove-item-btn:hover {
            background: #feb2b2;
        }

        #latex-preview-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .latex-preview pre {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .resume-form-container {
                padding: 20px;
            }
            
            .form-section h3 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="auth-section" id="auth-section">
                <button class="auth-button" onclick="showAuthModal('login')" id="login-btn">Login</button>
                <button class="auth-button" onclick="showAuthModal('register')" id="register-btn">Register</button>
                <div class="user-info" id="user-info" style="display: none;">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span id="user-email">user@example.com</span>
                    <button class="auth-button" onclick="showProfileModal()" id="profile-btn">Profile</button>
                    <button class="auth-button" onclick="logout()" id="logout-btn">Logout</button>
                </div>
            </div>
            <h1>🔍 JobSpy Web Interface</h1>
            <p>Search jobs across multiple platforms with one powerful tool</p>
        </div>

        <div class="main-content">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-button active" data-tab="search">
                    <span class="tab-icon">🔍</span>
                    Search Jobs
                </button>
                <button class="tab-button" data-tab="resume">
                    <span class="tab-icon">📄</span>
                    Resume Builder
                </button>
                <button class="tab-button auth-required" data-tab="saved" style="display: none;">
                    <span class="tab-icon">💾</span>
                    Saved Jobs (<span id="saved-count">0</span>)
                </button>
                <button class="tab-button auth-required" data-tab="history" style="display: none;">
                    <span class="tab-icon">📈</span>
                    Search History
                </button>
                <button class="tab-button auth-required" data-tab="preferences" style="display: none;">
                    <span class="tab-icon">⚙️</span>
                    Preferences
                </button>
            </div>

            <!-- Search Tab Content -->
            <div id="search-tab" class="tab-content active">
                <form id="job-search-form" class="search-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="search-term">Job Title/Role (Optional)</label>
                        <input type="text" id="search-term" name="search_term" placeholder="e.g., Product Manager, Software Engineer, or 'all' for all jobs">
                    </div>

                    <div class="form-group">
                        <label for="company-filter">Company Filter (Optional)</label>
                        <input type="text" id="company-filter" name="company_filter" value="" placeholder="e.g., Google, Apple, Microsoft">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 4px; display: block;">
                            🎯 <strong>Search specific companies:</strong> Use commas to search multiple (e.g., "Google, Apple, Microsoft")<br>
                            💡 <strong>Leave empty to see ALL companies</strong>
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="exclude-keywords">Exclude Keywords (Optional)</label>
                        <input type="text" id="exclude-keywords" name="exclude_keywords" value="" placeholder="e.g., senior, manager, lead">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 4px; display: block;">
                            ❌ <strong>Exclude jobs with these words in the title:</strong> Use commas to exclude multiple (e.g., "senior, manager, lead")<br>
                            💡 <strong>Leave empty to see ALL job titles</strong>
                        </small>
                    </div>


                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" value="">
                    </div>


                    <div class="form-group">
                        <label for="distance">Distance (miles)</label>
                        <input type="number" id="distance" name="distance" value="50" min="1" max="200">
                    </div>

                    <div class="form-group">
                        <label for="job-type">Job Type</label>
                        <select id="job-type" name="job_type">
                            <option value="">All Types</option>
                            <option value="fulltime">Full Time</option>
                            <option value="parttime">Part Time</option>
                            <option value="internship">Internship</option>
                            <option value="contract">Contract</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="country-indeed">Country (Indeed/Glassdoor)</label>
                        <select id="country-indeed" name="country_indeed">
                            <option value="USA">USA</option>
                            <option value="Canada">Canada</option>
                            <option value="UK">UK</option>
                            <option value="Australia">Australia</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="India">India</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="hours-old">Hours Since Posted</label>
                        <input type="number" id="hours-old" name="hours_old" value="10000" placeholder="e.g., 24">
                    </div>

                    <div class="form-group">
                        <label for="max-salary">Maximum Salary (USD)</label>
                        <input type="number" id="max-salary" name="max_salary" placeholder="e.g., 200000" step="1000" min="0">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 4px; display: block;">
                            💰 <strong>Filter out high-salary jobs:</strong> Jobs with minimum salary above this amount will be hidden<br>
                            💡 <strong>Leave empty to see all salaries</strong>
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="expected-salary">Expected Salary (USD)</label>
                        <input type="number" id="expected-salary" name="expected_salary" placeholder="e.g., 150000" step="5000" min="0">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 4px; display: block;">
                            🎯 <strong>Boost ranking for salary matches:</strong> Jobs with salaries closer to this amount will rank higher<br>
                            💡 <strong>Leave empty to ignore salary in ranking</strong>
                        </small>
                    </div>

                    <!-- New: Max Years of Experience filter -->
                    <div class="form-group">
                        <label for="max-yoe">Max Years of Experience</label>
                        <input type="number" id="max-yoe" name="max_years_experience" placeholder="e.g., 3" min="0">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 4px; display: block;">
                            🎯 <strong>Filter out jobs requiring more experience than you want.</strong><br>
                            <strong>Example:</strong> Enter 3 to hide jobs needing 4+ years.<br>
                            <strong>Leave empty to see all jobs.</strong>
                        </small>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="is-remote" name="is_remote">
                            <label for="is-remote">Remote Jobs Only</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Job Sites to Search</label>
                    <div class="multi-select">
                        <div class="site-option">
                            <input type="checkbox" id="site-indeed" name="site_name" value="indeed" checked>
                            <label for="site-indeed">Indeed (Best performance, no rate limiting)</label>
                        </div>
                        <div class="site-option">
                            <input type="checkbox" id="site-linkedin" name="site_name" value="linkedin">
                            <label for="site-linkedin">LinkedIn (May require rate limiting)</label>
                        </div>
                        <div class="site-option">
                            <input type="checkbox" id="site-glassdoor" name="site_name" value="glassdoor">
                            <label for="site-glassdoor">Glassdoor</label>
                        </div>
                        <div class="site-option">
                            <input type="checkbox" id="site-ziprecruiter" name="site_name" value="zip_recruiter">
                            <label for="site-ziprecruiter">ZipRecruiter (US/Canada only)</label>
                        </div>
                        <div class="site-option">
                            <input type="checkbox" id="site-google" name="site_name" value="google">
                            <label for="site-google">Google Jobs</label>
                        </div>
                        <div class="site-option">
                            <input type="checkbox" id="site-bayt" name="site_name" value="bayt">
                            <label for="site-bayt">Bayt (International)</label>
                        </div>
                        <div class="site-option">
                            <input type="checkbox" id="site-naukri" name="site_name" value="naukri">
                            <label for="site-naukri">Naukri (India)</label>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
                    <button type="submit" class="search-button" id="search-btn">
                        🚀 Search Jobs
                    </button>
                </div>
            </form>

            <div id="results-container"></div>
            
            <!-- AI Filtering Panel -->
            <div id="ai-filter-panel" class="ai-filter-panel">
                <div class="ai-panel-header">
                    <div class="ai-panel-title">
                        🤖 AI-Powered Job Analysis & Filtering
                    </div>
                </div>
                
                <div class="ai-form-grid">
                    <!-- API Key Input Field -->
                    <div class="ai-form-group">
                        <label for="openai-api-key">OpenAI API Key *</label>
                        <input type="password" id="openai-api-key" placeholder="sk-..." autocomplete="off" style="font-family:monospace; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 4px; display: block;">
                            🔒 Your API key is only stored in your browser and sent securely with each AI request.<br>
                            <strong>Never share your key publicly.</strong>
                        </small>
                    </div>
                    
                    <div class="ai-form-group">
                        <label for="analysis-prompt">Analysis Request *</label>
                        <textarea 
                            id="analysis-prompt" 
                            placeholder="What do you want to analyze about each job?"
                            required
                        ></textarea>
                        <div class="example-prompts">
                            <strong>Example analysis requests:</strong>
                            <div>• "Summarize how many years of experience this job requires"</div>
                            <div>• "List the key technical skills mentioned"</div>
                            <div>• "What is the salary range for this position?"</div>
                            <div>• "Is this role remote-friendly?"</div>
                        </div>
                    </div>
                    
                    <div class="ai-form-group">
                        <label for="filter-criteria">Filter Criteria (Optional)</label>
                        <textarea 
                            id="filter-criteria" 
                            placeholder="How should jobs be filtered based on the analysis?"
                        ></textarea>
                        <div class="example-prompts">
                            <strong>Example filter criteria:</strong>
                            <div>• "Show only jobs requiring 5+ years of experience"</div>
                            <div>• "Filter for jobs mentioning Python or JavaScript"</div>
                            <div>• "Show only jobs with salary above $100k"</div>
                            <div>• "Keep only fully remote positions"</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button type="button" id="ai-analyze-btn" class="ai-button">
                        🧠 Analyze Jobs
                    </button>
                    <div id="ai-status" style="color: #666; font-size: 0.9rem;"></div>
                </div>
                
                <div id="ai-results-container">                    </div>
                </div>
            </div>
            </div> <!-- End Search Tab -->

            <!-- Resume Builder Tab Content -->
            <div id="resume-tab" class="tab-content">
                <div class="resume-builder-container">
                    <div class="results-header">
                        <div class="results-count">Resume Builder</div>
                        <div class="actions">
                            <button id="preview-resume-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem;">
                                👁️ Preview LaTeX
                            </button>
                            <button id="download-resume-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem;">
                                📥 Download LaTeX
                            </button>
                            <button id="generate-pdf-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem; background: #48bb78;">
                                📄 Generate PDF
                            </button>
                            <button id="preview-pdf-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem; background: #805ad5;">
                                👁️ Preview PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- PDF Generation Info -->
                    <div style="background: #e6fffa; border: 1px solid #38b2ac; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 14px;">
                        <div style="font-weight: 600; color: #2c7a7b; margin-bottom: 8px;">📄 PDF Generation Options</div>
                        <div style="color: #2d3748;">
                            <strong>Option 1:</strong> Click "👁️ Preview PDF" to see your LaTeX-compiled resume<br>
                            <strong>Option 2:</strong> Click "📄 Generate PDF" for direct LaTeX-compiled download<br>
                            <strong>Option 3:</strong> Click "📥 Download LaTeX" → paste code into <a href="https://www.overleaf.com" target="_blank" style="color: #38b2ac;">Overleaf.com</a> (backup option)<br>
                            <strong>Option 4:</strong> Click "👁️ Preview LaTeX" to inspect the code before compiling<br>
                            <div id="backend-status" style="margin-top: 10px; font-size: 12px; color: #4a5568;"></div>
                        </div>
                    </div>

                    <div class="resume-form-container">
                        <form id="resume-form" class="resume-form">
                            <!-- Personal Information Section -->
                            <div class="form-section">
                                <h3>📋 Personal Information</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="full-name">Full Name *</label>
                                        <input type="text" id="full-name" name="fullName" required placeholder="Leo Chan">
                                    </div>
                                    <div class="form-group">
                                        <label for="phone">Phone Number</label>
                                        <input type="tel" id="phone" name="phone" placeholder="+1 617-259-7336">
                                    </div>
                                    <div class="form-group">
                                        <label for="email">Email *</label>
                                        <input type="email" id="email" name="email" required placeholder="leochan@alumni.harvard.edu">
                                    </div>
                                    <div class="form-group">
                                        <label for="linkedin">LinkedIn Profile</label>
                                        <input type="url" id="linkedin" name="linkedin" placeholder="https://www.linkedin.com/in/szeonchan/">
                                    </div>
                                    <div class="form-group">
                                        <label for="work-auth">Work Authorization</label>
                                        <input type="text" id="work-auth" name="workAuth" placeholder="Unlimited U.S. work authorization">
                                    </div>
                                </div>
                            </div>

                            <!-- Education Section -->
                            <div class="form-section">
                                <h3>🎓 Education</h3>
                                <div id="education-container">
                                    <div class="education-item">
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label>Institution *</label>
                                                <input type="text" name="education[0][institution]" required placeholder="Harvard University">
                                            </div>
                                            <div class="form-group">
                                                <label>Location</label>
                                                <input type="text" name="education[0][location]" placeholder="Cambridge, MA">
                                            </div>
                                            <div class="form-group">
                                                <label>Degree *</label>
                                                <input type="text" name="education[0][degree]" required placeholder="M.Ed., Policy & Analysis">
                                            </div>
                                            <div class="form-group">
                                                <label>Duration</label>
                                                <input type="text" name="education[0][duration]" placeholder="Jul 2023 - May 2024">
                                            </div>
                                            <div class="form-group full-width">
                                                <label>Details (one per line)</label>
                                                <textarea name="education[0][details]" rows="3" placeholder="Cross-Registered: Harvard Business School and MIT.&#10;Product Management, Business Analytics, Operations Management"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" id="add-education" class="add-button">+ Add Education</button>
                            </div>

                            <!-- Skills Section -->
                            <div class="form-section">
                                <h3>💪 Skills</h3>
                                <div id="skills-container">
                                    <div class="skill-category">
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label>Category *</label>
                                                <input type="text" name="skills[0][category]" required placeholder="Technical">
                                            </div>
                                            <div class="form-group full-width">
                                                <label>Skills *</label>
                                                <textarea name="skills[0][skills]" required rows="2" placeholder="Python, R, BigQuery (SQL), Tableau, Google Analytics, Excel"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" id="add-skill-category" class="add-button">+ Add Skill Category</button>
                            </div>

                            <!-- Work Experience Section -->
                            <div class="form-section">
                                <h3>💼 Work Experience</h3>
                                <div id="experience-container">
                                    <div class="experience-item">
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label>Company *</label>
                                                <input type="text" name="experience[0][company]" required placeholder="Walmart Inc.">
                                            </div>
                                            <div class="form-group">
                                                <label>Location</label>
                                                <input type="text" name="experience[0][location]" placeholder="Bentonville, AR">
                                            </div>
                                            <div class="form-group">
                                                <label>Position *</label>
                                                <input type="text" name="experience[0][position]" required placeholder="Sr. Analyst, Trust & Safety">
                                            </div>
                                            <div class="form-group">
                                                <label>Duration</label>
                                                <input type="text" name="experience[0][duration]" placeholder="Jan 2025 - Present">
                                            </div>
                                            <div class="form-group full-width">
                                                <label>Responsibilities (one per line)</label>
                                                <textarea name="experience[0][responsibilities]" rows="4" placeholder="Performed data scraping and cleaning to ensure data integrity&#10;Applied machine learning algorithms to develop predictive models"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" id="add-experience" class="add-button">+ Add Experience</button>
                            </div>

                            <!-- Projects Section -->
                            <div class="form-section">
                                <h3>🚀 Projects</h3>
                                <div id="projects-container">
                                    <div class="project-item">
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label>Project Name *</label>
                                                <input type="text" name="projects[0][name]" required placeholder="Client Project: AI Analysis Platform">
                                            </div>
                                            <div class="form-group">
                                                <label>Organization</label>
                                                <input type="text" name="projects[0][organization]" placeholder="Harvard Kennedy School">
                                            </div>
                                            <div class="form-group full-width">
                                                <label>Description (one per line)</label>
                                                <textarea name="projects[0][description]" rows="3" placeholder="Developed AI-powered analysis platform using Python and machine learning&#10;Implemented real-time data processing capabilities"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" id="add-project" class="add-button">+ Add Project</button>
                            </div>
                        </form>
                    </div>

                    <!-- LaTeX Preview Section -->
                    <div id="latex-preview-container" style="display: none;">
                        <div class="results-header">
                            <div class="results-count">LaTeX Preview</div>
                            <button id="close-preview-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem;">
                                ✖️ Close Preview
                            </button>
                        </div>
                        <div class="latex-preview">
                            <pre id="latex-output" style="background: #f5f5f5; padding: 20px; border-radius: 8px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; white-space: pre-wrap;"></pre>
                        </div>
                    </div>

                    <!-- PDF Preview Section -->
                    <div id="pdf-preview-container" style="display: none;">
                        <div class="results-header">
                            <div class="results-count">PDF Preview</div>
                            <div class="actions">
                                <button id="download-previewed-pdf-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem; background: #48bb78;">
                                    📥 Download PDF
                                </button>
                                <button id="close-pdf-preview-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem;">
                                    ✖️ Close Preview
                                </button>
                            </div>
                        </div>
                        <div class="pdf-preview" style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; background: white;">
                            <iframe id="pdf-iframe" style="width: 100%; height: 600px; border: none;" src=""></iframe>
                        </div>
                        <div id="pdf-fallback" style="display: none; text-align: center; padding: 40px; background: #f7fafc; border-radius: 8px;">
                            <div style="font-size: 1.2rem; margin-bottom: 10px;">📄 PDF Generated Successfully!</div>
                            <div style="color: #4a5568; margin-bottom: 20px;">Your browser cannot display PDFs inline. Click the download button above to get your resume.</div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Resume Tab -->

            <!-- Saved Jobs Tab Content -->
            <div id="saved-tab" class="tab-content">
                <div class="saved-jobs-container">
                    <div class="results-header">
                        <div class="results-count" id="saved-jobs-count">Loading saved jobs...</div>
                        <button id="refresh-saved-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem;">
                            🔄 Refresh
                        </button>
                    </div>
                    <div id="saved-jobs-container">
                        <!-- Saved jobs will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Search History Tab Content -->
            <div id="history-tab" class="tab-content">
                <div class="saved-jobs-container">
                    <div class="results-header">
                        <div class="results-count" id="history-count">Loading search history...</div>
                        <button id="refresh-history-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem;">
                            🔄 Refresh
                        </button>
                    </div>
                    <div id="search-history-container">
                        <!-- Search history will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Preferences Tab Content -->
            <div id="preferences-tab" class="tab-content">
                <div class="saved-jobs-container">
                    <div class="results-header">
                        <div class="results-count">User Preferences</div>
                        <button id="save-preferences-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem;">
                            💾 Save Preferences
                        </button>
                    </div>
                    <div id="preferences-container">
                        <form id="preferences-form">
                            <div class="profile-section">
                                <h3>Default Search Settings</h3>
                                <div class="preference-group">
                                    <label>Default Job Title/Search Term:</label>
                                    <input type="text" id="pref-search-term" name="default_search_term" placeholder="e.g., Software Engineer, Data Analyst">
                                </div>
                                <div class="preference-group">
                                    <label>Default Company Filter:</label>
                                    <input type="text" id="pref-company-filter" name="default_company_filter" placeholder="e.g., Google, Microsoft, Apple">
                                </div>
                                <div class="preference-group">
                                    <label>Default Exclude Keywords:</label>
                                    <input type="text" id="pref-exclude-keywords" name="default_exclude_keywords" placeholder="e.g., senior, manager, lead">
                                </div>
                                <div class="preference-group">
                                    <label>Default Location:</label>
                                    <input type="text" id="pref-location" name="default_location" placeholder="e.g., USA">
                                </div>
                                <div class="preference-group">
                                    <label>Default Results Count:</label>
                                    <input type="number" id="pref-results" name="default_results_wanted" min="1" max="1000" placeholder="1000">
                                </div>
                                <div class="preference-group">
                                    <label>Default Job Type:</label>
                                    <select id="pref-job-type" name="default_job_type">
                                        <option value="">All Types</option>
                                        <option value="fulltime">Full Time</option>
                                        <option value="parttime">Part Time</option>
                                        <option value="internship">Internship</option>
                                        <option value="contract">Contract</option>
                                    </select>
                                </div>
                                <div class="preference-checkbox">
                                    <input type="checkbox" id="pref-remote" name="prefer_remote">
                                    <label for="pref-remote">Prefer Remote Jobs</label>
                                </div>
                                <div class="preference-group">
                                    <label>Hours Since Posted:</label>
                                    <input type="number" id="pref-hours-old" name="default_hours_old" placeholder="e.g., 168 (1 week)" min="1">
                                </div>
                                <div class="preference-group">
                                    <label>Max Salary Filter:</label>
                                    <input type="number" id="pref-max-salary" name="max_salary" placeholder="e.g., 200000" step="1000">
                                </div>
                                <div class="preference-group">
                                    <label>Expected Salary (for ranking):</label>
                                    <input type="number" id="pref-expected-salary" name="expected_salary" placeholder="e.g., 150000" step="5000">
                                </div>
                            </div>
                            
                            <div class="profile-section">
                                <h3>Notification Settings</h3>
                                <div class="preference-checkbox">
                                    <input type="checkbox" id="pref-email-alerts" name="email_alerts">
                                    <label for="pref-email-alerts">Email alerts for new job matches</label>
                                </div>
                                <div class="preference-checkbox">
                                    <input type="checkbox" id="pref-save-searches" name="save_search_history">
                                    <label for="pref-save-searches">Save search history</label>
                                </div>
                            </div>

                            <div class="profile-section">
                                <h3>Preferred Job Sites</h3>
                                <div class="preference-checkbox">
                                    <input type="checkbox" id="pref-indeed" name="preferred_sites" value="indeed" checked>
                                    <label for="pref-indeed">Indeed</label>
                                </div>
                                <div class="preference-checkbox">
                                    <input type="checkbox" id="pref-linkedin" name="preferred_sites" value="linkedin">
                                    <label for="pref-linkedin">LinkedIn</label>
                                </div>
                                <div class="preference-checkbox">
                                    <input type="checkbox" id="pref-glassdoor" name="preferred_sites" value="glassdoor">
                                    <label for="pref-glassdoor">Glassdoor</label>
                                </div>
                                <div class="preference-checkbox">
                                    <input type="checkbox" id="pref-ziprecruiter" name="preferred_sites" value="zip_recruiter">
                                    <label for="pref-ziprecruiter">ZipRecruiter</label>
                                </div>
                                <div class="preference-checkbox">
                                    <input type="checkbox" id="pref-google" name="preferred_sites" value="google">
                                    <label for="pref-google">Google Jobs</label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div> <!-- End Main Content -->

        <!-- Authentication Modal -->
        <div class="auth-modal-overlay" id="auth-modal-overlay">
            <div class="auth-modal">
                <button class="auth-modal-close" onclick="hideAuthModal()">&times;</button>
                <h2 id="auth-modal-title">Login</h2>
                <div id="auth-error" class="error" style="display: none; margin: 0 0 20px 0;"></div>
                <div id="auth-success" class="success" style="display: none; margin: 0 0 20px 0;"></div>
                
                <!-- Login Form -->
                <form id="login-form" style="display: block;">
                    <div class="auth-form-group">
                        <label for="login-email">Email Address</label>
                        <input type="email" id="login-email" name="email" required placeholder="Enter your email">
                    </div>
                    <div class="auth-form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" name="password" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="auth-submit-btn" id="login-submit-btn">Login</button>
                    <div class="auth-switch">
                        Don't have an account? <button type="button" onclick="switchAuthMode('register')">Register here</button>
                    </div>
                </form>

                <!-- Register Form -->
                <form id="register-form" style="display: none;">
                    <div class="auth-form-group">
                        <label for="register-email">Email Address</label>
                        <input type="email" id="register-email" name="email" required placeholder="Enter your email">
                    </div>
                    <div class="auth-form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" name="password" required placeholder="Create a password" minlength="6">
                    </div>
                    <div class="auth-form-group">
                        <label for="register-confirm-password">Confirm Password</label>
                        <input type="password" id="register-confirm-password" name="confirm_password" required placeholder="Confirm your password" minlength="6">
                    </div>
                    <button type="submit" class="auth-submit-btn" id="register-submit-btn">Create Account</button>
                    <div class="auth-switch">
                        Already have an account? <button type="button" onclick="switchAuthMode('login')">Login here</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Profile Modal -->
        <div class="auth-modal-overlay" id="profile-modal-overlay">
            <div class="auth-modal profile-modal">
                <button class="auth-modal-close" onclick="hideProfileModal()">&times;</button>
                <h2>User Profile</h2>
                <div id="profile-error" class="error" style="display: none; margin: 0 0 20px 0;"></div>
                <div id="profile-success" class="success" style="display: none; margin: 0 0 20px 0;"></div>
                
                <div class="profile-section">
                    <h3>Account Information</h3>
                    <div class="preference-group">
                        <label>Email:</label>
                        <span id="profile-email">user@example.com</span>
                    </div>
                    <div class="preference-group">
                        <label>Member Since:</label>
                        <span id="profile-created">January 1, 2024</span>
                    </div>
                </div>

                <div class="profile-section">
                    <h3>Account Actions</h3>
                    <button type="button" class="auth-submit-btn" onclick="showChangePasswordForm()" style="margin-bottom: 10px;">
                        Change Password
                    </button>
                </div>

                <!-- Change Password Form (initially hidden) -->
                <div id="change-password-section" class="profile-section" style="display: none;">
                    <h3>Change Password</h3>
                    <form id="change-password-form">
                        <div class="auth-form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" name="current_password" required>
                        </div>
                        <div class="auth-form-group">
                            <label for="new-password">New Password</label>
                            <input type="password" id="new-password" name="new_password" required minlength="6">
                        </div>
                        <div class="auth-form-group">
                            <label for="confirm-new-password">Confirm New Password</label>
                            <input type="password" id="confirm-new-password" name="confirm_new_password" required minlength="6">
                        </div>
                        <button type="submit" class="auth-submit-btn">Update Password</button>
                        <button type="button" class="auth-button" onclick="hideChangePasswordForm()" style="width: 100%; margin-top: 10px;">Cancel</button>
                    </form>
                </div>
            </div>
        </div>

    <script>
        // Detect if we're serving from backend or opening file directly
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE_URL = isLocalhost ? 'http://localhost:8000' : `https://${window.location.hostname}`;
        
        // Debug logging for environment detection
        console.log(`🌍 Environment: ${isLocalhost ? 'Local Development' : 'Production'}`);
        console.log(`🔗 API Base URL: ${API_BASE_URL}`);
        
        // Authentication state management
        let currentUser = null;
        let authToken = null;
        let lastSearchResults = null;

        // Authentication functions
        function getAuthHeaders() {
            if (authToken) {
                return { 'Authorization': `Bearer ${authToken}` };
            }
            return {};
        }

        function saveAuthToken(token) {
            authToken = token;
            localStorage.setItem('auth_token', token);
        }

        function loadAuthToken() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                authToken = token;
                return token;
            }
            return null;
        }

        function clearAuthToken() {
            authToken = null;
            localStorage.removeItem('auth_token');
        }

        async function checkAuthStatus() {
            const token = loadAuthToken();
            console.log('checkAuthStatus - token:', token);
            if (!token) {
                console.log('No token found, updating UI for logged out user');
                updateUIForLoggedOutUser();
                return false;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    updateUIForLoggedInUser(userData);
                    return true;
                } else {
                    clearAuthToken();
                    updateUIForLoggedOutUser();
                    return false;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                clearAuthToken();
                updateUIForLoggedOutUser();
                return false;
            }
        }

        function updateUIForLoggedInUser(userData) {
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('register-btn').style.display = 'none';
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('user-email').textContent = userData.email;
            document.getElementById('user-avatar').textContent = userData.email.charAt(0).toUpperCase();

            // Show authenticated tabs
            document.querySelectorAll('.auth-required').forEach(tab => {
                tab.style.display = 'block';
            });

            // Load user preferences and apply them to search form
            loadAndApplyUserPreferences();
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('login-btn').style.display = 'block';
            document.getElementById('register-btn').style.display = 'block';
            document.getElementById('user-info').style.display = 'none';

            // Hide authenticated tabs
            document.querySelectorAll('.auth-required').forEach(tab => {
                tab.style.display = 'none';
            });

            // Switch to search tab if user is on an auth-required tab
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id !== 'search-tab') {
                switchToTab('search');
            }
        }

        // Authentication modal functions
        function showAuthModal(mode) {
            const overlay = document.getElementById('auth-modal-overlay');
            const title = document.getElementById('auth-modal-title');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');

            if (mode === 'login') {
                title.textContent = 'Login';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                title.textContent = 'Create Account';
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }

            clearAuthMessages();
            overlay.classList.add('show');
        }

        function hideAuthModal() {
            document.getElementById('auth-modal-overlay').classList.remove('show');
            clearAuthMessages();
            resetAuthForms();
        }

        function switchAuthMode(mode) {
            showAuthModal(mode);
        }

        function clearAuthMessages() {
            document.getElementById('auth-error').style.display = 'none';
            document.getElementById('auth-success').style.display = 'none';
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('auth-success').style.display = 'none';
        }

        function showAuthSuccess(message) {
            const successDiv = document.getElementById('auth-success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('auth-error').style.display = 'none';
        }

        function resetAuthForms() {
            document.getElementById('login-form').reset();
            document.getElementById('register-form').reset();
        }

        // Profile modal functions
        function showProfileModal() {
            if (!currentUser) return;

            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-created').textContent = new Date(currentUser.created_at).toLocaleDateString();
            document.getElementById('profile-modal-overlay').classList.add('show');
            hideChangePasswordForm();
        }

        function hideProfileModal() {
            document.getElementById('profile-modal-overlay').classList.remove('show');
            document.getElementById('profile-error').style.display = 'none';
            document.getElementById('profile-success').style.display = 'none';
        }

        function showChangePasswordForm() {
            document.getElementById('change-password-section').style.display = 'block';
        }

        function hideChangePasswordForm() {
            document.getElementById('change-password-section').style.display = 'none';
            document.getElementById('change-password-form').reset();
        }

        async function logout() {
            clearAuthToken();
            currentUser = null;
            updateUIForLoggedOutUser();
            
            // Clear saved jobs and other user data
            savedJobs = [];
            updateSavedCount(0);
            
            // Show success message briefly
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = `
                <div class="success" style="text-align: center;">
                    <strong>Logged out successfully!</strong><br>
                    Thank you for using JobSpy. You can continue searching for jobs without an account.
                </div>
            `;
            
            // Clear the message after 3 seconds
            setTimeout(() => {
                resultsContainer.innerHTML = '';
            }, 3000);
        }

        // Tab management with authentication check
        function switchToTab(tabName) {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            // Check if tab requires authentication
            if (['saved', 'history', 'preferences'].includes(tabName) && !currentUser) {
                showAuthModal('login');
                return;
            }

            // Update button states
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update content visibility
            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load content based on tab
            if (tabName === 'saved') {
                loadSavedJobs();
            } else if (tabName === 'history') {
                loadSearchHistory();
            } else if (tabName === 'preferences') {
                loadUserPreferences();
            } else if (tabName === 'resume') {
                checkBackendStatus();
            }
        }

        // Authentication form handlers
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const submitBtn = document.getElementById('login-submit-btn');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';
            clearAuthMessages();

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email, password })
                });

                const result = await response.json();

                if (response.ok) {
                    saveAuthToken(result.access_token);
                    currentUser = result.user;
                    updateUIForLoggedInUser(result.user);
                    hideAuthModal();
                    showAuthSuccess('Logged in successfully!');
                } else {
                    showAuthError(result.detail || 'Login failed');
                }
            } catch (error) {
                showAuthError('Network error. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const submitBtn = document.getElementById('register-submit-btn');

            if (password !== confirmPassword) {
                showAuthError('Passwords do not match');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Account...';
            clearAuthMessages();

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: email, 
                        email, 
                        password,
                        full_name: email.split('@')[0] // Use part before @ as full name
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showAuthSuccess('Account created successfully! Please log in.');
                    setTimeout(() => switchAuthMode('login'), 2000);
                } else {
                    showAuthError(result.detail || 'Registration failed');
                }
            } catch (error) {
                showAuthError('Network error. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
            }
        });

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;

            if (newPassword !== confirmNewPassword) {
                document.getElementById('profile-error').textContent = 'New passwords do not match';
                document.getElementById('profile-error').style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('profile-success').textContent = 'Password updated successfully!';
                    document.getElementById('profile-success').style.display = 'block';
                    hideChangePasswordForm();
                } else {
                    document.getElementById('profile-error').textContent = result.detail || 'Failed to update password';
                    document.getElementById('profile-error').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('profile-error').textContent = 'Network error. Please try again.';
                document.getElementById('profile-error').style.display = 'block';
            }
        });

        // User preferences functions
        async function loadUserPreferences() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_BASE_URL}/user/preferences`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const preferences = await response.json();
                    populatePreferencesForm(preferences);
                }
            } catch (error) {
                console.error('Failed to load preferences:', error);
            }
        }

        async function loadAndApplyUserPreferences() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_BASE_URL}/user/preferences`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const preferences = await response.json();
                    applyPreferencesToSearchForm(preferences);
                }
            } catch (error) {
                console.error('Failed to load preferences:', error);
            }
        }

        function populatePreferencesForm(preferences) {
            if (preferences.default_search_term !== undefined) {
                document.getElementById('pref-search-term').value = preferences.default_search_term || '';
            }
            if (preferences.default_company_filter !== undefined) {
                document.getElementById('pref-company-filter').value = preferences.default_company_filter || '';
            }
            if (preferences.default_exclude_keywords !== undefined) {
                document.getElementById('pref-exclude-keywords').value = preferences.default_exclude_keywords || '';
            }
            if (preferences.default_location !== undefined) {
                document.getElementById('pref-location').value = preferences.default_location || '';
            }
            if (preferences.default_results_wanted) {
                document.getElementById('pref-results').value = preferences.default_results_wanted;
            }
            if (preferences.default_job_type) {
                document.getElementById('pref-job-type').value = preferences.default_job_type;
            }
            if (preferences.default_hours_old) {
                document.getElementById('pref-hours-old').value = preferences.default_hours_old;
            }
            if (preferences.max_salary) {
                document.getElementById('pref-max-salary').value = preferences.max_salary;
            }
            if (preferences.expected_salary) {
                document.getElementById('pref-expected-salary').value = preferences.expected_salary;
            }

            document.getElementById('pref-remote').checked = preferences.default_remote || false;
            document.getElementById('pref-email-alerts').checked = preferences.email_notifications || false;
            document.getElementById('pref-save-searches').checked = preferences.save_search_history || false;

            // Set preferred sites
            if (preferences.default_sites) {
                const sites = Array.isArray(preferences.default_sites) ? preferences.default_sites : [];
                document.querySelectorAll('input[name="preferred_sites"]').forEach(checkbox => {
                    checkbox.checked = sites.includes(checkbox.value);
                });
            }
        }

        function applyPreferencesToSearchForm(preferences) {
            if (preferences.default_search_term !== undefined) {
                document.getElementById('search-term').value = preferences.default_search_term || '';
            }
            if (preferences.default_company_filter !== undefined) {
                document.getElementById('company-filter').value = preferences.default_company_filter || '';
            }
            if (preferences.default_exclude_keywords !== undefined) {
                document.getElementById('exclude-keywords').value = preferences.default_exclude_keywords || '';
            }
            if (preferences.default_location !== undefined) {
                document.getElementById('location').value = preferences.default_location || '';
            }
            if (preferences.default_job_type) {
                document.getElementById('job-type').value = preferences.default_job_type;
            }
            if (preferences.default_hours_old) {
                document.getElementById('hours-old').value = preferences.default_hours_old;
            }
            if (preferences.max_salary) {
                document.getElementById('max-salary').value = preferences.max_salary;
            }
            if (preferences.expected_salary) {
                document.getElementById('expected-salary').value = preferences.expected_salary;
            }

            document.getElementById('is-remote').checked = preferences.default_remote || false;

            // Set preferred sites in search form
            if (preferences.default_sites) {
                const sites = Array.isArray(preferences.default_sites) ? preferences.default_sites : [];
                document.querySelectorAll('input[name="site_name"]').forEach(checkbox => {
                    checkbox.checked = sites.includes(checkbox.value);
                });
            }
        }

        document.getElementById('save-preferences-btn').addEventListener('click', async () => {
            if (!currentUser) return;

            const formData = new FormData(document.getElementById('preferences-form'));
            const preferences = {};

            // Handle regular form fields
            for (let [key, value] of formData.entries()) {
                if (key !== 'preferred_sites') {
                    // Fields that can be blank (empty string is a valid value)
                    const allowBlankFields = ['default_location', 'default_search_term', 'default_company_filter', 'default_exclude_keywords'];
                    
                    if (value.trim() !== '' || allowBlankFields.includes(key)) {
                        if (key === 'default_results_wanted' || key === 'max_salary' || key === 'expected_salary') {
                            preferences[key] = parseInt(value);
                        } else {
                            preferences[key] = value;
                        }
                    }
                }
            }

            // Handle checkboxes
            preferences.default_remote = document.getElementById('pref-remote').checked;
            preferences.email_notifications = document.getElementById('pref-email-alerts').checked;
            preferences.save_search_history = document.getElementById('pref-save-searches').checked;

            // Handle preferred sites
            const defaultSites = [];
            document.querySelectorAll('input[name="preferred_sites"]:checked').forEach(checkbox => {
                defaultSites.push(checkbox.value);
            });
            preferences.default_sites = defaultSites;

            try {
                const response = await fetch(`${API_BASE_URL}/user/preferences`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(preferences)
                });

                if (response.ok) {
                    // Apply preferences to search form immediately
                    applyPreferencesToSearchForm(preferences);
                    
                    // Show success message briefly
                    const btn = document.getElementById('save-preferences-btn');
                    const originalText = btn.textContent;
                    btn.textContent = '✅ Saved!';
                    btn.style.background = '#48bb78';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                } else {
                    alert('Failed to save preferences. Please try again.');
                }
            } catch (error) {
                console.error('Failed to save preferences:', error);
                alert('Network error. Please try again.');
            }
        });

        // Search history functions
        async function loadSearchHistory() {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_BASE_URL}/user/search-history`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const history = await response.json();
                    displaySearchHistory(history);
                } else {
                    document.getElementById('search-history-container').innerHTML = `
                        <div class="error">Failed to load search history</div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load search history:', error);
                document.getElementById('search-history-container').innerHTML = `
                    <div class="error">Network error loading search history</div>
                `;
            }
        }

        function displaySearchHistory(searches) {
            const container = document.getElementById('search-history-container');
            const countElement = document.getElementById('history-count');

            countElement.textContent = `${searches.length} recent searches`;

            if (searches.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📈</div>
                        <h3>No search history yet</h3>
                        <p>Your search history will appear here once you start searching for jobs.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            searches.forEach(search => {
                const searchDate = new Date(search.searched_at).toLocaleString();
                html += `
                    <div class="saved-job-card" style="border-left-color: #667eea;">
                        <div class="saved-job-meta">
                            <div>
                                <span class="saved-date">Searched on ${searchDate}</span>
                                <div style="margin-top: 5px;">
                                    <strong>Search Term:</strong> ${escapeHtml(search.search_term || 'N/A')}<br>
                                    <strong>Location:</strong> ${escapeHtml(search.location || 'N/A')}<br>
                                    <strong>Results Found:</strong> ${search.results_count || 0}
                                </div>
                            </div>
                            <div class="saved-actions">
                                <button onclick="repeatSearch('${search.id}')" class="job-link" style="background: #48bb78;">
                                    🔄 Repeat Search
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function repeatSearch(searchId) {
            try {
                const response = await fetch(`${API_BASE_URL}/user/search-history/${searchId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const searchData = await response.json();
                    
                    // Populate search form with historical data
                    if (searchData.search_term) document.getElementById('search-term').value = searchData.search_term;
                    if (searchData.location) document.getElementById('location').value = searchData.location;
                    if (searchData.company_filter) document.getElementById('company-filter').value = searchData.company_filter;
                    if (searchData.exclude_keywords) document.getElementById('exclude-keywords').value = searchData.exclude_keywords;
                    if (searchData.job_type) document.getElementById('job-type').value = searchData.job_type;
                    
                    // Switch to search tab
                    switchToTab('search');
                    
                    // Scroll to search form
                    document.getElementById('job-search-form').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Failed to load search data:', error);
                alert('Failed to load search data. Please try again.');
            }
        }

        async function saveSearchToHistory(searchData, resultsCount) {
            if (!currentUser) return;

            try {
                await fetch(`${API_BASE_URL}/user/saved-searches`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        ...searchData,
                        results_count: resultsCount
                    })
                });
            } catch (error) {
                console.error('Failed to save search to history:', error);
                // Don't show error to user as this is a background operation
            }
        }

        document.getElementById('job-search-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const searchBtn = document.getElementById('search-btn');
            const resultsContainer = document.getElementById('results-container');
            
            // Show loading state with better messaging
            searchBtn.disabled = true;
            searchBtn.textContent = '🔄 Searching...';
            
            // Check if multi-company search for better loading message
            const companyFilter = document.getElementById('company-filter').value.trim();
            const isMultiCompany = companyFilter && companyFilter.includes(',');
            const loadingMessage = isMultiCompany 
                ? `Searching multiple companies: ${companyFilter.split(',').map(c => c.trim()).join(', ')}`
                : 'Searching for jobs';
            
            resultsContainer.innerHTML = `<div class="loading">${loadingMessage}</div>`;
            
            try {
                // Load saved jobs first if user is logged in
                if (currentUser) {
                    await loadSavedJobs();
                }
                
                // Collect form data
                const formData = new FormData(e.target);
                const searchData = {};
                
                // Handle regular form fields
                for (let [key, value] of formData.entries()) {
                    if (key !== 'site_name') {
                        // Fields that should always be sent (even if empty) to allow "show all" functionality
                        const alwaysSendFields = ['search_term', 'company_filter', 'exclude_keywords'];
                        
                        if (value.trim() !== '' || alwaysSendFields.includes(key)) {
                            if (key === 'results_wanted' || key === 'distance' || key === 'hours_old' || key === 'max_salary' || key === 'expected_salary') {
                                searchData[key] = parseInt(value);
                            } else if (key === 'is_remote') {
                                searchData[key] = true;
                            } else {
                                searchData[key] = value;
                            }
                        }
                    }
                }
                
                // Handle site_name checkboxes
                const siteCheckboxes = document.querySelectorAll('input[name="site_name"]:checked');
                if (siteCheckboxes.length > 0) {
                    searchData.site_name = Array.from(siteCheckboxes).map(cb => cb.value);
                }
                
                console.log('Search data:', searchData);
                console.log('Current user:', currentUser);
                console.log('Auth token:', authToken);
                
                // Use different endpoint based on authentication status
                const endpoint = currentUser ? '/search-jobs-local' : '/search-jobs-local-public';
                const headers = { 'Content-Type': 'application/json' };
                if (currentUser) {
                    Object.assign(headers, getAuthHeaders());
                }
                
                // Set high default limit since we removed the results field
                searchData.limit = 10000;
                
                // Convert company_filter to company_names array for local search endpoints
                if (searchData.company_filter !== undefined) {
                    if (searchData.company_filter.trim()) {
                        searchData.company_names = searchData.company_filter.split(',').map(c => c.trim()).filter(c => c);
                    }
                    delete searchData.company_filter;
                }
                
                // Convert location to locations array for local search endpoints
                if (searchData.location) {
                    searchData.locations = [searchData.location];
                    delete searchData.location;
                }
                
                // Convert hours_old to days_old for backend compatibility
                if (searchData.hours_old) {
                    searchData.days_old = Math.ceil(searchData.hours_old / 24); // Convert hours to days (round up)
                    delete searchData.hours_old;
                }
                
                // Handle empty search_term or "all" keyword to get all jobs
                if (searchData.search_term !== undefined && 
                    (!searchData.search_term.trim() || searchData.search_term.toLowerCase().trim() === 'all')) {
                    delete searchData.search_term; // Remove search_term to get all jobs
                }
                
                console.log('Using endpoint:', endpoint);
                console.log('Using headers:', headers);
                
                // Make API request
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(searchData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Search failed');
                }

                // Save search to history if user is authenticated
                if (currentUser && result.success) {
                    saveSearchToHistory(searchData, result.job_count || 0);
                }
                
                displayResults(result);
                
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `
                    <div class="error">
                        <strong>Search Error:</strong> ${error.message}
                        <br><br>
                        <small>Make sure the backend server is running on ${API_BASE_URL}</small>
                    </div>
                `;
            } finally {
                // Reset button state
                searchBtn.disabled = false;
                searchBtn.textContent = '🚀 Search Jobs';
            }
        });
        
        function calculateRelevanceScore(job, searchTerm, expectedSalary = null) {
            let score = 0;
            if (!searchTerm || !searchTerm.trim()) return 0;
            
            // Debug expected salary parameter
            if (expectedSalary) {
                console.log(`[SALARY DEBUG] Expected salary passed: $${expectedSalary}`);
            }
            
            const title = (job.title || '').toLowerCase().trim();
            const description = (job.description || '').toLowerCase().trim();
            const company = (job.company || '').toLowerCase().trim();
            const search = searchTerm.toLowerCase().trim();
            
            // Split search term into words, filter out common stop words
            const stopWords = new Set(['and', 'or', 'the', 'a', 'an', 'in', 'at', 'for', 'with', 'by', 'to', 'of', 'from']);
            const searchWords = search.split(/[\s,\-]+/).filter(word => 
                word.length > 1 && !stopWords.has(word)
            );
            
            if (searchWords.length === 0) return 0;
            
            // 1. Exact title match (highest score)
            if (title === search) {
                score += 100;
            }
            
            // 2. Title contains full search phrase
            if (title.includes(search)) {
                score += 80;
            }
            
            // 3. All search words in title (high score)
            const titleWords = title.split(/[\s,\-]+/);
            const titleWordsMatched = searchWords.filter(searchWord => 
                titleWords.some(titleWord => titleWord.includes(searchWord) || searchWord.includes(titleWord))
            );
            
            if (titleWordsMatched.length === searchWords.length) {
                score += 60; // All words found
            } else if (titleWordsMatched.length > 0) {
                score += (titleWordsMatched.length / searchWords.length) * 40; // Partial match
            }
            
            // 4. Individual word matches in title (position matters)
            searchWords.forEach((searchWord, index) => {
                titleWords.forEach((titleWord, titleIndex) => {
                    if (titleWord.includes(searchWord)) {
                        // Earlier position in title = higher score
                        const positionBonus = Math.max(0, 10 - titleIndex * 2);
                        score += 15 + positionBonus;
                    } else if (searchWord.includes(titleWord) && titleWord.length > 2) {
                        score += 8; // Partial word match
                    }
                });
            });
            
            // 5. Description matches (lower weight)
            if (description) {
                searchWords.forEach(searchWord => {
                    // Count occurrences in description
                    const regex = new RegExp(searchWord, 'gi');
                    const matches = description.match(regex);
                    if (matches) {
                        score += Math.min(matches.length * 5, 20); // Cap at 20 points per word
                    }
                });
                
                // Bonus for search phrase in description
                if (description.includes(search)) {
                    score += 15;
                }
            }
            
            // 6. Company name relevance (small bonus)
            if (company) {
                searchWords.forEach(searchWord => {
                    if (company.includes(searchWord)) {
                        score += 5;
                    }
                });
            }
            
            // 7. Job type matching bonus
            const jobType = (job.job_type || '').toLowerCase();
            if (jobType && (search.includes(jobType) || jobType.includes('full') && search.includes('full'))) {
                score += 8;
            }
            
            // 8. Salary matching with rewards and penalties
            if (expectedSalary && expectedSalary > 0) {
                const minSalary = job.min_amount;
                const maxSalary = job.max_amount;
                
                console.log(`[SALARY DEBUG] Job: "${job.title}" | Expected: $${expectedSalary} | Min: $${minSalary} | Max: $${maxSalary}`);
                
                if (minSalary && maxSalary) {
                    // Calculate median salary for the job
                    const medianJobSalary = (minSalary + maxSalary) / 2;
                    
                    // Calculate percentage difference between expected and median
                    const salaryDiff = Math.abs(expectedSalary - medianJobSalary);
                    const percentageDiff = salaryDiff / expectedSalary;
                    
                    // Salary scoring with rewards and penalties
                    let salaryScore = 0;
                    if (percentageDiff <= 0.15) {
                        salaryScore = 30; // Within 15% - excellent match
                    } else if (percentageDiff <= 0.25) {
                        salaryScore = 25; // Within 25% - very good match
                    } else if (percentageDiff <= 0.40) {
                        salaryScore = 10; // Within 40% - acceptable match
                    } else if (percentageDiff <= 0.60) {
                        salaryScore = -15; // 40-60% - penalty for poor match
                    } else if (percentageDiff <= 0.80) {
                        salaryScore = -30; // 60-80% - bigger penalty
                    } else {
                        salaryScore = -50; // Above 80% - major penalty
                    }
                    
                    score += salaryScore;
                    console.log(`[SALARY DEBUG] Median: $${medianJobSalary} | Diff: ${(percentageDiff * 100).toFixed(1)}% | Score: ${salaryScore > 0 ? '+' : ''}${salaryScore}`);
                    
                } else if (minSalary || maxSalary) {
                    // Only one salary bound available - use that for comparison
                    const availableSalary = minSalary || maxSalary;
                    const salaryDiff = Math.abs(expectedSalary - availableSalary);
                    const percentageDiff = salaryDiff / expectedSalary;
                    
                    // Same scoring logic for partial data
                    let salaryScore = 0;
                    if (percentageDiff <= 0.15) {
                        salaryScore = 30; // Within 15% - excellent match
                    } else if (percentageDiff <= 0.25) {
                        salaryScore = 25; // Within 25% - very good match
                    } else if (percentageDiff <= 0.40) {
                        salaryScore = 10; // Within 40% - acceptable match
                    } else if (percentageDiff <= 0.60) {
                        salaryScore = -15; // 40-60% - penalty for poor match
                    } else if (percentageDiff <= 0.80) {
                        salaryScore = -30; // 60-80% - bigger penalty
                    } else {
                        salaryScore = -50; // Above 80% - major penalty
                    }
                    
                    score += salaryScore;
                    console.log(`[SALARY DEBUG] Available: $${availableSalary} | Diff: ${(percentageDiff * 100).toFixed(1)}% | Score: ${salaryScore > 0 ? '+' : ''}${salaryScore}`);
                    
                } else {
                    // No salary data - give small bonus as neutral reward
                    score += 10;
                    console.log(`[SALARY DEBUG] No salary data - Neutral bonus: +10`);
                }
            }
            
            // 9. Recency bonus (newer posts get higher ranking)
            if (job.date_posted) {
                try {
                    const postDate = new Date(job.date_posted);
                    const now = new Date();
                    const daysSincePosted = Math.floor((now - postDate) / (1000 * 60 * 60 * 24));
                    
                    // Recency bonus: max 15 points for posts within last week, declining over time
                    if (daysSincePosted <= 1) {
                        score += 15; // Posted within last day
                    } else if (daysSincePosted <= 3) {
                        score += 12; // Posted within last 3 days
                    } else if (daysSincePosted <= 7) {
                        score += 8;  // Posted within last week
                    } else if (daysSincePosted <= 14) {
                        score += 5;  // Posted within last 2 weeks
                    } else if (daysSincePosted <= 30) {
                        score += 2;  // Posted within last month
                    }
                    // Jobs older than 30 days get no recency bonus
                } catch (error) {
                    // Invalid date, skip recency bonus
                }
            }
            
            return Math.round(score);
        }

        function filterJobsBySalary(jobs, maxSalary) {
            if (!maxSalary || maxSalary <= 0) {
                return jobs; // No filter applied
            }
            
            return jobs.filter(job => {
                // If job has min_amount, check if it's within the max salary limit
                if (job.min_amount && job.min_amount > maxSalary) {
                    console.log(`Filtering out high-salary job: ${job.title} at ${job.company} (min: $${job.min_amount.toLocaleString()})`);
                    return false;
                }
                return true;
            });
        }

        function displayResults(result) {
            const container = document.getElementById('results-container');
            
            if (!result.success) {
                container.innerHTML = `<div class="error">${result.message}</div>`;
                return;
            }
            
            // Store the results globally for CSV download
            lastSearchResults = result;
            
            // First, remove duplicates from the search results
            let uniqueJobs = removeDuplicateJobs(result.jobs);
            let duplicatesRemoved = result.jobs.length - uniqueJobs.length;
            
            console.log(`Search Results: ${result.jobs.length} total, ${uniqueJobs.length} unique (${duplicatesRemoved} duplicates removed)`);
            console.log(`Saved jobs in memory: ${savedJobs.length}`);
            
            // Apply salary filter
            const maxSalary = parseInt(document.getElementById('max-salary').value) || 0;
            let salaryFilteredJobs = filterJobsBySalary(uniqueJobs, maxSalary);
            let salaryFilteredCount = uniqueJobs.length - salaryFilteredJobs.length;
            
            if (salaryFilteredCount > 0) {
                console.log(`Salary filter: ${salaryFilteredCount} jobs filtered out (max salary: $${maxSalary.toLocaleString()})`);
            }
            
            // Calculate relevance scores and sort by relevance
            const searchTerm = result.search_params?.search_term || '';
            // Get expected salary from the original search form data instead of backend response
            const expectedSalaryInput = document.getElementById('expected-salary').value;
            const expectedSalary = expectedSalaryInput ? parseInt(expectedSalaryInput) : null;
            
            console.log(`[DEBUG] Full search_params:`, result.search_params);
            console.log(`[DEBUG] Expected salary from form: ${expectedSalary}`);
            
            if (searchTerm && searchTerm.trim()) {
                console.log(`Calculating relevance scores for search term: "${searchTerm}"${expectedSalary ? ` and expected salary: $${expectedSalary.toLocaleString()}` : ''}`);
                
                salaryFilteredJobs.forEach(job => {
                    job.relevanceScore = calculateRelevanceScore(job, searchTerm, expectedSalary);
                });
                
                // Sort by relevance score (highest first), then by date if available
                salaryFilteredJobs.sort((a, b) => {
                    if (a.relevanceScore !== b.relevanceScore) {
                        return b.relevanceScore - a.relevanceScore;
                    }
                    // Secondary sort by date_posted if relevance scores are equal
                    if (a.date_posted && b.date_posted) {
                        return new Date(b.date_posted) - new Date(a.date_posted);
                    }
                    return 0;
                });
                
                console.log(`Top 5 most relevant jobs:`, 
                    salaryFilteredJobs.slice(0, 5).map(job => ({
                        title: job.title,
                        company: job.company,
                        score: job.relevanceScore
                    }))
                );

                // Filter out jobs with no matching score
                salaryFilteredJobs = salaryFilteredJobs.filter(job => job.relevanceScore && job.relevanceScore > 0);
            }
            
            // Filter out already saved jobs (unless this is filtered AI results)
            let jobsToDisplay = salaryFilteredJobs;
            let originalCount = result.job_count;
            let savedFilteredOutCount = 0;
            
            if (!result.search_params?.filtered) {
                jobsToDisplay = salaryFilteredJobs.filter(job => {
                    const isSaved = isJobSaved(job);
                    if (isSaved) {
                        console.log(`Filtering out saved job: ${job.title} at ${job.company}`);
                    }
                    return !isSaved;
                });
                savedFilteredOutCount = salaryFilteredJobs.length - jobsToDisplay.length;
                console.log(`Final display: ${jobsToDisplay.length} jobs (${savedFilteredOutCount} saved jobs filtered out)`);
            }
            
            if (jobsToDisplay.length === 0) {
                let message;
                if (originalCount > 0) {
                    if (salaryFilteredCount > 0 && savedFilteredOutCount === 0) {
                        message = `All ${salaryFilteredCount + duplicatesRemoved} found jobs were filtered out by your maximum salary limit ($${maxSalary.toLocaleString()}). Try increasing the salary limit or removing it entirely.`;
                    } else if (savedFilteredOutCount > 0) {
                        message = "All remaining jobs are already in your saved collection! Try different search criteria to find new opportunities.";
                    } else {
                        message = "All found jobs were filtered out. Try adjusting your search parameters.";
                    }
                } else {
                    message = "No jobs found matching your criteria. Try adjusting your search parameters.";
                }
                    
                container.innerHTML = `
                    <div class="success">
                        <strong>Search completed!</strong><br>
                        ${message}
                    </div>
                `;
                return;
            }
            
            // Show search summary
            const searchParams = result.search_params || {};
            let searchSummary = '';
            
            // Add filtering info if jobs were filtered out
            let filterInfo = '';
            if (duplicatesRemoved > 0 || salaryFilteredCount > 0 || savedFilteredOutCount > 0) {
                let notes = [];
                if (duplicatesRemoved > 0) {
                    notes.push(`${duplicatesRemoved} duplicate jobs removed`);
                }
                if (salaryFilteredCount > 0) {
                    notes.push(`${salaryFilteredCount} high-salary jobs filtered (max: $${maxSalary.toLocaleString()})`);
                }
                if (savedFilteredOutCount > 0) {
                    notes.push(`${savedFilteredOutCount} already saved jobs hidden`);
                }
                filterInfo = `<br><strong>📋 Note:</strong> ${notes.join(', ')}`;
            }
            
            if (searchParams.company_filter) {
                // Check if multiple companies were searched
                const isMultiCompany = searchParams.company_filter.includes(',') || 
                                      (searchParams.companies_searched && searchParams.companies_searched.length > 1);
                
                let companyInfo = "";
                if (isMultiCompany) {
                    const companies = searchParams.companies_searched || searchParams.company_filter.split(',').map(c => c.trim());
                    companyInfo = `<strong>at companies:</strong> ${companies.join(', ')}`;
                    
                    // Add success/failure info for multi-company searches
                    if (searchParams.successful_companies || searchParams.failed_companies) {
                        let statusInfo = "";
                        if (searchParams.successful_companies && searchParams.successful_companies.length > 0) {
                            statusInfo += `<br><span style="color: #22543d;">✅ Found jobs at: ${searchParams.successful_companies.join(', ')}</span>`;
                        }
                        if (searchParams.failed_companies && searchParams.failed_companies.length > 0) {
                            statusInfo += `<br><span style="color: #c53030;">❌ No results from: ${searchParams.failed_companies.join(', ')}</span>`;
                        }
                        companyInfo += statusInfo;
                    }
                } else {
                    companyInfo = `<strong>at</strong> "${searchParams.company_filter}"`;
                }
                
                searchSummary = `<div style="background: #e6f3ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem;">
                    <strong>🎯 Search:</strong> "${searchParams.search_term || 'Unknown'}" ${companyInfo}
                    ${filterInfo}
                </div>`;
            } else {
                searchSummary = `<div style="background: #f0f8ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem;">
                    <strong>🔍 Search:</strong> "${searchParams.search_term || 'Unknown'}" 
                    <strong>(All companies)</strong>
                    ${filterInfo}
                </div>`;
            }
            
            // Add authentication notice for non-authenticated users
            let authNotice = '';
            if (!currentUser && jobsToDisplay.length > 0) {
                authNotice = `
                    <div style="background: linear-gradient(135deg, #e6f3ff 0%, #f0f8ff 100%); border: 2px solid #667eea; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                        <div style="color: #2d3748; font-weight: 600; margin-bottom: 8px;">
                            💡 Get More from JobSpy!
                        </div>
                        <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 10px;">
                            Create a free account to save jobs, track your applications, and access your search history.
                        </div>
                        <button onclick="showAuthModal('register')" class="auth-button" style="position: static; transform: none; margin-right: 10px;">
                            Create Account
                        </button>
                        <button onclick="showAuthModal('login')" class="auth-button" style="position: static; transform: none;">
                            Login
                        </button>
                    </div>
                `;
            }

            let html = `
                <div class="results">
                    <div class="results-header">
                        <div>
                            <div class="results-count">Showing ${jobsToDisplay.length} new jobs${searchTerm ? ' (sorted by relevance)' : ''}</div>
                            <div style="font-size: 0.9rem; color: #666;">
                                Search completed at ${new Date(result.timestamp).toLocaleString()}
                                ${searchTerm ? '<br>🎯 Jobs ranked by relevance to your search term' : ''}
                            </div>
                        </div>
                        <div class="actions">
                            <button id="download-csv-btn" class="search-button" style="padding: 10px 20px; font-size: 0.9rem; background: #48bb78;" onclick="downloadJobsAsCSV()">
                                📥 Download CSV
                            </button>
                        </div>
                    </div>
                    ${currentUser ? `
                    <div class="bulk-save-section" style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e0e6ed;">
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <span style="font-weight: 600; color: #4a5568;">💾 Bulk Save Jobs:</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label for="score-threshold" style="font-size: 0.9rem; color: #666;">Save jobs with score ≥</label>
                                <input type="number" id="score-threshold" min="1" max="200" value="60" style="width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" oninput="updateJobCount()">
                                <span id="job-count-preview" style="font-size: 0.9rem; color: #666; min-width: 80px;"></span>
                                <button id="bulk-save-btn" class="search-button" style="padding: 8px 16px; font-size: 0.9rem; background: #667eea;">
                                    💾 Save by Score
                                </button>
                            </div>
                            <div style="font-size: 0.85rem; color: #666; flex: 1;">
                                💡 Enter minimum score (60+ = Good Match, 80+ = Strong Match)
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    ${authNotice}
                    ${searchSummary}
            `;
            
            jobsToDisplay.forEach((job, index) => {
                // Generate relevance indicator if score exists
                let relevanceIndicator = '';
                if (job.relevanceScore !== undefined && job.relevanceScore > 0) {
                    const score = job.relevanceScore;
                    let scoreColor, scoreText;
                    
                    if (score >= 80) {
                        scoreColor = '#22543d'; // Dark green
                        scoreText = 'Excellent Match';
                    } else if (score >= 60) {
                        scoreColor = '#2d3748'; // Dark gray
                        scoreText = 'Good Match';
                    } else if (score >= 40) {
                        scoreColor = '#744210'; // Dark yellow
                        scoreText = 'Fair Match';
                    } else {
                        scoreColor = '#742a2a'; // Dark red
                        scoreText = 'Weak Match';
                    }
                    
                    relevanceIndicator = `
                        <div style="background: ${scoreColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: inline-block;">
                            🎯 ${scoreText} (${score})
                        </div>
                    `;
                }
                
                html += `
                    <div class="job-card">
                        <div class="job-header">
                            <div>
                                <div class="job-title">${escapeHtml(job.title || 'No title')}</div>
                                <div class="job-company">${escapeHtml(job.company || 'Unknown company')}</div>
                                ${relevanceIndicator}
                            </div>
                        </div>
                        
                        <div class="job-details">
                            ${job.company ? `<div class="job-detail" style="background: #e8f5e8;"><strong>Company:</strong> ${escapeHtml(job.company)}</div>` : ''}
                            ${job.location ? `<div class="job-detail"><strong>Location:</strong> ${escapeHtml(job.location)}</div>` : ''}
                            ${job.job_type ? `<div class="job-detail"><strong>Type:</strong> ${escapeHtml(job.job_type)}</div>` : ''}
                            ${job.is_remote ? `<div class="job-detail"><strong>Remote:</strong> Yes</div>` : ''}
                            ${job.date_posted ? `<div class="job-detail"><strong>Posted:</strong> ${formatJobDate(job.date_posted)}</div>` : ''}
                            ${(job.min_amount || job.max_amount) ? `<div class="job-detail"><strong>Salary:</strong> ${formatSalary(job)}</div>` : ''}
                        </div>
                        
                        ${job.description ? `
                            <div class="job-description">
                                <strong>Description:</strong><br>
                                ${truncateDescription(job.description)}
                            </div>
                        ` : ''}
                        
                        <div class="job-links">
                            ${job.job_url_direct ? `<a href="${job.job_url_direct}" target="_blank" class="job-link">View Job</a>` : (job.job_url ? `<a href="${job.job_url}" target="_blank" class="job-link">View Job</a>` : '')}
                            ${job.company_url ? `<a href="${job.company_url}" target="_blank" class="job-link">Company Page</a>` : ''}
                            <button onclick="handleSaveJob(${index})" class="save-job-btn" id="save-btn-${index}">
                                ${currentUser ? '💾 Save Job' : '💾 Login to Save'}
                            </button>
                            ${job.description ? `<button class="job-link" onclick="openDescriptionModal(${index})" type="button">📄 View Description</button>` : ''}
                            ${currentUser ? `<button onclick="markNotInterestedFromSearch(${index})" class="job-link" style="background: #e53e3e; color: white;">🚫 Not Interested</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Add bulk save event handler if user is logged in
            if (currentUser && jobsToDisplay.length > 0) {
                const bulkSaveBtn = document.getElementById('bulk-save-btn');
                if (bulkSaveBtn) {
                    bulkSaveBtn.addEventListener('click', async () => {
                        const scoreThreshold = parseInt(document.getElementById('score-threshold').value);
                        if (scoreThreshold && scoreThreshold > 0) {
                            const jobsToSave = jobsToDisplay.filter(job => job.relevanceScore && job.relevanceScore >= scoreThreshold);
                            if (jobsToSave.length > 0) {
                                await bulkSaveJobsByScore(jobsToSave, scoreThreshold);
                            } else {
                                alert(`No jobs found with score >= ${scoreThreshold}. Try a lower threshold.`);
                            }
                        } else {
                            alert('Please enter a valid score threshold (e.g., 60, 80)');
                        }
                    });
                }
            }
            
            // Show AI filtering panel if jobs found
            if (jobsToDisplay.length > 0) {
                showAIPanel(jobsToDisplay);
                // Update save button states based on already saved jobs
                setTimeout(updateSaveButtonStates, 100);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatJobDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Handle both ISO strings and date objects
                const date = new Date(dateString);
                // Return just the date part (YYYY-MM-DD)
                return date.toISOString().split('T')[0];
            } catch (e) {
                return dateString; // Fallback to original if parsing fails
            }
        }
        
        function formatSalary(job) {
            let salary = '';
            if (job.min_amount && job.max_amount) {
                salary = `$${job.min_amount.toLocaleString()} - $${job.max_amount.toLocaleString()}`;
            } else if (job.min_amount) {
                salary = `$${job.min_amount.toLocaleString()}+`;
            } else if (job.max_amount) {
                salary = `Up to $${job.max_amount.toLocaleString()}`;
            }
            
            if (salary && job.interval) {
                salary += ` (${job.interval})`;
            }
            
            return salary || 'Not specified';
        }
        
        function truncateDescription(description) {
            if (!description) return '';
            
            // Strip HTML tags and limit length
            const text = description.replace(/<[^>]*>/g, '');
            if (text.length <= 300) return escapeHtml(text);
            
            return escapeHtml(text.substring(0, 300) + '...');
        }
        
        function removeDuplicateJobs(jobs) {
            const seenUrls = new Set();
            const seenTitleCompany = new Set();
            const unique = [];
            
            for (const job of jobs) {
                const jobUrl = job.job_url || job.job_url_direct;
                
                // If job has a URL, use URL as primary identifier
                if (jobUrl) {
                    if (!seenUrls.has(jobUrl)) {
                        seenUrls.add(jobUrl);
                        unique.push(job);
                    }
                } else {
                    // Only for jobs without URLs, fall back to title+company+location
                    const identifier = `${(job.title || '').toLowerCase().trim()}-${(job.company || '').toLowerCase().trim()}-${(job.location || '').toLowerCase().trim()}`;
                    if (!seenTitleCompany.has(identifier)) {
                        seenTitleCompany.add(identifier);
                        unique.push(job);
                    }
                }
            }
            
            return unique;
        }
        
        // Global variable to store current jobs for AI filtering
        let currentJobs = [];
        
        // Global variable to store saved jobs
        let savedJobs = [];
        
        // AI Filtering Functions
        function showAIPanel(jobs) {
            currentJobs = jobs;
            const aiPanel = document.getElementById('ai-filter-panel');
            aiPanel.classList.add('show');
            
            // Add example prompts based on job search
            updateExamplePrompts();
        }
        
        function updateExamplePrompts() {
            const analysisPrompt = document.getElementById('analysis-prompt');
            const filterCriteria = document.getElementById('filter-criteria');
            
            // Set default values if empty
            if (!analysisPrompt.value) {
                analysisPrompt.value = "Summarize how many years of experience this job requires";
            }
            if (!filterCriteria.value) {
                filterCriteria.value = "Show only jobs requiring 5+ years of experience";
            }
        }
        
        // AI Analysis Event Listener
        document.getElementById('ai-analyze-btn').addEventListener('click', async () => {
            const analysisPrompt = document.getElementById('analysis-prompt').value.trim();
            const filterCriteria = document.getElementById('filter-criteria').value.trim();
            const apiKeyInput = document.getElementById('openai-api-key');
            const apiKey = apiKeyInput.value.trim();
            const analyzeBtn = document.getElementById('ai-analyze-btn');
            const statusDiv = document.getElementById('ai-status');
            const resultsContainer = document.getElementById('ai-results-container');
            
            if (!analysisPrompt) {
                alert('Please enter an analysis request.');
                return;
            }
            
            if (!apiKey) {
                alert('Please enter your OpenAI API key.');
                apiKeyInput.focus();
                return;
            }
            
            // Validate API key format (should start with sk- for OpenAI)
            if (!apiKey.startsWith('sk-')) {
                alert('Invalid API key format. OpenAI API keys should start with "sk-"');
                apiKeyInput.focus();
                return;
            }
            
            if (currentJobs.length === 0) {
                alert('No jobs available for analysis. Please search for jobs first.');
                return;
            }
            
            // Store API key in localStorage for convenience
            localStorage.setItem('openai_api_key', apiKey);
            
            // Show loading state
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '🔄 Analyzing...';
            statusDiv.textContent = `Analyzing ${currentJobs.length} jobs with AI...`;
            resultsContainer.innerHTML = '<div class="loading">AI is analyzing your jobs</div>';
            
            try {
                const requestData = {
                    jobs: currentJobs,
                    analysis_prompt: analysisPrompt,
                    filter_criteria: filterCriteria || null
                };
                
                console.log('AI Filter Request:', requestData);
                
                // Ensure API key only contains valid ASCII characters
                const cleanApiKey = apiKey.replace(/[^\x20-\x7E]/g, '').trim();
                
                if (!cleanApiKey || cleanApiKey.length < 10) {
                    throw new Error('API key contains invalid characters or is too short. Please check your API key.');
                }
                
                const response = await fetch(`${API_BASE_URL}/ai-filter-jobs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-OpenAI-API-Key': cleanApiKey
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'AI analysis failed');
                }
                
                displayAIResults(result);
                
            } catch (error) {
                console.error('AI Analysis error:', error);
                resultsContainer.innerHTML = `
                    <div class="error">
                        <strong>AI Analysis Error:</strong> ${error.message}
                        <br><br>
                        <small>Make sure you have entered a valid OpenAI API key.</small>
                    </div>
                `;
                statusDiv.textContent = 'Analysis failed';
            } finally {
                // Reset button state
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '🧠 Analyze Jobs';
            }
        });
        
        function displayAIResults(result) {
            const container = document.getElementById('ai-results-container');
            const statusDiv = document.getElementById('ai-status');
            
            if (!result.success) {
                container.innerHTML = `<div class="error">${result.message}</div>`;
                return;
            }
            
            statusDiv.textContent = result.message;
            
            let html = `
                <div class="ai-results">
                    <h3 style="margin-top: 0; color: #2d3748;">AI Analysis Results</h3>
            `;
            
            // Show analysis results
            if (result.analyzed_jobs && result.analyzed_jobs.length > 0) {
                html += `<div style="margin-bottom: 20px;">`;
                
                result.analyzed_jobs.forEach((analysis, index) => {
                    const badgeClass = analysis.meets_criteria === true ? 'pass' : 
                                     analysis.meets_criteria === false ? 'fail' : '';
                    const badgeText = analysis.meets_criteria === true ? 'PASS' : 
                                    analysis.meets_criteria === false ? 'FAIL' : '';
                    
                    html += `
                        <div class="ai-analysis-item">
                            <div class="ai-analysis-header">
                                ${escapeHtml(analysis.job_title)} at ${escapeHtml(analysis.job_company)}
                                ${badgeText ? `<span class="ai-filter-badge ${badgeClass}">${badgeText}</span>` : ''}
                            </div>
                            <div class="ai-analysis-text">${escapeHtml(analysis.analysis_result)}</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // Show filtered results if available
            if (result.filtered_jobs && result.filtered_count !== null) {
                html += `
                    <div style="background: #e6f3ff; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #2d3748;">🎯 Filtered Results</h4>
                        <p style="margin: 0; color: #4a5568;">
                            ${result.filtered_count} out of ${result.original_count} jobs met your criteria.
                        </p>
                        ${result.filtered_count > 0 ? `
                            <button 
                                onclick="showFilteredJobs(${JSON.stringify(result.filtered_jobs).replace(/"/g, '&quot;')})" 
                                class="ai-button" 
                                style="margin-top: 10px; padding: 8px 16px; font-size: 0.9rem;"
                            >
                                📋 View Filtered Jobs
                            </button>
                        ` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showFilteredJobs(filteredJobs) {
            const fakeResult = {
                success: true,
                job_count: filteredJobs.length,
                jobs: filteredJobs,
                search_params: { filtered: true },
                timestamp: new Date().toISOString(),
                message: `Showing ${filteredJobs.length} AI-filtered jobs`
            };
            
            // Update the main results display with filtered jobs
            displayResults(fakeResult);
            
            // Scroll to top of results
            document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
        }

        // Tab Management Functions
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    switchToTab(targetTab);
                });
            });
        }

        // Saved Jobs Management Functions
        async function saveJob(jobData, notes = '') {
            // Check if user is authenticated
            if (!currentUser) {
                showAuthModal('login');
                return false;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/user/save-job`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        job_data: jobData,
                        notes: notes
                    })
                });
                
                const result = await response.json();
                console.log('Save job response:', response.status, result);
                
                // Check for success or duplicate job (which we treat as success)
                if ((response.ok && result.success) || 
                    (result.message && result.message.includes('already saved')) ||
                    (result.detail && result.detail.includes('already saved'))) {
                    console.log('Job saved successfully');
                    await loadSavedJobs();
                    updateSavedCount();
                    return true;
                } else {
                    console.error('Save job failed:', result);
                    alert(result.message || result.detail || 'Failed to save job');
                    return false;
                }
            } catch (error) {
                console.error('Error saving job:', error);
                alert('Network error: Failed to save job. Please check if backend is running.');
                return false;
            }
        }
        
        async function bulkSaveJobsByScore(jobs, scoreThreshold) {
            if (!currentUser) {
                alert('You need to be logged in to save jobs.');
                return;
            }
            
            if (!jobs || jobs.length === 0) {
                alert('No jobs to save.');
                return;
            }
            
            const bulkSaveBtn = document.getElementById('bulk-save-btn');
            const originalText = bulkSaveBtn.textContent;
            bulkSaveBtn.disabled = true;
            bulkSaveBtn.textContent = `⏳ Saving ${jobs.length} jobs...`;
            
            let successCount = 0;
            let skipCount = 0;
            let errorCount = 0;
            
            try {
                for (let i = 0; i < jobs.length; i++) {
                    const job = jobs[i];
                    bulkSaveBtn.textContent = `⏳ Saving job ${i + 1}/${jobs.length}... (Score: ${job.relevanceScore})`;
                    
                    // Check if job is already saved
                    if (isJobSaved(job)) {
                        skipCount++;
                        continue;
                    }
                    
                    const success = await saveJob(job, `Bulk saved: Score ${job.relevanceScore} (threshold: ${scoreThreshold})`);
                    if (success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                    
                    // Small delay to avoid overwhelming the server
                    if (i < jobs.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // Show results
                const messages = [];
                if (successCount > 0) messages.push(`✅ ${successCount} jobs saved`);
                if (skipCount > 0) messages.push(`⏭️ ${skipCount} already saved`);
                if (errorCount > 0) messages.push(`❌ ${errorCount} failed`);
                messages.push(`🎯 Score threshold: ${scoreThreshold}`);
                
                alert(messages.join('\n'));
                
                // Reload saved jobs to update the UI
                if (successCount > 0) {
                    await loadSavedJobs();
                    updateSaveButtonStates();
                }
                
            } catch (error) {
                console.error('Error in bulk save:', error);
                alert('An error occurred during bulk save. Please try again.');
            } finally {
                bulkSaveBtn.disabled = false;
                bulkSaveBtn.textContent = originalText;
            }
        }

        function updateJobCount() {
            const scoreThreshold = parseInt(document.getElementById('score-threshold').value);
            const jobCountPreview = document.getElementById('job-count-preview');
            
            if (!scoreThreshold || scoreThreshold <= 0 || !jobsToDisplay) {
                jobCountPreview.textContent = '';
                return;
            }
            
            const matchingJobs = jobsToDisplay.filter(job => job.relevanceScore && job.relevanceScore >= scoreThreshold);
            const count = matchingJobs.length;
            
            if (count === 0) {
                jobCountPreview.textContent = '(0 jobs)';
                jobCountPreview.style.color = '#e53e3e';
            } else if (count === 1) {
                jobCountPreview.textContent = '(1 job)';
                jobCountPreview.style.color = '#38a169';
            } else {
                jobCountPreview.textContent = `(${count} jobs)`;
                jobCountPreview.style.color = '#38a169';
            }
        }

        async function deleteSavedJob(jobId) {
            if (!currentUser) return false;

            try {
                const response = await fetch(`${API_BASE_URL}/user/saved-job/${jobId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                const result = await response.json();
                
                if (result.success) {
                    // Reload saved jobs and update save button states
                    await loadSavedJobs();
                    updateSaveButtonStates();
                    return true;
                } else {
                    alert('Failed to remove job from saved list.');
                    return false;
                }
            } catch (error) {
                console.error('Error deleting saved job:', error);
                alert('Failed to remove job. Please try again.');
                return false;
            }
        }

        // Update loadSavedJobs to use the categorized endpoint
        async function loadSavedJobs() {
            if (!currentUser) {
                savedJobs = [];
                updateSavedCount(0);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/user/saved-jobs/categorized`, {
                    headers: getAuthHeaders()
                });
                const result = await response.json();
                if (result.success) {
                    savedJobs = [...(result.saved_jobs.pending || []), ...(result.saved_jobs.save_for_later || []), ...(result.saved_jobs.applied || []), ...(result.saved_jobs.not_interested || [])];
                    displayCategorizedSavedJobs(result);
                    updateSavedCount(result.counts.all || 0);
                    updateSaveButtonStates();
                } else {
                    document.getElementById('saved-jobs-container').innerHTML = `
                        <div class="error">Failed to load saved jobs: ${result.message}</div>
                    `;
                }
            } catch (error) {
                console.error('Error loading saved jobs:', error);
                document.getElementById('saved-jobs-container').innerHTML = `
                    <div class="error">Failed to load saved jobs. Please check if the backend is running.</div>
                `;
            }
        }

        function displayCategorizedSavedJobs(result) {
            const container = document.getElementById('saved-jobs-container');
            const countElement = document.getElementById('saved-jobs-count');
            const totalCount = result.counts.all || 0;
            const savedCount = result.counts.pending || 0;
            const saveForLaterCount = result.counts.save_for_later || 0;
            const appliedCount = result.counts.applied || 0;
            const notInterestedCount = result.counts.not_interested || 0;
            countElement.textContent = `${totalCount} total jobs (${savedCount} saved, ${saveForLaterCount} save for later, ${appliedCount} applied, ${notInterestedCount} not interested)`;
            if (totalCount === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>No saved jobs yet</h3>
                        <p>Search for jobs and click the \"Save Job\" button to build your collection!</p>
                    </div>
                `;
                return;
            }
            let html = '<div class="categorized-jobs">';
            // Saved Jobs Section (Not Applied)
            html += `
                <div class="job-category">
                    <h3 style="color: #48bb78; border-bottom: 2px solid #48bb78; padding-bottom: 10px; margin-bottom: 20px;">
                        💾 Saved Jobs (${savedCount})
                    </h3>
            `;
            if (savedCount === 0) {
                html += `<div style="text-align: center; color: #666; padding: 20px; font-style: italic;">No saved jobs waiting for application</div>`;
            } else {
                (result.saved_jobs.pending || []).forEach(savedJob => {
                    html += renderSavedJobCard(savedJob, 'saved');
                });
            }
            html += `</div>`; // End saved jobs section
            // Save for Later Section
            html += `
                <div class="job-category" style="margin-top: 40px;">
                    <h3 style="color: #f6ad55; border-bottom: 2px solid #f6ad55; padding-bottom: 10px; margin-bottom: 20px;">
                        🕒 Save for Later (${saveForLaterCount})
                    </h3>
            `;
            if (saveForLaterCount === 0) {
                html += `<div style="text-align: center; color: #666; padding: 20px; font-style: italic;">No jobs saved for later</div>`;
            } else {
                result.saved_jobs.save_for_later.forEach(savedJob => {
                    html += renderSavedJobCard(savedJob, 'save_for_later');
                });
            }
            html += `</div>`; // End save for later section
            // Applied Jobs Section
            html += `
                <div class="job-category" style="margin-top: 40px;">
                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px;">
                        ✅ Applied Jobs (${appliedCount})
                    </h3>
            `;
            if (appliedCount === 0) {
                html += `<div style="text-align: center; color: #666; padding: 20px; font-style: italic;">No jobs applied to yet</div>`;
            } else {
                result.saved_jobs.applied.forEach(savedJob => {
                    html += renderSavedJobCard(savedJob, 'applied');
                });
            }
            html += `</div>`; // End applied jobs section
            // Not Interested Section
            html += `
                <div class="job-category" style="margin-top: 40px;">
                    <h3 style="color: #e53e3e; border-bottom: 2px solid #e53e3e; padding-bottom: 10px; margin-bottom: 20px;">
                        🚫 Not Interested (${notInterestedCount})
                    </h3>
            `;
            if (notInterestedCount === 0) {
                html += `<div style="text-align: center; color: #666; padding: 20px; font-style: italic;">No jobs marked as not interested</div>`;
            } else {
                result.saved_jobs.not_interested.forEach(savedJob => {
                    html += renderSavedJobCard(savedJob, 'not_interested');
                });
            }
            html += `</div>`; // End not interested section
            html += '</div>'; // End categorized jobs
            container.innerHTML = html;
        }

        function renderSavedJobCard(savedJob, category) {
            const job = savedJob.job_data;
            const savedDate = new Date(savedJob.saved_at).toLocaleDateString();
            const appliedDate = savedJob.applied_at ? new Date(savedJob.applied_at).toLocaleDateString() : null;
            const statusIndicator = category === 'applied'
                ? `<div style="background: #c6f6d5; color: #22543d; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">✅ Applied ${appliedDate ? `on ${appliedDate}` : ''}</div>`
                : category === 'save_for_later'
                ? `<div style="background: #fefcbf; color: #b7791f; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">🕒 Save for Later</div>`
                : category === 'not_interested'
                ? `<div style="background: #fed7d7; color: #e53e3e; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">🚫 Not Interested</div>`
                : `<div style="background: #fed7d7; color: #742a2a; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">⏳ Not Applied</div>`;
            let actionButton = '';
            if (category === 'applied') {
                actionButton = `<button onclick="markJobStatus('${savedJob.id}', false)" class="job-link" style="background: #e53e3e;">Mark as Not Applied</button>`;
            } else if (category === 'save_for_later') {
                actionButton = `<button onclick="markSaveForLaterStatus('${savedJob.id}', false)" class="job-link" style="background: #48bb78;">Move to Saved</button>`;
            } else if (category === 'not_interested') {
                actionButton = `<button onclick="markNotInterestedStatus('${savedJob.id}', false)" class="job-link" style="background: #48bb78;">Move to Saved</button>`;
            } else {
                actionButton = `<button onclick="markJobStatus('${savedJob.id}', true)" class="job-link" style="background: #48bb78;">Mark as Applied</button>` +
                    `<button onclick="markSaveForLaterStatus('${savedJob.id}', true)" class="job-link" style="background: #f6ad55;">Save for Later</button>` +
                    `<button onclick="markNotInterestedStatus('${savedJob.id}', true)" class="job-link" style="background: #e53e3e; color: white;">🚫 Not Interested</button>`;
            }
            return `
                <div class="saved-job-card" style="border-left-color: ${category === 'applied' ? '#667eea' : category === 'save_for_later' ? '#f6ad55' : category === 'not_interested' ? '#e53e3e' : '#48bb78'};">
                    <div class="saved-job-meta">
                        <div>
                            <span class="saved-date">Saved on ${savedDate}</span>
                            ${statusIndicator}
                        </div>
                        <div class="saved-actions">
                            ${actionButton}
                            <button onclick="deleteSavedJob('${savedJob.id}')" class="remove-job-btn">🗑️ Remove</button>
                        </div>
                    </div>
                    <div class="job-header">
                        <div>
                            <div class="job-title">${escapeHtml(job.title || 'N/A')}</div>
                            <div class="job-company">${escapeHtml(job.company || 'N/A')}</div>
                        </div>
                    </div>
                    <div class="job-details">
                        <div class="job-detail"><strong>Location:</strong> ${escapeHtml(job.location || 'Not specified')}</div>
                        <div class="job-detail"><strong>Job Type:</strong> ${escapeHtml(job.job_type || 'Not specified')}</div>
                        <div class="job-detail"><strong>Salary:</strong> ${formatSalary(job)}</div>
                    </div>
                    ${job.description ? `
                        <div class="job-description">
                            <strong>Description:</strong><br>
                            ${truncateDescription(job.description)}
                        </div>
                    ` : ''}
                    <div class="job-links">
                        ${job.job_url_direct ? `<a href="${job.job_url_direct}" target="_blank" class="job-link">Apply Now</a>` : (job.job_url ? `<a href="${job.job_url}" target="_blank" class="job-link">View Job</a>` : '')}
                        ${job.company_url ? `<a href="${job.company_url}" target="_blank" class="job-link">Company Page</a>` : ''}
                    </div>
                    ${savedJob.notes ? `
                        <div class="notes-section">
                            <strong>Notes:</strong><br>
                            ${escapeHtml(savedJob.notes)}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateSavedCount(count = null) {
            const countElement = document.getElementById('saved-count');
            countElement.textContent = count !== null ? count : savedJobs.length;
        }

        async function markJobStatus(jobId, applied) {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_BASE_URL}/user/saved-job/${jobId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        applied: applied
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Reload saved jobs and update save button states
                    await loadSavedJobs();
                    updateSaveButtonStates();
                } else {
                    alert('Failed to update job status: ' + (result.message || result.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating job status:', error);
                alert('Failed to update job status. Please try again.');
            }
        }

        async function handleSaveJob(jobIndex) {
            const job = currentJobs[jobIndex];
            const button = document.getElementById(`save-btn-${jobIndex}`);
            
            if (!job) {
                alert('Job data not found.');
                return;
            }

            // Check if user is logged in
            if (!currentUser) {
                // Show login prompt
                if (confirm('You need to be logged in to save jobs. Would you like to go to the login page?')) {
                    showAuthModal('login');
                }
                return;
            }

            // Disable button during save
            button.disabled = true;
            button.innerHTML = '⏳ Saving...';

            const success = await saveJob(job);
            
            if (success) {
                button.innerHTML = '✅ Saved';
                button.classList.add('saved');
                button.disabled = true;
                
                // Update button states for all job cards
                updateSaveButtonStates();
            } else {
                // Re-enable button on failure
                button.disabled = false;
                button.innerHTML = '💾 Save Job';
            }
        }

        function updateSaveButtonStates() {
            currentJobs.forEach((job, index) => {
                const button = document.getElementById(`save-btn-${index}`);
                if (!button) return;

                if (!currentUser) {
                    button.innerHTML = '💾 Login to Save';
                    button.classList.remove('saved');
                    button.disabled = false;
                } else if (isJobSaved(job)) {
                    button.innerHTML = '✅ Saved';
                    button.classList.add('saved');
                    button.disabled = true;
                } else {
                    button.innerHTML = '💾 Save Job';
                    button.classList.remove('saved');
                    button.disabled = false;
                }
            });
        }

        function isJobSaved(jobData) {
            return savedJobs.some(savedJob => {
                const saved = savedJob.job_data;
                const jobUrl = jobData.job_url || jobData.job_url_direct || '';
                const savedUrl = saved.job_url || saved.job_url_direct || '';
                
                // If both jobs have URLs, only match by URL (most reliable)
                if (jobUrl && savedUrl) {
                    return jobUrl === savedUrl;
                }
                
                // Only fall back to title + company matching if at least one job has no URL
                if (!jobUrl || !savedUrl) {
                    const jobTitle = (jobData.title || '').toLowerCase().trim();
                    const jobCompany = (jobData.company || '').toLowerCase().trim();
                    const savedTitle = (saved.title || '').toLowerCase().trim();
                    const savedCompany = (saved.company || '').toLowerCase().trim();
                    
                    return jobTitle && jobCompany && savedTitle && savedCompany &&
                           jobTitle === savedTitle && jobCompany === savedCompany;
                }
                
                return false;
            });
        }

        // Add markSaveForLaterStatus function
        async function markSaveForLaterStatus(jobId, saveForLater) {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_BASE_URL}/user/saved-job/${jobId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        save_for_later: saveForLater
                    })
                });
                const result = await response.json();
                if (result.success) {
                    await loadSavedJobs();
                    updateSaveButtonStates();
                } else {
                    alert('Failed to update save for later status: ' + (result.message || result.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating save for later status:', error);
                alert('Failed to update save for later status. Please try again.');
            }
        }

        // Add markNotInterestedFromSearch function
        async function markNotInterestedFromSearch(index) {
            const job = currentJobs[index];
            // Save the job if not already saved, then mark as not interested
            let savedJob = savedJobs.find(j => (j.job_data.job_url && j.job_data.job_url === job.job_url) || (j.job_data.title === job.title && j.job_data.company === job.company));
            if (!savedJob) {
                // Save the job first
                await saveJob(job);
                await loadSavedJobs();
                savedJob = savedJobs.find(j => (j.job_data.job_url && j.job_data.job_url === job.job_url) || (j.job_data.title === job.title && j.job_data.company === job.company));
            }
            if (savedJob) {
                await markNotInterestedStatus(savedJob.id, true);
                await loadSavedJobs();
                displayResults({ ...lastSearchResult }); // Remove from search results
            }
        }

        // Add markNotInterestedStatus function
        async function markNotInterestedStatus(jobId, notInterested) {
            if (!currentUser) return;

            try {
                const response = await fetch(`${API_BASE_URL}/user/saved-job/${jobId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        not_interested: notInterested
                    })
                });
                const result = await response.json();
                if (result.success) {
                    await loadSavedJobs();
                    updateSaveButtonStates();
                } else {
                    alert('Failed to update not interested status: ' + (result.message || result.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating not interested status:', error);
                alert('Failed to update not interested status. Please try again.');
            }
        }

        // Add event handlers for history and preferences refresh
        document.getElementById('refresh-history-btn').addEventListener('click', loadSearchHistory);

        // Resume Builder Functions
        function generateLatexResume() {
            const formData = new FormData(document.getElementById('resume-form'));
            const resumeData = {
                personal: {
                    fullName: formData.get('fullName') || '',
                    phone: formData.get('phone') || '',
                    email: formData.get('email') || '',
                    linkedin: formData.get('linkedin') || '',
                    workAuth: formData.get('workAuth') || ''
                },
                education: [],
                skills: [],
                experience: [],
                projects: []
            };

            // Parse education entries
            let i = 0;
            while (formData.has(`education[${i}][institution]`)) {
                const edu = {
                    institution: formData.get(`education[${i}][institution]`) || '',
                    location: formData.get(`education[${i}][location]`) || '',
                    degree: formData.get(`education[${i}][degree]`) || '',
                    duration: formData.get(`education[${i}][duration]`) || '',
                    details: formData.get(`education[${i}][details]`) || ''
                };
                if (edu.institution && edu.degree) {
                    resumeData.education.push(edu);
                }
                i++;
            }

            // Parse skills
            i = 0;
            while (formData.has(`skills[${i}][category]`)) {
                const skill = {
                    category: formData.get(`skills[${i}][category]`) || '',
                    skills: formData.get(`skills[${i}][skills]`) || ''
                };
                if (skill.category && skill.skills) {
                    resumeData.skills.push(skill);
                }
                i++;
            }

            // Parse experience
            i = 0;
            while (formData.has(`experience[${i}][company]`)) {
                const exp = {
                    company: formData.get(`experience[${i}][company]`) || '',
                    location: formData.get(`experience[${i}][location]`) || '',
                    position: formData.get(`experience[${i}][position]`) || '',
                    duration: formData.get(`experience[${i}][duration]`) || '',
                    responsibilities: formData.get(`experience[${i}][responsibilities]`) || ''
                };
                if (exp.company && exp.position) {
                    resumeData.experience.push(exp);
                }
                i++;
            }

            // Parse projects
            i = 0;
            while (formData.has(`projects[${i}][name]`)) {
                const proj = {
                    name: formData.get(`projects[${i}][name]`) || '',
                    organization: formData.get(`projects[${i}][organization]`) || '',
                    description: formData.get(`projects[${i}][description]`) || ''
                };
                if (proj.name) {
                    resumeData.projects.push(proj);
                }
                i++;
            }

            return generateLatexFromData(resumeData);
        }

        function generateLatexFromData(data) {
            let latex = `%-------------------------
% Resume in Latex
% Author : Aras Gungore
% License : MIT
%------------------------

\\documentclass[letterpaper,11pt]{article}

\\usepackage{latexsym}
\\usepackage[empty]{fullpage}
\\usepackage{titlesec}
\\usepackage{marvosym}
\\usepackage[usenames,dvipsnames]{color}
\\usepackage{verbatim}
\\usepackage{enumitem}
\\usepackage[hidelinks]{hyperref}
\\usepackage{fancyhdr}
\\usepackage[english]{babel}
\\usepackage{tabularx}
\\usepackage{hyphenat}
\\usepackage{fontawesome}
\\input{glyphtounicode}

\\pagestyle{fancy}
\\fancyhf{} % clear all header and footer fields
\\fancyfoot{}
\\renewcommand{\\headrulewidth}{0pt}
\\renewcommand{\\footrulewidth}{0pt}

% Adjust margins
\\addtolength{\\oddsidemargin}{-0.5in}
\\addtolength{\\evensidemargin}{-0.5in}
\\addtolength{\\textwidth}{1in}
\\addtolength{\\topmargin}{-.8in}
\\addtolength{\\textheight}{1.5in}

\\urlstyle{same}

\\raggedbottom
\\raggedright
\\setlength{\\tabcolsep}{0in}

% Sections formatting
\\titleformat{\\section}{
  \\vspace{-4pt}\\scshape\\raggedright\\large
}{}{0em}{}[\\color{black}\\titlerule \\vspace{-5pt}]

% Ensure that generate pdf is machine readable/ATS parsable
\\pdfgentounicode=1

%-------------------------
% Custom commands

\\newcommand{\\resumeItem}[1]{
  \\item\\small{
    {#1 \\vspace{-2pt}}
  }
}

\\newcommand{\\resumeSubheading}[4]{
  \\vspace{-2pt}\\item
    \\begin{tabular*}{0.97\\textwidth}[t]{l@{\\extracolsep{\\fill}}r}
      \\textbf{#1} & #2 \\\\
      \\textit{\\small#3} & \\textit{\\small #4} \\\\
    \\end{tabular*}\\vspace{-7pt}
}

\\newcommand{\\resumeSubSubheading}[2]{
    \\vspace{-2pt}\\item
    \\begin{tabular*}{0.97\\textwidth}{l@{\\extracolsep{\\fill}}r}
      \\textit{\\small#1} & \\textit{\\small #2} \\\\
    \\end{tabular*}\\vspace{-7pt}
}

\\newcommand{\\resumeEducationHeading}[6]{
  \\vspace{-2pt}\\item
    \\begin{tabular*}{0.97\\textwidth}[t]{l@{\\extracolsep{\\fill}}r}
      \\textbf{#1} & #2 \\\\
      \\textit{\\small#3} & \\textit{\\small #4} \\\\
      \\textit{\\small#5} & \\textit{\\small #6} \\\\
    \\end{tabular*}\\vspace{-5pt}
}

\\newcommand{\\resumeProjectHeading}[2]{
    \\vspace{-2pt}\\item
    \\begin{tabular*}{0.97\\textwidth}{l@{\\extracolsep{\\fill}}r}
      \\small#1 & #2 \\\\
    \\end{tabular*}\\vspace{-7pt}
}

\\newcommand{\\resumeOrganizationHeading}[4]{
  \\vspace{-2pt}\\item
    \\begin{tabular*}{0.97\\textwidth}[t]{l@{\\extracolsep{\\fill}}r}
      \\textbf{#1} & \\textit{\\small #2} \\\\
      \\textit{\\small#3}
    \\end{tabular*}\\vspace{-7pt}
}

\\newcommand{\\resumeSubItem}[1]{\\resumeItem{#1}\\vspace{-4pt}}

\\renewcommand\\labelitemii{$\\vcenter{\\hbox{\\tiny$\\bullet$}}$}

\\newcommand{\\resumeSubHeadingListStart}{\\begin{itemize}[leftmargin=0.15in, label={}]}
\\newcommand{\\resumeSubHeadingListEnd}{\\end{itemize}}
\\newcommand{\\resumeItemListStart}{\\begin{itemize}}
\\newcommand{\\resumeItemListEnd}{\\end{itemize}\\vspace{-5pt}}

%-------------------------------------------
%%%%%%  RESUME STARTS HERE  %%%%%%%%%%%%%%%%%%%%%%%%%%%%

\\begin{document}

%---------- HEADING ----------

\\begin{center}
    \\textbf{\\Large \\scshape ${escapeLatex(data.personal.fullName)}} \\\\ \\vspace{3pt}
    \\small
`;

            // Add contact information
            const contactParts = [];
            if (data.personal.phone) {
                contactParts.push(`\\faMobile \\hspace{.5pt} \\href{tel:${data.personal.phone}}{${escapeLatex(data.personal.phone)}}`);
            }
            if (data.personal.email) {
                contactParts.push(`\\faEnvelope \\hspace{.5pt} \\href{mailto:${data.personal.email}}{${escapeLatex(data.personal.email)}}`);
            }
            if (data.personal.linkedin) {
                const linkedInText = data.personal.linkedin.replace('https://www.linkedin.com/in/', '').replace('https://linkedin.com/in/', '').replace('/', '');
                contactParts.push(`\\faLinkedinSquare \\hspace{.5pt} \\href{${data.personal.linkedin}}{linkedin.com/in/${linkedInText}}`);
            }
            
            latex += contactParts.join('\\n    $|$\\n    ');
            
            if (data.personal.workAuth) {
                latex += `\\n    $|$\\n    \\textit{${escapeLatex(data.personal.workAuth)}}`;
            }
            
            latex += `
\\end{center}

`;

            // Education section
            if (data.education.length > 0) {
                latex += `
%----------- EDUCATION -----------

\\section{Education}
  \\vspace{3pt}
  \\resumeSubHeadingListStart
`;
                data.education.forEach(edu => {
                    if (edu.details && edu.details.includes('\\n')) {
                        // Multi-line education (use resumeEducationHeading if we have multiple lines)
                        const lines = edu.details.split('\\n').filter(line => line.trim());
                        if (lines.length > 1) {
                            latex += `
    \\resumeEducationHeading
      {${escapeLatex(edu.institution)}}{${escapeLatex(edu.location)}}
      {${escapeLatex(edu.degree)}}{${escapeLatex(edu.duration)}}
      {${escapeLatex(lines[0] || '')}}{${escapeLatex(lines[1] || '')}}`;
                        } else {
                            latex += `
    \\resumeSubheading
      {${escapeLatex(edu.institution)}}{${escapeLatex(edu.location)}}
      {${escapeLatex(edu.degree)}}{${escapeLatex(edu.duration)}}`;
                        }
                    } else {
                        latex += `
    \\resumeSubheading
      {${escapeLatex(edu.institution)}}{${escapeLatex(edu.location)}}
      {${escapeLatex(edu.degree)}}{${escapeLatex(edu.duration)}}`;
                    }
                    
                    if (edu.details) {
                        const details = edu.details.split('\\n').filter(line => line.trim());
                        if (details.length > 0) {
                            latex += `
        \\resumeItemListStart`;
                            details.forEach(detail => {
                                latex += `
            \\resumeItem{${escapeLatex(detail.trim())}}`;
                            });
                            latex += `
        \\resumeItemListEnd`;
                        }
                    }
                });
                
                latex += `
  \\resumeSubHeadingListEnd
`;
            }

            // Skills section
            if (data.skills.length > 0) {
                latex += `
%----------- SKILLS -----------

\\section{Skills}
  \\vspace{2pt}
  \\resumeSubHeadingListStart
    \\small{\\item{
`;
                data.skills.forEach((skill, index) => {
                    latex += `        \\textbf{${escapeLatex(skill.category)}:}{ ${escapeLatex(skill.skills)}} \\\\ \\vspace{3pt}\\n`;
                });
                
                latex += `    }}
  \\resumeSubHeadingListEnd
`;
            }

            // Experience section
            if (data.experience.length > 0) {
                latex += `
%----------- EXPERIENCE -----------

\\section{Work Experience}
  \\vspace{3pt}
  \\resumeSubHeadingListStart
`;
                data.experience.forEach(exp => {
                    latex += `
    \\resumeSubheading
      {${escapeLatex(exp.company)}}{${escapeLatex(exp.location)}}
      {${escapeLatex(exp.position)}}{${escapeLatex(exp.duration)}}`;
                    
                    if (exp.responsibilities) {
                        const responsibilities = exp.responsibilities.split('\\n').filter(line => line.trim());
                        if (responsibilities.length > 0) {
                            latex += `
        \\resumeItemListStart`;
                            responsibilities.forEach(resp => {
                                latex += `
            \\resumeItem{${escapeLatex(resp.trim())}}`;
                            });
                            latex += `
        \\resumeItemListEnd`;
                        }
                    }
                });
                
                latex += `
  \\resumeSubHeadingListEnd
`;
            }

            // Projects section
            if (data.projects.length > 0) {
                latex += `
%----------- PROJECTS -----------

\\section{Projects}
    \\vspace{3pt}
    \\resumeSubHeadingListStart
`;
                data.projects.forEach(proj => {
                    const projectTitle = proj.organization ? 
                        `\\textbf{${escapeLatex(proj.name)}} $|$ \\emph{${escapeLatex(proj.organization)}}` :
                        `\\textbf{${escapeLatex(proj.name)}}`;
                    
                    latex += `
      \\resumeProjectHeading
        {${projectTitle}}{}`;
                    
                    if (proj.description) {
                        const descriptions = proj.description.split('\\n').filter(line => line.trim());
                        if (descriptions.length > 0) {
                            latex += `
          \\resumeItemListStart`;
                            descriptions.forEach(desc => {
                                latex += `
            \\resumeItem{${escapeLatex(desc.trim())}}`;
                            });
                            latex += `
          \\resumeItemListEnd`;
                        }
                    }
                });
                
                latex += `
    \\resumeSubHeadingListEnd
`;
            }

            latex += `
%-------------------------------------------
\\end{document}`;

            return latex;
        }

        function escapeLatex(text) {
            if (!text) return '';
            return text
                .replace(/\\\\/g, '\\\\textbackslash{}')
                .replace(/[{}]/g, '\\\\$&')
                .replace(/[$%&_#^]/g, '\\\\$&')
                .replace(/~/g, '\\\\textasciitilde{}')
                .replace(/\\^/g, '\\\\textasciicircum{}');
        }

        // Dynamic form management
        function addEducationEntry() {
            const container = document.getElementById('education-container');
            const index = container.children.length;
            const newEntry = document.createElement('div');
            newEntry.className = 'education-item';
            newEntry.innerHTML = `
                <button type="button" class="remove-item-btn" onclick="removeEntry(this)">✖️ Remove</button>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Institution *</label>
                        <input type="text" name="education[${index}][institution]" required>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" name="education[${index}][location]">
                    </div>
                    <div class="form-group">
                        <label>Degree *</label>
                        <input type="text" name="education[${index}][degree]" required>
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <input type="text" name="education[${index}][duration]">
                    </div>
                    <div class="form-group full-width">
                        <label>Details (one per line)</label>
                        <textarea name="education[${index}][details]" rows="3"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(newEntry);
        }

        function addSkillCategory() {
            const container = document.getElementById('skills-container');
            const index = container.children.length;
            const newEntry = document.createElement('div');
            newEntry.className = 'skill-category';
            newEntry.innerHTML = `
                <button type="button" class="remove-item-btn" onclick="removeEntry(this)">✖️ Remove</button>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Category *</label>
                        <input type="text" name="skills[${index}][category]" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Skills *</label>
                        <textarea name="skills[${index}][skills]" required rows="2"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(newEntry);
        }

        function addExperienceEntry() {
            const container = document.getElementById('experience-container');
            const index = container.children.length;
            const newEntry = document.createElement('div');
            newEntry.className = 'experience-item';
            newEntry.innerHTML = `
                <button type="button" class="remove-item-btn" onclick="removeEntry(this)">✖️ Remove</button>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Company *</label>
                        <input type="text" name="experience[${index}][company]" required>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" name="experience[${index}][location]">
                    </div>
                    <div class="form-group">
                        <label>Position *</label>
                        <input type="text" name="experience[${index}][position]" required>
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <input type="text" name="experience[${index}][duration]">
                    </div>
                    <div class="form-group full-width">
                        <label>Responsibilities (one per line)</label>
                        <textarea name="experience[${index}][responsibilities]" rows="4"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(newEntry);
        }

        function addProjectEntry() {
            const container = document.getElementById('projects-container');
            const index = container.children.length;
            const newEntry = document.createElement('div');
            newEntry.className = 'project-item';
            newEntry.innerHTML = `
                <button type="button" class="remove-item-btn" onclick="removeEntry(this)">✖️ Remove</button>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Project Name *</label>
                        <input type="text" name="projects[${index}][name]" required>
                    </div>
                    <div class="form-group">
                        <label>Organization</label>
                        <input type="text" name="projects[${index}][organization]">
                    </div>
                    <div class="form-group full-width">
                        <label>Description (one per line)</label>
                        <textarea name="projects[${index}][description]" rows="3"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(newEntry);
        }

        function removeEntry(button) {
            button.parentElement.remove();
        }

        // Event listeners for resume builder
        document.getElementById('add-education').addEventListener('click', addEducationEntry);
        document.getElementById('add-skill-category').addEventListener('click', addSkillCategory);
        document.getElementById('add-experience').addEventListener('click', addExperienceEntry);
        document.getElementById('add-project').addEventListener('click', addProjectEntry);

        document.getElementById('preview-resume-btn').addEventListener('click', function() {
            const latex = generateLatexResume();
            document.getElementById('latex-output').textContent = latex;
            document.getElementById('latex-preview-container').style.display = 'block';
            document.getElementById('latex-preview-container').scrollIntoView({ behavior: 'smooth' });
        });

        document.getElementById('close-preview-btn').addEventListener('click', function() {
            document.getElementById('latex-preview-container').style.display = 'none';
        });

        document.getElementById('download-resume-btn').addEventListener('click', function() {
            const latex = generateLatexResume();
            const blob = new Blob([latex], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'resume.tex';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Global variable to store PDF blob for preview
        let currentPdfBlob = null;

        async function checkBackendStatus() {
            const statusDiv = document.getElementById('backend-status');
            if (!statusDiv) return;
            
            try {
                statusDiv.innerHTML = '🔄 Checking backend status...';
                
                // First test basic health endpoint
                const healthResponse = await fetch(`${API_BASE_URL}/health`, { 
                    method: 'GET'
                });
                
                if (!healthResponse.ok) {
                    throw new Error('Health check failed');
                }
                
                // Then test PDF endpoint connectivity
                const testResponse = await fetch(`${API_BASE_URL}/test-pdf-endpoint`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latex_code: 'test' })
                });
                
                if (testResponse.ok) {
                    statusDiv.innerHTML = '✅ Backend server is running - LaTeX PDF compilation via Overleaf API available';
                    statusDiv.style.color = '#38a169';
                } else {
                    throw new Error('PDF endpoint test failed');
                }
                
            } catch (error) {
                console.warn('Backend check failed:', error);
                statusDiv.innerHTML = '⚠️ Backend PDF endpoint unavailable - use LaTeX download + Overleaf.com';
                statusDiv.style.color = '#d69e2e';
                
                // Add debug info
                const debugBtn = document.createElement('button');
                debugBtn.innerHTML = '🔍 Debug';
                debugBtn.style.marginLeft = '10px';
                debugBtn.style.padding = '2px 8px';
                debugBtn.style.fontSize = '11px';
                debugBtn.onclick = () => debugPdfEndpoint();
                statusDiv.appendChild(debugBtn);
            }
        }

        async function debugPdfEndpoint() {
            console.log('=== PDF Endpoint Debug ===');
            
            // Test 1: Basic connectivity
            try {
                console.log('Testing basic connectivity...');
                const response = await fetch(`${API_BASE_URL}/health`);
                console.log('✅ Health check:', response.status, response.ok);
            } catch (e) {
                console.log('❌ Health check failed:', e.message);
                alert('Backend server is not running. Please start it with: cd backend && python main.py');
                return;
            }
            
            // Test 2: PDF test endpoint
            try {
                console.log('Testing PDF endpoint...');
                const response = await fetch(`${API_BASE_URL}/test-pdf-endpoint`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latex_code: 'test' })
                });
                console.log('✅ PDF test endpoint:', response.status, response.ok);
                const data = await response.json();
                console.log('Response:', data);
            } catch (e) {
                console.log('❌ PDF test endpoint failed:', e.message);
                alert('PDF endpoint is not available. This might be due to:\n1. Import errors in backend\n2. Missing dependencies (requests library)\n3. Syntax errors in the endpoint\n\nCheck the backend console for errors.');
                return;
            }
            
            // Test 3: Actual PDF endpoint
            try {
                console.log('Testing actual PDF generation endpoint...');
                const response = await fetch(`${API_BASE_URL}/generate-resume-pdf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latex_code: '\\documentclass{article}\\begin{document}Test\\end{document}' })
                });
                console.log('PDF generation endpoint:', response.status, response.ok);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.log('Error details:', errorText);
                }
            } catch (e) {
                console.log('❌ PDF generation endpoint failed:', e.message);
            }
            
            alert('Debug complete. Check browser console (F12) for detailed results.');
        }

        async function generatePdfFromBackend(latex) {
            // First, check if backend is available
            try {
                const healthCheck = await fetch(`${API_BASE_URL}/health`, { timeout: 5000 });
                if (!healthCheck.ok) {
                    throw new Error('Backend server is not responding');
                }
            } catch (e) {
                throw new Error('Cannot connect to backend server. Make sure it\'s running on http://localhost:8000');
            }

            const response = await fetch(`${API_BASE_URL}/generate-resume-pdf`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    latex_code: latex
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: 'Unknown server error' }));
                throw new Error(errorData.detail || `Server error: ${response.status}`);
            }
            
            return await response.blob();
        }

        document.getElementById('generate-pdf-btn').addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '⏳ Generating PDF...';
                
                const latex = generateLatexResume();
                const pdfBlob = await generatePdfFromBackend(latex);
                
                // Store for preview functionality
                currentPdfBlob = pdfBlob;
                
                // Create download link
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'resume.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show success
                button.innerHTML = '✅ PDF Generated!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                
                // Show a more user-friendly error dialog
                const errorMessage = `Failed to generate PDF: ${error.message}\n\n` +
                    `🛠️ Alternative options:\n\n` +
                    `1. Click "📥 Download LaTeX" and paste the code into Overleaf.com (free online LaTeX editor)\n` +
                    `2. Use a local LaTeX installation (TeXLive, MiKTeX)\n` +
                    `3. Try again in a few minutes (services may be temporarily down)\n\n` +
                    `The LaTeX code is ready - you just need to compile it!`;
                
                if (confirm(errorMessage + '\n\nWould you like to download the LaTeX file now?')) {
                    // Automatically download LaTeX file as fallback
                    const latex = generateLatexResume();
                    const blob = new Blob([latex], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'resume.tex';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                
                button.innerHTML = '❌ Try LaTeX Download';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 4000);
            } finally {
                button.disabled = false;
            }
        });

        document.getElementById('preview-pdf-btn').addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '⏳ Generating Preview...';
                
                const latex = generateLatexResume();
                const pdfBlob = await generatePdfFromBackend(latex);
                
                // Store for download functionality
                currentPdfBlob = pdfBlob;
                
                // Create object URL for preview
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Show PDF preview
                const iframe = document.getElementById('pdf-iframe');
                const fallback = document.getElementById('pdf-fallback');
                
                // Try to display PDF in iframe
                iframe.src = pdfUrl;
                iframe.onload = function() {
                    fallback.style.display = 'none';
                };
                iframe.onerror = function() {
                    fallback.style.display = 'block';
                };
                
                // Show preview container
                document.getElementById('pdf-preview-container').style.display = 'block';
                document.getElementById('pdf-preview-container').scrollIntoView({ behavior: 'smooth' });
                
                // Show success
                button.innerHTML = '✅ Preview Ready!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
                
            } catch (error) {
                console.error('Error generating PDF preview:', error);
                alert(`Failed to generate PDF preview: ${error.message}\n\nTry the "📥 Download LaTeX" option and use Overleaf.com instead.`);
                
                button.innerHTML = '❌ Preview Failed';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 3000);
            } finally {
                button.disabled = false;
            }
        });

        document.getElementById('close-pdf-preview-btn').addEventListener('click', function() {
            document.getElementById('pdf-preview-container').style.display = 'none';
            // Clean up object URL
            const iframe = document.getElementById('pdf-iframe');
            if (iframe.src) {
                URL.revokeObjectURL(iframe.src);
                iframe.src = '';
            }
        });

        document.getElementById('download-previewed-pdf-btn').addEventListener('click', function() {
            if (currentPdfBlob) {
                const url = URL.createObjectURL(currentPdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'resume.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });


        // On page load, check authentication and initialize
        window.addEventListener('load', async () => {
            // Initialize tabs
            initializeTabs();
            
            // Prefill API key from localStorage
            const apiKeyInput = document.getElementById('openai-api-key');
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                apiKeyInput.value = savedKey;
            }
            
            // Initialize refresh buttons
            document.getElementById('refresh-saved-btn').addEventListener('click', loadSavedJobs);
            
            // Check if API is available
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    console.log('✅ Backend API is available');
                    
                    // Check authentication status
                    const isAuthenticated = await checkAuthStatus();
                    
                    if (isAuthenticated) {
                        console.log('✅ User is authenticated');
                        // Load saved jobs for authenticated users
                        await loadSavedJobs();
                    } else {
                        console.log('ℹ️ User is not authenticated');
                    }
                } else {
                    throw new Error('API health check failed');
                }
            } catch (error) {
                console.warn('⚠️ Backend API not available:', error.message);
                document.getElementById('results-container').innerHTML = `
                    <div class="error">
                        <strong>Backend Not Available</strong><br>
                        The JobSpy API server is not running. Please start the backend server first:
                        <br><br>
                        <code>cd backend && python main.py</code>
                    </div>
                `;
            }
        });
    </script>
    <!-- Add modal HTML if not present -->
    <div id="description-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDescriptionModal()">&times;</button>
            <h2 id="modal-job-title"></h2>
            <h3 id="modal-job-company" style="color:#667eea;"></h3>
            <div id="modal-job-description" style="margin-top:20px;"></div>
        </div>
    </div>
    <!-- Modal CSS -->
    <style>
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            padding: 30px 30px 20px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            color: #667eea;
            cursor: pointer;
        }
        @media (max-width: 700px) {
            .modal-content { padding: 15px; }
        }
    </style>
    <!-- Modal JS -->
    <script>
        // Modal JS
        window.openDescriptionModal = function(index) {
            const job = currentJobs[index];
            document.getElementById('modal-job-title').textContent = job.title || '';
            document.getElementById('modal-job-company').textContent = job.company || '';
            document.getElementById('modal-job-description').innerHTML = job.description ? job.description : '<em>No description available.</em>';
            document.getElementById('description-modal').style.display = 'flex';
        }
        window.closeDescriptionModal = function() {
            document.getElementById('description-modal').style.display = 'none';
        }

        // CSV Download Function
        function downloadJobsAsCSV() {
            if (!lastSearchResults || !lastSearchResults.jobs || lastSearchResults.jobs.length === 0) {
                alert('No search results available to download.');
                return;
            }

            // Define CSV headers
            const headers = [
                'Title',
                'Company', 
                'Location',
                'Site',
                'Job Type',
                'Salary Min',
                'Salary Max',
                'Salary Interval',
                'Remote',
                'Date Posted',
                'Job URL',
                'Description'
            ];

            // Process the job data
            const processedJobs = lastSearchResults.jobs.map(job => {
                return {
                    'Title': job.title || '',
                    'Company': job.company || '',
                    'Location': job.location || '',
                    'Site': job.site || '',
                    'Job Type': job.job_type || '',
                    'Salary Min': job.min_amount || '',
                    'Salary Max': job.max_amount || '',
                    'Salary Interval': job.interval || '',
                    'Remote': job.is_remote ? 'Yes' : 'No',
                    'Date Posted': job.date_posted || '',
                    'Job URL': job.job_url || '',
                    'Description': (job.description || '').replace(/\n/g, ' ').replace(/\r/g, ' ').replace(/"/g, '""')
                };
            });

            // Convert to CSV format
            const csvContent = convertToCSV(processedJobs, headers);
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `jobspy-results-${timestamp}.csv`;
                link.setAttribute('download', filename);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`✅ Downloaded ${processedJobs.length} jobs to ${filename}`);
            } else {
                alert('CSV download is not supported in this browser.');
            }
        }

        // Helper function to convert data to CSV format
        function convertToCSV(data, headers) {
            if (!data || data.length === 0) return '';
            
            // Create header row
            const csvHeaders = headers.map(header => `"${header}"`).join(',');
            
            // Create data rows
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header] || '';
                    // Escape quotes and wrap in quotes
                    return `"${String(value).replace(/"/g, '""')}"`;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }

        // Make downloadJobsAsCSV globally accessible
        window.downloadJobsAsCSV = downloadJobsAsCSV;
    </script>
</body>
</html> 
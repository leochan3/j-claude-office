<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Job Review - JobSpy</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .date-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .date-selector label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .date-selector select, .date-selector button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .date-selector button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .date-selector button:hover {
            background: #2980b9;
        }
        
        .summary-card {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .job-grid {
            display: grid;
            gap: 20px;
        }
        
        .job-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .job-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .job-card.selected {
            border-color: #28a745;
            background: #f8fff8;
        }
        
        .job-card.dismissed {
            opacity: 0.6;
            background: #f8f9fa;
        }
        
        .job-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .job-title {
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: 600;
            margin: 0;
            flex-grow: 1;
        }
        
        .relevance-badge {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 15px;
        }
        
        .relevance-badge.excellent { background: #27ae60; }
        .relevance-badge.good { background: #f39c12; }
        .relevance-badge.fair { background: #e67e22; }
        
        .job-company {
            color: #7f8c8d;
            font-size: 1.1em;
            margin: 5px 0;
        }
        
        .job-location {
            color: #95a5a6;
            font-size: 0.95em;
        }
        
        .job-description {
            margin: 15px 0;
            color: #34495e;
            line-height: 1.6;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        
        .job-description.expanded {
            max-height: none;
        }
        
        .expand-btn {
            color: #3498db;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .job-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .select-btn {
            background: #27ae60;
            color: white;
        }
        
        .select-btn:hover {
            background: #229954;
        }
        
        .dismiss-btn {
            background: #e74c3c;
            color: white;
        }
        
        .dismiss-btn:hover {
            background: #c0392b;
        }
        
        .view-btn {
            background: #3498db;
            color: white;
        }
        
        .view-btn:hover {
            background: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
        }
        
        .rank-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #2c3e50;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📋 Daily Job Review</h1>
            <p>Review and select the best job opportunities from your daily curated list</p>
        </div>
        
        <div class="content">
            <!-- Date Selector -->
            <div class="date-selector">
                <label for="dateSelect">📅 Review Date:</label>
                <select id="dateSelect" onchange="loadReviewList()">
                    <option value="">Loading available dates...</option>
                </select>
                <button onclick="createNewReview()">🔄 Generate New Review</button>
                <button onclick="loadReviewDates()">📅 Refresh Dates</button>
            </div>
            
            <!-- Summary Card -->
            <div id="summaryCard" class="summary-card" style="display: none;">
                <h3>📊 Review Summary for <span id="selectedDate"></span></h3>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalJobsReviewed">0</div>
                        <div class="stat-label">Total Jobs Reviewed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="selectedJobsCount">0</div>
                        <div class="stat-label">Jobs in Review List</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="userSelectedCount">0</div>
                        <div class="stat-label">Selected by You</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="dismissedCount">0</div>
                        <div class="stat-label">Dismissed</div>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loading" class="loading">
                <p>🔄 Loading daily job review...</p>
            </div>
            
            <!-- Error State -->
            <div id="error" class="error" style="display: none;"></div>
            
            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>📭 No Review List Available</h3>
                <p>No daily job review list found for the selected date.</p>
                <button onclick="createNewReview()" class="action-btn select-btn">Generate Review List</button>
            </div>
            
            <!-- Job Grid -->
            <div id="jobGrid" class="job-grid"></div>
        </div>
    </div>

    <script>
        let currentReviewData = null;
        let selectedDate = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadReviewDates();
        });

        async function loadReviewDates() {
            try {
                const response = await fetch('/daily-review/dates');
                const dates = await response.json();
                
                const dateSelect = document.getElementById('dateSelect');
                dateSelect.innerHTML = '<option value="">Select a date...</option>';
                
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = formatDisplayDate(date);
                    dateSelect.appendChild(option);
                });
                
                // Auto-select today's date if available
                const today = new Date().toISOString().split('T')[0];
                if (dates.includes(today)) {
                    dateSelect.value = today;
                    loadReviewList();
                } else if (dates.length > 0) {
                    dateSelect.value = dates[0];
                    loadReviewList();
                }
            } catch (error) {
                showError('Failed to load available dates: ' + error.message);
            }
        }

        async function loadReviewList() {
            const dateSelect = document.getElementById('dateSelect');
            selectedDate = dateSelect.value;
            
            if (!selectedDate) {
                hideAllStates();
                return;
            }

            showLoading();
            
            try {
                const response = await fetch(`/daily-review/${selectedDate}`);
                
                if (response.status === 404) {
                    showEmptyState();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                currentReviewData = await response.json();
                displayReviewList();
            } catch (error) {
                showError('Failed to load review list: ' + error.message);
            }
        }

        async function createNewReview() {
            if (!selectedDate) {
                selectedDate = new Date().toISOString().split('T')[0];
            }
            
            showLoading();
            
            try {
                const response = await fetch('/daily-review/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target_date: selectedDate,
                        force_recreate: true
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                currentReviewData = await response.json();
                displayReviewList();
                
                // Refresh the dates dropdown
                loadReviewDates();
            } catch (error) {
                showError('Failed to create review list: ' + error.message);
            }
        }

        function displayReviewList() {
            if (!currentReviewData) return;
            
            hideAllStates();
            
            // Update summary
            document.getElementById('selectedDate').textContent = formatDisplayDate(currentReviewData.date);
            document.getElementById('totalJobsReviewed').textContent = currentReviewData.total_jobs_reviewed;
            document.getElementById('selectedJobsCount').textContent = currentReviewData.jobs.length;
            
            // Calculate user stats
            const userSelected = currentReviewData.jobs.filter(job => job.is_selected).length;
            const dismissed = currentReviewData.jobs.filter(job => job.is_dismissed).length;
            document.getElementById('userSelectedCount').textContent = userSelected;
            document.getElementById('dismissedCount').textContent = dismissed;
            
            document.getElementById('summaryCard').style.display = 'block';
            
            // Display jobs
            const jobGrid = document.getElementById('jobGrid');
            jobGrid.innerHTML = '';
            
            if (currentReviewData.jobs.length === 0) {
                showEmptyState();
                return;
            }
            
            currentReviewData.jobs.forEach(jobItem => {
                const jobCard = createJobCard(jobItem);
                jobGrid.appendChild(jobCard);
            });
        }

        function createJobCard(jobItem) {
            const job = jobItem.job;
            const card = document.createElement('div');
            
            let cardClass = 'job-card';
            if (jobItem.is_selected) cardClass += ' selected';
            if (jobItem.is_dismissed) cardClass += ' dismissed';
            
            card.className = cardClass;
            
            // Determine relevance badge
            let badgeClass = 'relevance-badge';
            let badgeText = 'Good';
            if (jobItem.relevance_score >= 80) {
                badgeClass += ' excellent';
                badgeText = 'Excellent';
            } else if (jobItem.relevance_score >= 60) {
                badgeClass += ' good';
                badgeText = 'Good';
            } else {
                badgeClass += ' fair';
                badgeText = 'Fair';
            }
            
            // Truncate description
            const description = job.description || 'No description available';
            const truncatedDesc = description.length > 300 ? description.substring(0, 300) + '...' : description;
            const needsExpansion = description.length > 300;
            
            card.innerHTML = `
                <div class="rank-badge">${jobItem.final_rank}</div>
                <div class="job-header">
                    <div>
                        <h3 class="job-title">${job.title}</h3>
                        <div class="job-company">🏢 ${job.company}</div>
                        <div class="job-location">📍 ${job.location || 'Location not specified'}</div>
                    </div>
                    <div class="${badgeClass}">
                        ${badgeText} (${jobItem.relevance_score.toFixed(1)})
                    </div>
                </div>
                
                <div class="job-description ${needsExpansion ? '' : 'expanded'}" id="desc-${jobItem.id}">
                    ${truncatedDesc}
                </div>
                ${needsExpansion ? `<div class="expand-btn" onclick="toggleDescription('${jobItem.id}')">Show More</div>` : ''}
                
                <div class="job-actions">
                    <button class="action-btn select-btn" onclick="selectJob('${jobItem.id}', true)" ${jobItem.is_selected ? 'style="opacity: 0.6;"' : ''}>
                        ✅ ${jobItem.is_selected ? 'Selected' : 'Select'}
                    </button>
                    <button class="action-btn dismiss-btn" onclick="selectJob('${jobItem.id}', false)" ${jobItem.is_dismissed ? 'style="opacity: 0.6;"' : ''}>
                        ❌ ${jobItem.is_dismissed ? 'Dismissed' : 'Dismiss'}
                    </button>
                    <button class="action-btn view-btn" onclick="viewJobDetails('${job.job_url}')">
                        👁️ View Job
                    </button>
                </div>
            `;
            
            return card;
        }

        function toggleDescription(jobItemId) {
            const descElement = document.getElementById(`desc-${jobItemId}`);
            const isExpanded = descElement.classList.contains('expanded');
            
            if (isExpanded) {
                descElement.classList.remove('expanded');
                event.target.textContent = 'Show More';
            } else {
                descElement.classList.add('expanded');
                event.target.textContent = 'Show Less';
                
                // Get full description
                const jobItem = currentReviewData.jobs.find(j => j.id === jobItemId);
                if (jobItem) {
                    descElement.textContent = jobItem.job.description || 'No description available';
                }
            }
        }

        async function selectJob(jobItemId, isSelected) {
            try {
                const response = await fetch(`/daily-review/item/${jobItemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        is_selected: isSelected ? true : null,
                        is_dismissed: isSelected ? null : true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Update the UI by reloading the list
                await loadReviewList();
            } catch (error) {
                showError('Failed to update job status: ' + error.message);
            }
        }

        function viewJobDetails(jobUrl) {
            if (jobUrl) {
                window.open(jobUrl, '_blank');
            } else {
                alert('Job URL not available');
            }
        }

        function formatDisplayDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function showLoading() {
            hideAllStates();
            document.getElementById('loading').style.display = 'block';
        }

        function showError(message) {
            hideAllStates();
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showEmptyState() {
            hideAllStates();
            document.getElementById('emptyState').style.display = 'block';
        }

        function hideAllStates() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('summaryCard').style.display = 'none';
            document.getElementById('jobGrid').innerHTML = '';
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobSpy Database Viewer</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }
        .stat-card { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center;
            border-left: 4px solid #007bff;
        }
        .stat-number { 
            font-size: 2em; 
            font-weight: bold; 
            color: #007bff; 
        }
        .stat-label { 
            color: #666; 
            margin-top: 5px;
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .loading { color: #007bff; text-align: center; padding: 20px; }
        .error { color: #dc3545; background: #f8d7da; padding: 15px; border-radius: 5px; }
        .job-card { 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        .job-title { font-weight: bold; color: #007bff; font-size: 1.1em; }
        .job-company { color: #28a745; font-weight: bold; }
        .job-location { color: #6c757d; }
        .job-meta { font-size: 0.9em; color: #666; margin-top: 10px; }
        .company-card { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px;
            border-left: 4px solid #2196f3;
        }
        .search-form { 
            display: grid; 
            grid-template-columns: 1fr 1fr auto; 
            gap: 10px; 
            margin-bottom: 20px;
            align-items: end;
        }
        input { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px;
        }
        .top-companies { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
            transition: background 0.2s;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .delete-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .job-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .company-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .bulk-delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        .bulk-delete-btn:hover {
            background: #c0392b;
        }
        .success { 
            color: #28a745; 
            background: #d4edda; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è JobSpy Database Viewer</h1>
        
        <div class="stats-grid" id="statsGrid">
            <div class="loading">üìä Loading database statistics...</div>
        </div>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <button onclick="loadStats()">üîÑ Refresh Stats</button>
            <button onclick="loadAllCompanies()">üè¢ All Companies</button>
            <button onclick="showSearchForm()">üîç Search Jobs</button>
            <button onclick="removeDuplicates()" style="background: #dc3545;">üóëÔ∏è Remove Duplicates</button>
            <button onclick="removeOldJobs()" style="background: #fd7e14;">üóìÔ∏è Remove Jobs >30 Days</button>
        </div>
    </div>

    <div class="container" id="companiesSection" style="display: none;">
        <h2>üè¢ All Companies in Database</h2>
        <div id="companiesList">
            <div class="loading">Loading companies...</div>
        </div>
    </div>

    <div class="container" id="searchSection" style="display: none;">
        <h2>üîç Search Jobs</h2>
        <div class="search-form">
            <input type="text" id="searchTerm" placeholder="Search term (e.g., software engineer)">
            <input type="text" id="companyName" placeholder="Company name (optional)">
            <button onclick="searchJobs()">Search</button>
        </div>
        <div id="searchResults"></div>
    </div>

    <script>
        // Auto-detect API base URL based on current environment
        const isProduction = window.location.hostname.includes('render.com') || 
                            window.location.hostname.includes('onrender.com');
        const API_BASE = isProduction 
            ? 'https://j-claude-backup2-1.onrender.com'
            : 'http://localhost:8000';

        async function loadStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '<div class="loading">üìä Loading database statistics...</div>';

            try {
                const response = await fetch(`${API_BASE}/database-stats-public`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const stats = data.stats;

                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_jobs.toLocaleString()}</div>
                        <div class="stat-label">Total Jobs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.jobs_last_30_days.toLocaleString()}</div>
                        <div class="stat-label">Jobs (Last 30 Days)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_companies}</div>
                        <div class="stat-label">Target Companies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.successful_runs}</div>
                        <div class="stat-label">Scraping Runs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.success_rate}%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                `;

                // Show top companies
                if (stats.top_companies && stats.top_companies.length > 0) {
                    const topCompaniesHtml = stats.top_companies.map(company => `
                        <div class="company-card">
                            <strong>${company.company}</strong>
                            <span style="float: right;">${company.job_count} jobs</span>
                        </div>
                    `).join('');

                    statsGrid.innerHTML += `
                        <div style="grid-column: 1 / -1;">
                            <h3>üèÜ Top Companies by Job Count</h3>
                            <div class="top-companies">
                                ${topCompaniesHtml}
                            </div>
                        </div>
                    `;
                }

            } catch (error) {
                statsGrid.innerHTML = `
                    <div class="error">
                        ‚ùå Error loading stats: ${error.message}
                        <br><br>
                        Make sure the server is running: <code>python backend/main.py</code>
                    </div>
                `;
            }
        }

        async function loadAllCompanies() {
            console.log('[DEBUG] loadAllCompanies called');
            const section = document.getElementById('companiesSection');
            const list = document.getElementById('companiesList');
            
            console.log('[DEBUG] API_BASE:', API_BASE);
            section.style.display = 'block';
            list.innerHTML = '<div class="loading">Loading all companies...</div>';

            try {
                console.log('[DEBUG] Fetching from:', `${API_BASE}/all-companies-public`);
                const response = await fetch(`${API_BASE}/all-companies-public`);
                
                console.log('[DEBUG] Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('[DEBUG] Response data:', data);

                if (data.companies && data.companies.length > 0) {
                    list.innerHTML = `
                        <div style="margin-bottom: 15px; padding: 10px 15px; background: #f0f8ff; border-radius: 6px; border-left: 3px solid #007bff; text-align: center;">
                            <strong>üìä Found ${data.total_count} companies with jobs in database</strong>
                        </div>
                        <div style="display: grid; gap: 8px;">
                            ${data.companies.map(company => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f9f9f9; border-radius: 6px; border-left: 3px solid #28a745;">
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                    <strong style="color: #333; font-size: 0.95rem;">${company.name}</strong>
                                    <span style="color: #666; font-size: 0.85rem;">üìä ${company.job_count} jobs</span>
                                </div>
                                <button onclick="deleteAnyCompanyJobs('${company.name}', ${company.job_count})" 
                                        style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; white-space: nowrap;">
                                    üóëÔ∏è Delete All
                                </button>
                            </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    list.innerHTML = '<div class="error">No companies with jobs found in database.</div>';
                }

            } catch (error) {
                list.innerHTML = `<div class="error">‚ùå Error loading companies: ${error.message}</div>`;
            }
        }

        function showSearchForm() {
            document.getElementById('searchSection').style.display = 'block';
        }

        async function searchJobs() {
            const searchTerm = document.getElementById('searchTerm').value;
            const companyName = document.getElementById('companyName').value;
            const resultsDiv = document.getElementById('searchResults');

            resultsDiv.innerHTML = '<div class="loading">üîç Searching jobs...</div>';

            const searchData = {
                search_term: searchTerm || undefined,
                company_names: companyName ? [companyName] : undefined,
                days_old: 30,
                limit: 20
            };

            try {
                const response = await fetch(`${API_BASE}/search-jobs-local-public`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(searchData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.jobs && data.jobs.length > 0) {
                    resultsDiv.innerHTML = `
                        <h3>üìä Found ${data.total_count} jobs (showing ${data.jobs.length})</h3>
                        ${data.jobs.map(job => `
                            <div class="job-card">
                                <div class="job-title">${job.title}</div>
                                <div class="job-company">üè¢ ${job.company}</div>
                                <div class="job-location">üìç ${job.location || 'Location not specified'}</div>
                                ${job.min_amount || job.max_amount ? `
                                    <div style="color: #28a745; font-weight: bold;">
                                        üí∞ ${job.min_amount ? '$' + job.min_amount.toLocaleString() : ''}
                                        ${job.min_amount && job.max_amount ? ' - ' : ''}
                                        ${job.max_amount ? '$' + job.max_amount.toLocaleString() : ''}
                                        ${job.salary_interval ? ' / ' + job.salary_interval : ''}
                                    </div>
                                ` : ''}
                                <div class="job-meta">
                                    üåê ${job.site} | 
                                    üìÖ Posted: ${job.date_posted ? new Date(job.date_posted).toLocaleDateString() : 'Unknown'} | 
                                    üîç Scraped: ${new Date(job.date_scraped).toLocaleDateString()}
                                    ${job.min_experience_years ? ` | üéØ ${job.min_experience_years}+ years exp` : ''}
                                    ${job.is_remote ? ' | üè† Remote' : ''}
                                </div>
                                <div class="job-actions">
                                    ${job.job_url ? `<a href="${job.job_url}" target="_blank" style="color: #007bff; text-decoration: none;">üîó View Job</a>` : ''}
                                    <button class="delete-btn" onclick="deleteJob('${job.id}', '${job.title.replace(/'/g, "\\'")}', '${job.company.replace(/'/g, "\\'")}')">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    resultsDiv.innerHTML = '<div class="error">No jobs found. Try different search terms or scrape more companies.</div>';
                }

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Search error: ${error.message}</div>`;
            }
        }

        // Delete individual job
        async function deleteJob(jobId, jobTitle, companyName) {
            if (!confirm(`Are you sure you want to delete the job "${jobTitle}" at ${companyName}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/jobs-public/${jobId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.innerHTML = `‚úÖ Successfully deleted job "${jobTitle}"`;
                
                const searchResults = document.getElementById('searchResults');
                searchResults.insertBefore(successDiv, searchResults.firstChild);
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 3000);

                // Refresh search results
                searchJobs();

            } catch (error) {
                alert(`Error deleting job: ${error.message}`);
            }
        }

        // Delete all jobs for any company (new function)
        async function deleteAnyCompanyJobs(companyName, jobCount) {
            if (!confirm(`Are you sure you want to delete ALL ${jobCount} jobs for "${companyName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/company-jobs-public/${encodeURIComponent(companyName)}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.innerHTML = `‚úÖ Successfully deleted ${result.deleted_count} jobs for "${companyName}"`;
                
                const companiesList = document.getElementById('companiesList');
                companiesList.insertBefore(successDiv, companiesList.firstChild);
                
                // Remove success message after 5 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 5000);

                // Refresh companies list and stats
                loadAllCompanies();
                loadStats();

            } catch (error) {
                alert(`Error deleting company jobs: ${error.message}`);
            }
        }

        // Delete all jobs for a company (legacy function for target companies)
        async function deleteCompanyJobs(companyName, jobCount) {
            if (!confirm(`Are you sure you want to delete ALL ${jobCount} jobs for ${companyName}? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/companies-public/${encodeURIComponent(companyName)}/jobs`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.innerHTML = `‚úÖ Successfully deleted ${result.deleted_count} jobs for ${companyName}`;
                
                const companiesList = document.getElementById('companiesList');
                companiesList.insertBefore(successDiv, companiesList.firstChild);
                
                // Remove success message after 5 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 5000);

                // Refresh companies list and stats
                loadAllCompanies();
                loadStats();

            } catch (error) {
                alert(`Error deleting company jobs: ${error.message}`);
            }
        }

        async function removeDuplicates() {
            if (!confirm('‚ö†Ô∏è This will remove duplicate jobs based on job URL, keeping only the most recent version of each job. This action cannot be undone. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/remove-duplicates-public`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Success!\n\n${data.message}\n\nDuplicates removed: ${data.duplicates_removed}\nUnique URLs processed: ${data.unique_urls_processed}`);
                    // Refresh stats to show updated counts
                    loadStats();
                    // If companies are visible, refresh them too
                    if (document.getElementById('companiesSection').style.display !== 'none') {
                        loadAllCompanies();
                    }
                } else {
                    alert(`‚ùå Error: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Error removing duplicates: ${error.message}`);
            }
        }

        async function removeOldJobs() {
            if (!confirm('‚ö†Ô∏è This will permanently remove all jobs older than 30 days (based on posted date). This will make your dashboard counts match search results. This action cannot be undone. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/remove-old-jobs-public`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Success!\n\n${data.message}\n\nJobs removed: ${data.jobs_removed}\n\nYour dashboard counts should now match search results!`);
                    // Refresh stats to show updated counts
                    loadStats();
                    // If companies are visible, refresh them too
                    if (document.getElementById('companiesSection').style.display !== 'none') {
                        loadAllCompanies();
                    }
                } else {
                    alert(`‚ùå Error: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Error removing old jobs: ${error.message}`);
            }
        }

        // Load stats on page load
        loadStats();
    </script>
</body>
</html>
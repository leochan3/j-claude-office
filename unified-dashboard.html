<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Discovery Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #0f0f23;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #1a1b3a;
            border-right: 1px solid #2d3561;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header {
            padding: 24px 20px 20px;
            border-bottom: 1px solid #2d3561;
            background: linear-gradient(135deg, #1e1e3f 0%, #1a1b3a 100%);
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-subtitle {
            font-size: 14px;
            color: #a0aec0;
        }

        .nav-section {
            padding: 20px 0;
        }

        .nav-title {
            font-size: 11px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 20px;
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
            color: #cbd5e0;
            border-radius: 0 25px 25px 0;
            margin-right: 12px;
        }

        .nav-item:hover {
            background-color: #2d3561;
            color: #ffffff;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-item-icon {
            margin-right: 12px;
            font-size: 16px;
            min-width: 20px;
        }

        .nav-item-count {
            margin-left: auto;
            background: #4a5568;
            color: #ffffff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .nav-item.active .nav-item-count {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: #1a1b3a;
            border-bottom: 1px solid #2d3561;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
        }

        .search-filters {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            padding: 8px 12px 8px 36px;
            border: 1px solid #4a5568;
            border-radius: 6px;
            font-size: 14px;
            width: 300px;
            transition: all 0.2s ease;
            background: #2d3561;
            color: #ffffff;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #4a5568;
            border-radius: 6px;
            background: #2d3561;
            color: #cbd5e0;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            border-color: #667eea;
            background: #4a5568;
            color: #ffffff;
        }

        .view-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .view-btn {
            padding: 6px 12px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background: #2d3561;
            color: #cbd5e0;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-btn.active {
            background: #667eea;
            color: #ffffff;
            border-color: #667eea;
        }

        /* Job List */
        .job-list-container {
            flex: 1;
            overflow: auto;
            background: #1a1b3a;
            min-height: 400px;
        }

        .job-list-header {
            display: grid;
            grid-template-columns: 40px 2fr 1.5fr 200px 150px 120px 160px;
            gap: 16px;
            padding: 12px 24px;
            background: #2d3561;
            border-bottom: 1px solid #4a5568;
            font-size: 12px;
            font-weight: 600;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .job-row {
            display: grid;
            grid-template-columns: 40px 2fr 1.5fr 200px 150px 120px 160px;
            gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid #2d3561;
            transition: all 0.2s ease;
            cursor: pointer;
            align-items: center;
        }

        .job-row:hover {
            background-color: #2d3561;
            cursor: pointer;
        }

        .job-row.selected {
            background-color: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
        }

        .job-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #4a5568;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .job-checkbox.checked {
            background: #667eea;
            border-color: #667eea;
            position: relative;
        }

        .job-checkbox.checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-size: 10px;
            top: -1px;
            left: 2px;
        }

        .job-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .job-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            line-height: 1.3;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .saved-indicator, .applied-indicator, .not-interested-indicator {
            font-size: 10px;
            font-weight: 500;
            color: #ffffff;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .saved-indicator {
            background: #48bb78;
        }

        .saved-indicator:hover {
            background: #38a169;
            transform: scale(1.05);
        }

        .applied-indicator {
            background: #667eea;
        }

        .applied-indicator:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }

        .not-interested-indicator {
            background: #e53e3e;
        }

        .not-interested-indicator:hover {
            background: #c53030;
            transform: scale(1.05);
        }

        .action-indicator {
            background: #4a5568;
            color: #ffffff;
            font-size: 12px;
            letter-spacing: 1px;
        }

        .action-indicator:hover {
            background: #2d3748;
            transform: scale(1.05);
        }


        .job-company {
            font-size: 13px;
            color: #a0aec0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .company-logo {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            background: #4a5568;
        }

        .job-location {
            font-size: 13px;
            color: #a0aec0;
        }

        .job-salary {
            font-size: 13px;
            color: #68d391;
            font-weight: 500;
        }

        .job-salary.no-salary {
            color: #a0aec0;
            font-style: italic;
        }

        .filter-header {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .column-filter {
            background: #1a1b3a;
            border: 1px solid #4a5568;
            border-radius: 4px;
            color: #ffffff;
            font-size: 11px;
            padding: 4px 6px;
            cursor: pointer;
            outline: none;
        }

        .column-filter:hover {
            border-color: #667eea;
        }

        .column-filter:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .job-company {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #a0aec0;
        }

        .job-score {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .score-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .score-high {
            background: #22543d;
            color: #68d391;
        }

        .score-medium {
            background: #744210;
            color: #fbb040;
        }

        .score-low {
            background: #742a2a;
            color: #fc8181;
        }

        .job-date {
            font-size: 12px;
            color: #a0aec0;
        }

        .job-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn {
            padding: 4px 8px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background: #2d3561;
            color: #cbd5e0;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 60px;
            white-space: nowrap;
        }

        .action-btn:hover {
            border-color: #667eea;
            background: #4a5568;
            color: #ffffff;
        }

        .action-btn.primary {
            background: #667eea;
            color: #ffffff;
            border-color: #667eea;
        }

        .action-btn.primary:hover {
            background: #5a67d8;
        }

        .apply-btn {
            background: #48bb78 !important;
            border-color: #48bb78 !important;
            color: #ffffff !important;
        }

        .apply-btn:hover {
            background: #38a169 !important;
            border-color: #38a169 !important;
        }

        /* Status badges */
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef5e7;
            color: #d69e2e;
        }

        .status-applied {
            background: #f0fff4;
            color: #38a169;
        }

        .status-saved {
            background: #ebf8ff;
            color: #3182ce;
        }

        .status-not-interested {
            background: #fed7d7;
            color: #e53e3e;
        }

        /* Bottom bar */
        .bottom-bar {
            padding: 16px 24px;
            background: #1a1b3a;
            border-top: 1px solid #2d3561;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .selection-info {
            font-size: 14px;
            color: #a0aec0;
        }

        .bulk-actions {
            display: flex;
            gap: 8px;
        }

        .bulk-btn {
            padding: 8px 16px;
            border: 1px solid #4a5568;
            border-radius: 6px;
            background: #2d3561;
            color: #cbd5e0;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bulk-btn:hover {
            border-color: #667eea;
            background: #4a5568;
            color: #ffffff;
        }

        .bulk-btn.primary {
            background: #667eea;
            color: #ffffff;
            border-color: #667eea;
        }

        /* Loading and empty states */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #a0aec0;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #a0aec0;
            text-align: center;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #cbd5e0;
        }

        .empty-subtitle {
            font-size: 14px;
            max-width: 400px;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }

            .search-input {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                z-index: 1000;
                height: 100vh;
            }

            .sidebar.open {
                left: 0;
            }

            .job-list-header,
            .job-row {
                grid-template-columns: 40px 1fr 1fr 120px;
            }

            .job-list-header .location-col,
            .job-list-header .salary-col,
            .job-list-header .filter-header:nth-child(4),
            .job-list-header .filter-header:nth-child(5),
            .job-list-header .filter-header:nth-child(6),
            .job-row .job-location,
            .job-row .job-salary,
            .job-row .job-date {
                display: none;
            }
        }

        /* Menu toggle for mobile */
        .menu-toggle {
            display: none;
            padding: 8px;
            border: none;
            background: none;
            cursor: pointer;
            margin-right: 12px;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .sidebar-overlay.active {
                display: block;
            }
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .job-row {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Sophisticated enhancements */
        .nav-item {
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        /* Enhanced job row with subtle animations */
        .job-row {
            position: relative;
            overflow: hidden;
        }

        .job-row::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.05), transparent);
            transition: left 0.6s ease;
        }

        .job-row:hover::before {
            left: 100%;
        }

        /* Improved search input with icon animation */
        .search-box:focus-within .search-icon {
            color: #667eea;
            transform: translateY(-50%) scale(1.1);
        }

        /* Status indicator pulse animation */
        .nav-item.active .nav-item-icon {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Smooth transitions for all interactive elements */
        * {
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        /* Enhanced scrollbar for webkit browsers */
        .job-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .job-list-container::-webkit-scrollbar-track {
            background: #1a1b3a;
        }

        .job-list-container::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }

        .job-list-container::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }


    </style>
</head>
<body>
    <!-- Job Description Modal -->
    <div id="jobModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: #1a1b3a; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); max-width: 800px; width: 90%; max-height: 90%; overflow: hidden; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div style="padding: 24px; border-bottom: 1px solid #2d3561; display: flex; justify-content: space-between; align-items: center;">
                <h2 id="jobModalTitle" style="color: #ffffff; font-size: 20px; font-weight: 600; margin: 0;"></h2>
                <button onclick="closeJobModal()" style="background: none; border: none; color: #a0aec0; font-size: 24px; cursor: pointer; padding: 4px;">&times;</button>
            </div>

            <!-- Modal Content -->
            <div style="flex: 1; overflow-y: auto; padding: 24px;">
                <!-- Job Details -->
                <div id="jobModalContent" style="color: #e2e8f0;">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Modal Footer -->
            <div style="padding: 20px 24px; border-top: 1px solid #2d3561; display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeJobModal()" style="padding: 8px 16px; border: 1px solid #4a5568; border-radius: 6px; background: #2d3561; color: #cbd5e0; cursor: pointer;">Close</button>
                <button id="jobModalSaveBtn" onclick="saveJobFromModal()" style="padding: 8px 16px; border: none; border-radius: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; cursor: pointer; font-weight: 500;">Save Job</button>
                <a id="jobModalApplyBtn" href="#" target="_blank" style="padding: 8px 16px; border: none; border-radius: 6px; background: #48bb78; color: #ffffff; text-decoration: none; font-weight: 500; display: inline-block;">Apply Now</a>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: #1a1b3a; padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); max-width: 400px; width: 90%;">
            <h2 style="color: #ffffff; text-align: center; margin-bottom: 8px; font-size: 24px;">Welcome Back</h2>
            <p style="color: #a0aec0; text-align: center; margin-bottom: 32px; font-size: 14px;">Sign in to access your job dashboard</p>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #cbd5e0; font-weight: 500;">Username</label>
                <input type="text" id="loginUsername" placeholder="Enter your username" style="width: 100%; padding: 12px; border: 1px solid #4a5568; border-radius: 6px; background: #2d3561; color: #ffffff; font-size: 14px;">
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; color: #cbd5e0; font-weight: 500;">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" style="width: 100%; padding: 12px; border: 1px solid #4a5568; border-radius: 6px; background: #2d3561; color: #ffffff; font-size: 14px;">
            </div>

            <button id="loginSubmitBtn" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 16px;">
                Sign In
            </button>

            <div id="loginError" style="display: none; color: #fc8181; text-align: center; font-size: 14px; margin-top: 16px;"></div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">Job Discovery</div>
                <div class="logo-subtitle">Find your next opportunity</div>
                <div class="user-info" id="userInfo" style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; display: none;">
                    <div class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; float: left; margin-right: 12px;"></div>
                    <div class="user-details">
                        <div class="user-name" style="font-size: 14px; font-weight: 600; color: #ffffff;"></div>
                        <div class="user-email" style="font-size: 12px; color: #a0aec0;"></div>
                    </div>
                </div>
            </div>

            <nav class="nav-section">
                <div class="nav-title">Job Lists</div>
                <button class="nav-item active" data-view="filtered">
                    <span class="nav-item-icon">üéØ</span>
                    <span>Filtered Jobs</span>
                    <span class="nav-item-count" id="filteredCount">0</span>
                </button>
                <button class="nav-item" data-view="saved">
                    <span class="nav-item-icon">üíæ</span>
                    <span>Saved Jobs</span>
                    <span class="nav-item-count" id="savedCount">0</span>
                </button>
            </nav>

            <nav class="nav-section">
                <div class="nav-title">Manage</div>
                <button class="nav-item" data-view="autoscraping">
                    <span class="nav-item-icon">ü§ñ</span>
                    <span>Auto-Scraping</span>
                </button>
                <button class="nav-item" data-view="settings">
                    <span class="nav-item-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </button>
            </nav>

            <nav class="nav-section">
                <div class="nav-title">Account</div>
                <button class="nav-item" id="logoutBtn">
                    <span class="nav-item-icon">üö™</span>
                    <span>Logout</span>
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div style="display: flex; align-items: center;">
                    <button class="menu-toggle" id="menuToggle">
                        <span style="font-size: 18px;">‚ò∞</span>
                    </button>
                    <div class="page-title" id="pageTitle">Filtered Jobs</div>
                </div>

                <div class="search-filters">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" placeholder="Search jobs..." id="searchInput">
                    </div>
                    <button class="filter-btn" id="filterBtn">
                        <span>‚öôÔ∏è</span>
                        <span>Filters</span>
                    </button>
                </div>

                <div class="view-controls">
                    <button class="view-btn active">List</button>
                    <button class="view-btn">Card</button>
                </div>
            </div>

            <!-- Job List Container -->
            <div class="job-list-container" id="jobListContainer">
                <!-- Job List Header -->
                <div style="margin-bottom: 10px;">
                    <button onclick="clearAllFilters()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Clear All Filters</button>
                </div>
                <div class="job-list-header">
                    <div></div>
                    <div class="filter-header">
                        Job Title
                        <select class="column-filter" id="jobFilter" onchange="applyFilters()">
                            <option value="">All Jobs</option>
                            <option value="new">New</option>
                            <option value="saved">Saved</option>
                            <option value="applied">Applied</option>
                            <option value="not_interested">Not Interested</option>
                        </select>
                    </div>
                    <div class="filter-header">
                        Company
                        <select class="column-filter" id="companyFilter" onchange="applyFilters()">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                    <div class="filter-header location-col">
                        Location
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <select class="column-filter" id="locationTypeFilter" onchange="handleLocationTypeChange()">
                                <option value="all">All Locations</option>
                                <option value="exact">Exact Location</option>
                                <option value="state">By State</option>
                                <option value="distance">By Distance</option>
                            </select>
                            <select class="column-filter" id="locationFilter" onchange="applyFilters()" style="display: none;">
                                <option value="">All Locations</option>
                            </select>
                            <select class="column-filter" id="stateFilter" onchange="applyFilters()" style="display: none;">
                                <option value="">All States</option>
                            </select>
                            <div id="distanceFilter" style="display: none;">
                                <input type="text" id="zipcodeInput" placeholder="Zipcode" style="width: 70px; margin-bottom: 2px;"
                                       onkeyup="setTimeout(applyFilters, 300)" onchange="applyFilters()">
                                <select id="radiusSelect" onchange="applyFilters()">
                                    <option value="25">25 miles</option>
                                    <option value="50">50 miles</option>
                                    <option value="100">100 miles</option>
                                    <option value="200">200 miles</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="filter-header salary-col">
                        Salary
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <select class="column-filter" id="salaryTypeFilter" onchange="handleSalaryTypeChange()">
                                <option value="all">All Salaries</option>
                                <option value="not_specified">No Salary Listed</option>
                                <option value="range">Range (Lower End Pay)</option>
                            </select>
                            <div id="salaryRangeFilter" style="display: none;">
                                <input type="text" id="minSalaryInput" placeholder="Min (e.g. 70k)" style="width: 60px; margin-bottom: 2px;"
                                       onkeyup="setTimeout(applyFilters, 300)" onchange="applyFilters()">
                                <input type="text" id="maxSalaryInput" placeholder="Max (e.g. 110k)" style="width: 60px;"
                                       onkeyup="setTimeout(applyFilters, 300)" onchange="applyFilters()">
                            </div>
                        </div>
                    </div>
                    <div class="filter-header">
                        Date Added
                        <select class="column-filter" id="dateFilter" onchange="applyFilters()">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="3days">Past 3 Days</option>
                            <option value="week">Past Week</option>
                            <option value="14days">Past 14 Days</option>
                            <option value="month">Past Month</option>
                        </select>
                    </div>
                    <div>Actions</div>
                </div>

                <!-- Job List -->
                <div id="jobList">
                    <!-- Jobs will be loaded here -->
                </div>
            </div>


            <!-- Bottom Bar -->
            <div class="bottom-bar">
                <div class="selection-info" id="selectionInfo">
                    0 jobs selected
                </div>
                <div class="bulk-actions" id="bulkActions">
                    <!-- Actions will be populated based on current view -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentView = 'filtered';

        // Helper function to format salary amounts
        function formatSalary(amount) {
            if (!amount) return '';

            const num = parseFloat(amount);
            if (isNaN(num)) return amount.toString();

            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(0) + 'K';
            } else {
                return num.toFixed(0);
            }
        }
        let jobs = [];
        let allJobs = []; // Store all jobs for filtering
        let selectedJobs = new Set();
        let currentUser = null;
        let savedJobUrls = new Set(); // Track saved job URLs for indicators

        // Filter state
        let activeFilters = {
            job: '',
            company: '',
            locationType: 'all',
            location: '',
            state: '',
            zipcode: '',
            radius: '25',
            salaryType: 'all',
            minSalary: '',
            maxSalary: '',
            date: ''
        };
        let appliedJobUrls = new Set(); // Track applied job URLs for indicators
        let notInterestedJobUrls = new Set(); // Track not interested job URLs for indicators
        let currentModalJob = null; // Track currently displayed job in modal

        function displayUserInfo(userData) {
            const userInfo = document.getElementById('userInfo');
            const userAvatar = userInfo.querySelector('.user-avatar');
            const userName = userInfo.querySelector('.user-name');
            const userEmail = userInfo.querySelector('.user-email');

            // Display user initials in avatar
            const name = userData.username || userData.email || 'User';
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            userAvatar.textContent = initials;

            userName.textContent = userData.username || 'User';
            userEmail.textContent = userData.email || '';

            userInfo.style.display = 'block';
        }

        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'flex';
            document.getElementById('loginUsername').focus();
        }

        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const submitBtn = document.getElementById('loginSubmitBtn');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter both username and password';
                errorDiv.style.display = 'block';
                return;
            }

            // Show loading state
            submitBtn.textContent = 'Signing In...';
            submitBtn.disabled = true;
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.access_token) {
                    localStorage.setItem('auth_token', data.access_token);
                    currentUser = data.user;
                    displayUserInfo(data.user);
                    hideLoginModal();
                    showNotification('Login successful!', 'success');
                    loadJobData(); // Load data after successful login
                } else {
                    errorDiv.textContent = data.message || 'Login failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                // Reset button state
                submitBtn.textContent = 'Sign In';
                submitBtn.disabled = false;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            setupAutoScrapingEventListeners();
        });

        function setupAutoScrapingEventListeners() {
            // Auto-scraping event listeners will be set up when the form is created
        }

        async function initializeApp() {
            const isAuthenticated = await checkAuthStatus();
            
            if (isAuthenticated) {
                // Load saved jobs for tracking indicators
                await loadSavedJobsForTracking();

                // Initialize bulk actions for current view
                updateBulkActions(currentView);

                // Load data for current view
                loadJobData();
            } else {
                showLoginModal();
            }
        }

        async function loadSavedJobsForTracking() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) return;

                const response = await fetch('/user/saved-jobs?limit=1000', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.saved_jobs) {
                        savedJobUrls.clear();
                        appliedJobUrls.clear();
                        notInterestedJobUrls.clear();

                        data.saved_jobs.forEach(job => {
                            if (job.job_data && job.job_data.job_url) {
                                const jobUrl = job.job_data.job_url;

                                // Always track as saved
                                savedJobUrls.add(jobUrl);

                                // Track status based on job properties
                                if (job.applied) {
                                    appliedJobUrls.add(jobUrl);
                                } else if (job.not_interested) {
                                    notInterestedJobUrls.add(jobUrl);
                                }
                            }
                        });
                        console.log('Loaded job status tracking:', {
                            saved: savedJobUrls.size,
                            applied: appliedJobUrls.size,
                            notInterested: notInterestedJobUrls.size
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading saved jobs for tracking:', error);
            }
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item[data-view]').forEach(item => {
                item.addEventListener('click', (e) => {
                    const view = e.currentTarget.dataset.view;
                    if (view === 'settings') {
                        // Handle settings view - could be a separate settings panel or redirect
                        showNotification('Settings panel coming soon!', 'success');
                        return;
                    }
                    if (view !== currentView) {
                        switchView(view);
                    }
                });
            });

            // Mobile menu toggle
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

            // Search
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Login modal
            document.getElementById('loginSubmitBtn').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            document.getElementById('loginUsername').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('loginPassword').focus();
                }
            });
        }

        function switchView(view) {
            // Don't switch if already on this view
            if (currentView === view) return;

            currentView = view;

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const targetNavItem = document.querySelector(`[data-view="${view}"]`);
            if (targetNavItem) {
                targetNavItem.classList.add('active');
            }

            // Update page title
            const titles = {
                'filtered': 'Filtered Jobs',
                'saved': 'Saved Jobs',
                'autoscraping': 'Auto-Scraping Settings'
            };
            document.getElementById('pageTitle').textContent = titles[view] || 'Dashboard';

            // Show/hide job list header based on view
            const jobListHeader = document.querySelector('.job-list-header');
            if (jobListHeader) {
                if (view === 'autoscraping') {
                    jobListHeader.style.display = 'none';
                } else {
                    jobListHeader.style.display = 'grid';
                }
            }

            // Clear selection
            selectedJobs.clear();
            updateSelectionInfo();

            // Update bulk actions based on view
            updateBulkActions(view);

            // Load data for job-related views
            if (view === 'filtered' || view === 'saved') {
                loadJobData();
                // Refresh saved jobs tracking when switching to filtered view
                if (view === 'filtered') {
                    loadSavedJobsForTracking();
                }
            } else if (view === 'autoscraping') {
                loadAutoScrapingConfig();
            }
        }

        async function loadJobData() {
            try {
                // If auto-scraping view, show auto-scraping content
                if (currentView === 'autoscraping') {
                    showAutoScrapingContent();
                    return;
                }
                
                showLoading();

                let endpoint = '';
                let params = new URLSearchParams();

                if (currentView === 'filtered') {
                    endpoint = '/api/filtered-jobs';
                    // Add default filters similar to original filtered-jobs page
                    params.append('days_back', '7');
                    params.append('limit', '100');
                    params.append('offset', '0');
                } else if (currentView === 'saved') {
                    endpoint = '/user/saved-jobs';
                    params.append('limit', '100');
                }

                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showError('Please log in to view jobs');
                    return;
                }

                const fullUrl = `${endpoint}?${params.toString()}`;
                console.log('Loading jobs from:', fullUrl);

                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(fullUrl, { headers });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('auth_token');
                        showLoginModal();
                        return;
                    }

                    // Try to get error details
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}. ${errorText}`);
                }

                const data = await response.json();
                console.log('Response data for view', currentView, ':', data);

                // Log first job structure for debugging
                if (data.filtered_jobs && data.filtered_jobs.length > 0) {
                    console.log('Sample filtered job structure:', data.filtered_jobs[0]);
                } else if (data.saved_jobs && data.saved_jobs.length > 0) {
                    console.log('Sample saved job structure:', data.saved_jobs[0]);
                }

                if (currentView === 'filtered') {
                    // Handle filtered jobs response format
                    if (data.success && data.filtered_jobs) {
                        allJobs = data.filtered_jobs; // Store all jobs for filtering
                        jobs = [...allJobs]; // Copy for display
                        console.log('Loaded filtered jobs:', jobs.length, 'Sample job:', jobs[0]);
                    } else {
                        console.warn('No filtered_jobs in response:', data);
                        allJobs = [];
                        jobs = [];
                    }
                } else if (currentView === 'saved') {
                    // Handle saved jobs response format
                    if (data.success && data.saved_jobs) {
                        allJobs = data.saved_jobs; // Store all jobs for filtering
                        jobs = [...allJobs]; // Copy for display
                        console.log('Loaded saved jobs:', jobs.length, 'Sample job:', jobs[0]);
                    } else {
                        console.warn('No saved_jobs in response:', data);
                        allJobs = [];
                        jobs = [];
                    }
                }

                // Populate filter dropdowns with job data
                populateFilterDropdowns();

                updateJobCounts();
                renderJobs();

            } catch (error) {
                console.error('Error loading jobs:', error);

                // Check if the error is due to HTML response (likely a redirect or error page)
                if (error.message.includes("Unexpected token '<'")) {
                    localStorage.removeItem('auth_token');
                    showLoginModal();
                } else {
                    showError(`Failed to load jobs: ${error.message}`);
                }
            }
        }

        function renderJobs() {
            const jobList = document.getElementById('jobList');

            if (!jobs || jobs.length === 0) {
                showEmptyState();
                return;
            }

            jobList.innerHTML = jobs.map(job => createJobRow(job)).join('');

            // Add click event listeners to job rows
            jobList.querySelectorAll('.job-row').forEach(row => {
                const checkbox = row.querySelector('.job-checkbox');
                const jobId = row.dataset.jobId;

                // Make entire row clickable for selection
                row.addEventListener('click', (e) => {
                    // Don't trigger selection if clicking on action buttons or links
                    if (e.target.closest('.action-btn') || e.target.closest('a')) {
                        return;
                    }
                    toggleJobSelection(jobId);
                });

                // Checkbox click should still work but not double-toggle
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Selection is already handled by row click
                });
            });
        }

        function createJobRow(job) {

            // Handle different data structures: filtered jobs vs saved jobs
            let actualJob, jobId, isSelected;

            if (currentView === 'filtered' && job.scraped_job) {
                // Filtered jobs have nested structure: job.scraped_job
                actualJob = job.scraped_job;
                jobId = job.id; // filtered_job_view ID
                isSelected = selectedJobs.has(jobId);
            } else if (currentView === 'saved' && job.job_data) {
                // Saved jobs have nested structure: job.job_data
                actualJob = job.job_data;
                jobId = job.id;
                isSelected = selectedJobs.has(jobId);
            } else {
                // Direct job object (fallback)
                actualJob = job;
                jobId = job.id || job.scraped_job_id;
                isSelected = selectedJobs.has(jobId);
            }

            // Score calculation removed - no longer displaying scores in the table

            // Format date - use scraped date to show when job was added to our system
            let date;
            if (currentView === 'filtered') {
                date = actualJob.scraped_at || job.filter_date || actualJob.date_posted;
            } else if (currentView === 'saved') {
                date = actualJob.scraped_at || job.created_at || actualJob.date_posted;
            } else {
                date = actualJob.scraped_at || actualJob.date_saved || actualJob.created_at;
            }

            let dateText = 'N/A';
            if (date) {
                try {
                    const dateObj = new Date(date);
                    if (!isNaN(dateObj.getTime())) {
                        dateText = dateObj.toLocaleDateString();
                    }
                } catch (e) {
                    console.warn('Invalid date:', date);
                }
            }

            // Format salary
            let salaryText = 'Not specified';
            let salaryClass = 'no-salary';

            if (actualJob.min_amount || actualJob.max_amount) {
                const currency = actualJob.currency || '$';
                const interval = actualJob.interval || 'year';

                if (actualJob.min_amount && actualJob.max_amount) {
                    // Range: $80K - $120K
                    const minFormatted = formatSalary(actualJob.min_amount);
                    const maxFormatted = formatSalary(actualJob.max_amount);
                    salaryText = `${currency}${minFormatted} - ${currency}${maxFormatted}`;
                } else if (actualJob.min_amount) {
                    // Min only: $80K+
                    const minFormatted = formatSalary(actualJob.min_amount);
                    salaryText = `${currency}${minFormatted}+`;
                } else if (actualJob.max_amount) {
                    // Max only: Up to $120K
                    const maxFormatted = formatSalary(actualJob.max_amount);
                    salaryText = `Up to ${currency}${maxFormatted}`;
                }
                salaryClass = '';

                // Add interval if not yearly
                if (interval !== 'year' && interval !== 'yearly') {
                    salaryText += `/${interval}`;
                }
            }

            // Check job status and determine which indicator to show (priority: Applied > Not Interested > Saved > Actions)
            let statusIndicator = '';
            let isApplied = false;
            let isNotInterested = false;
            if (actualJob.job_url) {
                const jobUrl = actualJob.job_url;
                isApplied = appliedJobUrls.has(jobUrl);
                isNotInterested = notInterestedJobUrls.has(jobUrl);

                if (isApplied) {
                    statusIndicator = '<span class="applied-indicator" onclick="toggleJobStatus(\'${jobId}\', \'applied\')" title="Click to remove applied status">Applied</span>';
                } else if (isNotInterested) {
                    statusIndicator = '<span class="not-interested-indicator" onclick="toggleJobStatus(\'${jobId}\', \'not_interest\')" title="Click to remove not interested status">Not Interested</span>';
                } else if (savedJobUrls.has(jobUrl)) {
                    statusIndicator = '<span class="saved-indicator" onclick="showJobStatusMenu(\'${jobId}\', event)" title="Click to mark as applied or not interested">Saved</span>';
                } else {
                    // For unsaved jobs, leave status indicator empty
                    statusIndicator = '';
                }
            }

            return `
                <div class="job-row ${isSelected ? 'selected' : ''}" data-job-id="${jobId}">
                    <div class="job-checkbox ${isSelected ? 'checked' : ''}"></div>
                    <div class="job-title">
                        ${actualJob.title || 'No Title'}
                        ${statusIndicator}
                    </div>
                    <div class="job-company">
                        <div class="company-logo"></div>
                        <span>${actualJob.company || 'Unknown Company'}</span>
                    </div>
                    <div class="job-location">${actualJob.location || 'Remote'}</div>
                    <div class="job-salary ${salaryClass}">${salaryText}</div>
                    <div class="job-date">${dateText}</div>
                    <div class="job-actions">
                        <button class="action-btn view-jd-btn" onclick="viewJobDescription('${jobId}')">
                            üëÅÔ∏è View JD
                        </button>
                        ${actualJob.job_url ? `
                        <a href="${actualJob.job_url}" target="_blank" class="action-btn apply-btn">
                            üöÄ Apply
                        </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function toggleJobSelection(jobId) {
            if (selectedJobs.has(jobId)) {
                selectedJobs.delete(jobId);
            } else {
                selectedJobs.add(jobId);
            }

            updateJobRowSelection(jobId);
            updateSelectionInfo();
        }

        function updateJobRowSelection(jobId) {
            const row = document.querySelector(`[data-job-id="${jobId}"]`);
            const checkbox = row.querySelector('.job-checkbox');

            if (selectedJobs.has(jobId)) {
                row.classList.add('selected');
                checkbox.classList.add('checked');
            } else {
                row.classList.remove('selected');
                checkbox.classList.remove('checked');
            }
        }

        function updateSelectionInfo() {
            const count = selectedJobs.size;
            const text = count === 1 ? '1 job selected' : `${count} jobs selected`;
            document.getElementById('selectionInfo').textContent = text;
        }

        function updateBulkActions(view) {
            const bulkActions = document.getElementById('bulkActions');

            if (view === 'filtered') {
                // Filtered jobs: Save Selected (highlighted) + Clear Selections
                bulkActions.innerHTML = `
                    <button class="bulk-btn" id="clearSelectionsBtn" onclick="clearAllSelections()">Clear Selections</button>
                    <button class="bulk-btn primary" id="bulkSaveBtn" onclick="handleBulkSave()">üíæ Save Selected</button>
                `;
            } else if (view === 'saved') {
                // Saved jobs: Multiple actions + Clear Selections
                bulkActions.innerHTML = `
                    <button class="bulk-btn" id="clearSelectionsBtn" onclick="clearAllSelections()">Clear Selections</button>
                    <button class="bulk-btn" id="bulkNotInterestedBtn" onclick="handleBulkNotInterested()">‚ùå Not Interested</button>
                    <button class="bulk-btn" id="bulkApplyNowBtn" onclick="handleBulkApplyNow()">üöÄ Apply Now</button>
                    <button class="bulk-btn primary" id="bulkMarkAppliedBtn" onclick="handleBulkMarkApplied()">‚úÖ Mark as Applied</button>
                `;
            } else {
                // Other views: just clear selections
                bulkActions.innerHTML = `
                    <button class="bulk-btn" id="clearSelectionsBtn" onclick="clearAllSelections()">Clear Selections</button>
                `;
            }
        }

        function clearAllSelections() {
            selectedJobs.clear();
            updateSelectionInfo();

            // Update UI to reflect cleared selections
            document.querySelectorAll('.job-row').forEach(row => {
                row.classList.remove('selected');
                const checkbox = row.querySelector('.job-checkbox');
                if (checkbox) {
                    checkbox.classList.remove('checked');
                }
            });
        }

        function updateJobCounts() {
            // Keep track of actual counts for each view
            if (currentView === 'filtered') {
                document.getElementById('filteredCount').textContent = jobs.length;
            } else if (currentView === 'saved') {
                document.getElementById('savedCount').textContent = jobs.length;
            }

            // Initialize other counts if they haven't been loaded yet
            if (!document.getElementById('filteredCount').textContent || document.getElementById('filteredCount').textContent === '0') {
                if (currentView !== 'filtered') {
                    document.getElementById('filteredCount').textContent = '0';
                }
            }
            if (!document.getElementById('savedCount').textContent || document.getElementById('savedCount').textContent === '0') {
                if (currentView !== 'saved') {
                    document.getElementById('savedCount').textContent = '0';
                }
            }
        }

        function showLoading() {
            document.getElementById('jobList').innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner" style="width: 40px; height: 40px; border: 3px solid #2d3561; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;"></div>
                    <div style="font-size: 16px; font-weight: 500;">Loading jobs...</div>
                    <div style="font-size: 14px; margin-top: 8px; opacity: 0.7;">Please wait while we fetch your opportunities</div>
                </div>
            `;
        }

        function showEmptyState() {
            const messages = {
                'filtered': {
                    icon: 'üéØ',
                    title: 'No filtered jobs found',
                    subtitle: 'Run the auto-scraping process or adjust your filters to see jobs here.',
                    action: '<button class="action-btn primary" onclick="window.location.href=\'/autoscraping\'" style="padding: 12px 24px; font-size: 14px; margin-top: 16px;">‚öôÔ∏è Configure Auto-Scraping</button>'
                },
                'saved': {
                    icon: 'üíæ',
                    title: 'No saved jobs yet',
                    subtitle: 'Save jobs from the filtered list to keep track of opportunities you\'re interested in.',
                    action: '<button class="action-btn primary" onclick="switchView(\'filtered\')" style="padding: 12px 24px; font-size: 14px; margin-top: 16px;">üéØ View Filtered Jobs</button>'
                }
            };

            const message = messages[currentView];

            document.getElementById('jobList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon" style="font-size: 64px; margin-bottom: 20px; opacity: 0.8;">${message.icon}</div>
                    <div class="empty-title">${message.title}</div>
                    <div class="empty-subtitle" style="margin-bottom: 20px;">${message.subtitle}</div>
                    ${message.action}
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('jobList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon" style="font-size: 48px; margin-bottom: 16px; opacity: 0.6;">‚ö†Ô∏è</div>
                    <div class="empty-title">Oops! Something went wrong</div>
                    <div class="empty-subtitle" style="margin-bottom: 20px;">${message}</div>
                    <button class="action-btn primary" onclick="loadJobData()" style="padding: 8px 16px; font-size: 14px;">
                        üîÑ Try Again
                    </button>
                </div>
            `;
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            // Implement search filtering
            console.log('Search:', query);
        }

        async function handleBulkSave() {
            if (selectedJobs.size === 0) return;

            try {
                const token = localStorage.getItem('auth_token');
                const jobIds = Array.from(selectedJobs);

                console.log('Saving jobs:', jobIds);

                // Save each job individually as the API expects individual job objects
                let successCount = 0;
                let errors = [];

                for (const jobId of jobIds) {
                    try {
                        const job = jobs.find(j => j.id === jobId);
                        if (!job) {
                            errors.push(`Job ${jobId} not found`);
                            continue;
                        }

                        // Build job data based on current view
                        let jobData;
                        if (currentView === 'filtered' && job.scraped_job) {
                            // For filtered jobs, extract from nested structure
                            jobData = {
                                job_data: {
                                    title: job.scraped_job.title,
                                    company: job.scraped_job.company,
                                    location: job.scraped_job.location,
                                    job_url: job.scraped_job.job_url,
                                    description: job.scraped_job.description,
                                    job_type: job.scraped_job.job_type,
                                    is_remote: job.scraped_job.is_remote,
                                    min_amount: job.scraped_job.min_amount,
                                    max_amount: job.scraped_job.max_amount,
                                    currency: job.scraped_job.currency,
                                    date_posted: job.scraped_job.date_posted,
                                    site: job.scraped_job.site
                                },
                                notes: `Enhanced Score: ${job.enhanced_score || 'N/A'}, AI Relevance: ${job.ai_relevance || 'N/A'}`,
                                tags: ['filtered', 'ai-scored']
                            };
                        } else {
                            // For saved jobs or other formats
                            jobData = {
                                job_data: {
                                    title: job.title,
                                    company: job.company,
                                    location: job.location,
                                    job_url: job.job_url,
                                    description: job.description,
                                    job_type: job.job_type,
                                    is_remote: job.is_remote,
                                    min_amount: job.min_amount,
                                    max_amount: job.max_amount,
                                    currency: job.currency,
                                    date_posted: job.date_posted,
                                    site: job.site
                                },
                                notes: `Saved from dashboard`,
                                tags: ['dashboard']
                            };
                        }

                        const response = await fetch('/user/save-job', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(jobData)
                        });

                        const data = await response.json();
                        if (response.ok && data.success) {
                            successCount++;
                        } else {
                            // Handle different types of errors
                            let errorMessage = data.message || data.detail || `Failed to save job ${job.title || jobId}`;
                            
                            // Make error messages more user-friendly
                            if (errorMessage.includes('already saved')) {
                                errorMessage = `"${job.scraped_job?.title || job.title || 'Job'}" is already saved`;
                            } else if (errorMessage.includes('Job already saved')) {
                                errorMessage = `"${job.scraped_job?.title || job.title || 'Job'}" is already saved`;
                            }
                            
                            errors.push(errorMessage);
                        }
                    } catch (error) {
                        console.error(`Error saving job ${jobId}:`, error);
                        errors.push(`Error saving job: ${error.message}`);
                    }
                }

                // Clear selection and show results
                selectedJobs.clear();
                updateSelectionInfo();

                // Show combined results message
                if (successCount > 0 && errors.length > 0) {
                    // Both successes and failures - show as success with details
                    const duplicateCount = errors.filter(e => e.includes('already saved')).length;
                    const otherErrors = errors.length - duplicateCount;
                    
                    let message = `${successCount} job(s) saved successfully.`;
                    if (duplicateCount > 0) {
                        message += ` ${duplicateCount} job(s) were already saved.`;
                    }
                    if (otherErrors > 0) {
                        message += ` ${otherErrors} job(s) failed to save.`;
                    }
                    
                    showNotification(message, 'success');
                } else if (successCount > 0) {
                    // Only successes
                    showNotification(`${successCount} job(s) saved successfully!`, 'success');
                } else if (errors.length > 0) {
                    // Only failures
                    const duplicateCount = errors.filter(e => e.includes('already saved')).length;
                    if (duplicateCount === errors.length) {
                        showNotification(`All ${errors.length} job(s) were already saved.`, 'success');
                    } else {
                        showNotification(`${errors.length} job(s) failed to save. Check console for details.`, 'error');
                    }
                }

                // Update UI if there were any successes
                if (successCount > 0) {
                    // Update saved jobs tracking and refresh indicators
                    await loadSavedJobsForTracking();

                    // Re-render current view to show updated saved indicators
                    renderJobs();

                    // Add small delay before reload to ensure save operations complete
                    setTimeout(() => {
                        if (currentView === 'saved') {
                            loadJobData(); // Refresh saved jobs list to show new saves
                        }
                    }, 500);
                }

                // Log errors for debugging
                if (errors.length > 0) {
                    console.error('Save errors:', errors);
                }

            } catch (error) {
                console.error('Error in bulk save:', error);
                showNotification('Failed to save jobs: ' + error.message, 'error');
            }
        }

        async function handleBulkDelete() {
            if (selectedJobs.size === 0) return;

            if (!confirm(`Are you sure you want to remove ${selectedJobs.size} job(s)?`)) {
                return;
            }

            try {
                const token = localStorage.getItem('auth_token');
                const jobIds = Array.from(selectedJobs);

                const endpoint = currentView === 'saved' ? '/user/remove-saved-job' : '/api/filtered-jobs/remove';

                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ job_ids: jobIds })
                });

                const data = await response.json();
                if (data.success) {
                    selectedJobs.clear();
                    updateSelectionInfo();
                    loadJobData(); // Refresh the list
                    showNotification('Jobs removed successfully!', 'success');
                } else {
                    showNotification('Failed to remove jobs: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error removing jobs:', error);
                showNotification('Failed to remove jobs', 'error');
            }
        }

        async function handleBulkMarkApplied() {
            if (selectedJobs.size === 0) return;

            try {
                const token = localStorage.getItem('auth_token');
                const jobIds = Array.from(selectedJobs);

                // For saved jobs, we need to update the job status
                const response = await fetch('/user/update-saved-job-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        job_ids: jobIds,
                        applied: true
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update tracking sets for immediate UI feedback
                    for (const jobId of jobIds) {
                        const job = jobs.find(j => j.id === jobId);
                        if (job) {
                            let actualJob;
                            if (currentView === 'saved' && job.job_data) {
                                actualJob = job.job_data;
                            } else {
                                actualJob = job;
                            }

                            if (actualJob.job_url) {
                                appliedJobUrls.add(actualJob.job_url);
                                // Remove from not interested if it was there
                                notInterestedJobUrls.delete(actualJob.job_url);
                            }
                        }
                    }

                    selectedJobs.clear();
                    updateSelectionInfo();
                    renderJobs(); // Re-render to show updated indicators
                    showNotification(`${jobIds.length} job(s) marked as applied!`, 'success');
                } else {
                    showNotification('Failed to update job status: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error marking jobs as applied:', error);
                showNotification('Failed to mark jobs as applied', 'error');
            }
        }

        async function handleBulkNotInterested() {
            if (selectedJobs.size === 0) return;

            if (!confirm(`Mark ${selectedJobs.size} job(s) as not interested?`)) {
                return;
            }

            try {
                const token = localStorage.getItem('auth_token');
                const jobIds = Array.from(selectedJobs);

                const response = await fetch('/user/update-saved-job-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        job_ids: jobIds,
                        not_interested: true
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update tracking sets for immediate UI feedback
                    for (const jobId of jobIds) {
                        const job = jobs.find(j => j.id === jobId);
                        if (job) {
                            let actualJob;
                            if (currentView === 'saved' && job.job_data) {
                                actualJob = job.job_data;
                            } else {
                                actualJob = job;
                            }

                            if (actualJob.job_url) {
                                notInterestedJobUrls.add(actualJob.job_url);
                                // Remove from applied if it was there
                                appliedJobUrls.delete(actualJob.job_url);
                            }
                        }
                    }

                    selectedJobs.clear();
                    updateSelectionInfo();
                    renderJobs(); // Re-render to show updated indicators
                    showNotification(`${jobIds.length} job(s) marked as not interested!`, 'success');
                } else {
                    showNotification('Failed to update job status: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error marking jobs as not interested:', error);
                showNotification('Failed to mark jobs as not interested', 'error');
            }
        }

        async function handleBulkApplyNow() {
            if (selectedJobs.size === 0) return;

            // Get job URLs for selected jobs
            const jobUrls = [];
            for (const jobId of selectedJobs) {
                const job = jobs.find(j => j.id === jobId);
                if (job) {
                    let actualJob;
                    if (currentView === 'saved' && job.job_data) {
                        actualJob = job.job_data;
                    } else {
                        actualJob = job;
                    }

                    if (actualJob.job_url) {
                        jobUrls.push(actualJob.job_url);
                    }
                }
            }

            if (jobUrls.length === 0) {
                showNotification('No application URLs found for selected jobs', 'error');
                return;
            }

            if (jobUrls.length > 10) {
                if (!confirm(`This will open ${jobUrls.length} tabs. Continue?`)) {
                    return;
                }
            }

            // Open all job URLs in new tabs
            jobUrls.forEach(url => {
                window.open(url, '_blank');
            });

            showNotification(`Opened ${jobUrls.length} job application(s) in new tabs!`, 'success');

            // Optionally mark as applied after opening
            if (confirm('Mark these jobs as applied?')) {
                handleBulkMarkApplied();
            }
        }

        function showJobStatusMenu(jobId, event) {
            // Remove any existing menu
            const existingMenu = document.querySelector('.status-menu');
            if (existingMenu) existingMenu.remove();

            // Check if job is saved to determine menu options
            const job = jobs.find(j => j.id === jobId);
            let actualJob;
            if (currentView === 'saved' && job.job_data) {
                actualJob = job.job_data;
            } else {
                actualJob = job;
            }

            const isJobSaved = actualJob && actualJob.job_url && savedJobUrls.has(actualJob.job_url);

            const menu = document.createElement('div');
            menu.className = 'status-menu';

            if (isJobSaved) {
                menu.innerHTML = `
                    <button class="status-menu-item" onclick="window.menuAction('${jobId}', 'applied')">‚úÖ Mark as Applied</button>
                    <button class="status-menu-item" onclick="window.menuAction('${jobId}', 'not_interest')">‚ùå Mark as Not Interested</button>
                `;
            } else {
                menu.innerHTML = `
                    <button class="status-menu-item" onclick="window.menuAction('${jobId}', 'applied')">‚úÖ Mark as Applied</button>
                    <button class="status-menu-item" onclick="window.menuAction('${jobId}', 'not_interest')">‚ùå Mark as Not Interested</button>
                    <button class="status-menu-item" onclick="window.menuAction('${jobId}', 'save')">üíæ Save Job</button>
                `;
            }

            // Position menu near cursor and add to body
            menu.style.position = 'fixed';
            menu.style.zIndex = '1000';
            menu.style.backgroundColor = '#2d3561';
            menu.style.border = '1px solid #4a5568';
            menu.style.borderRadius = '6px';
            menu.style.padding = '8px';
            menu.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';

            // Add styles if not already added
            if (!document.querySelector('#status-menu-styles')) {
                const style = document.createElement('style');
                style.id = 'status-menu-styles';
                style.textContent = `
                    .status-menu-item {
                        display: block;
                        width: 100%;
                        padding: 8px 12px;
                        margin: 2px 0;
                        background: transparent;
                        border: none;
                        color: #cbd5e0;
                        text-align: left;
                        cursor: pointer;
                        border-radius: 4px;
                        font-size: 14px;
                    }
                    .status-menu-item:hover {
                        background: #4a5568;
                        color: #ffffff;
                    }
                `;
                document.head.appendChild(style);
            }

            // Position menu at cursor/click location
            const rect = event.target.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';

            document.body.appendChild(menu);

            // Remove menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }

        // Global menu action handler
        window.menuAction = function(jobId, statusType) {
            document.querySelector('.status-menu')?.remove();

            if (statusType === 'save') {
                // Handle save action
                saveJobFromMenu(jobId);
            } else {
                // Handle status updates
                toggleJobStatus(jobId, statusType);
            }
        };

        async function saveJobFromMenu(jobId) {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to save jobs', 'error');
                    return;
                }

                const job = jobs.find(j => j.id === jobId);
                if (!job) return;

                let actualJob;
                if (currentView === 'saved' && job.job_data) {
                    actualJob = job.job_data;
                } else {
                    actualJob = job;
                }

                const response = await fetch('/user/save-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ job_data: actualJob })
                });

                const data = await response.json();
                if (data.id) {
                    savedJobUrls.add(actualJob.job_url);
                    renderJobs(); // Re-render to show updated indicators
                    showNotification('Job saved successfully!', 'success');
                } else {
                    showNotification('Failed to save job: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving job:', error);
                showNotification('Failed to save job', 'error');
            }
        }

        async function toggleJobStatus(jobId, statusType) {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showNotification('Please log in to update job status', 'error');
                    return;
                }

                const job = jobs.find(j => j.id === jobId);
                if (!job) return;

                let actualJob;
                if (currentView === 'saved' && job.job_data) {
                    actualJob = job.job_data;
                } else {
                    actualJob = job;
                }

                if (!actualJob.job_url) return;

                // Check if job is already saved
                const isJobSaved = savedJobUrls.has(actualJob.job_url);

                // If job is not saved, save it first
                if (!isJobSaved) {
                    const saveResponse = await fetch('/user/save-job', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ job_data: actualJob })
                    });

                    const saveData = await saveResponse.json();
                    if (!saveData.id) {
                        showNotification('Failed to save job before updating status', 'error');
                        return;
                    }

                    // Update saved tracking
                    savedJobUrls.add(actualJob.job_url);

                    // Use the saved job ID for status update
                    jobId = saveData.id;
                }

                // Determine current status and toggle
                const isCurrentlyApplied = appliedJobUrls.has(actualJob.job_url);
                const isCurrentlyNotInterested = notInterestedJobUrls.has(actualJob.job_url);

                // Use the same approach as working bulk actions
                let requestBody = { job_ids: [jobId] };

                if (statusType === 'applied') {
                    requestBody.applied = !isCurrentlyApplied;
                    if (!isCurrentlyApplied) {
                        // If turning on applied, turn off not_interested
                        requestBody.not_interested = false;
                    }
                } else if (statusType === 'not_interest') {
                    requestBody.not_interested = !isCurrentlyNotInterested;
                    if (!isCurrentlyNotInterested) {
                        // If turning on not_interested, turn off applied
                        requestBody.applied = false;
                    }
                }

                console.log('Updating job status:', {
                    jobId,
                    statusType,
                    requestBody,
                    actualJob: actualJob.job_url
                });

                const response = await fetch('/user/update-saved-job-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                console.log('Status update response:', {
                    status: response.status,
                    data
                });

                if (data.success) {
                    // Update tracking sets for immediate UI feedback
                    if (statusType === 'applied') {
                        if (requestBody.applied) {
                            appliedJobUrls.add(actualJob.job_url);
                            notInterestedJobUrls.delete(actualJob.job_url);
                        } else {
                            appliedJobUrls.delete(actualJob.job_url);
                        }
                    } else if (statusType === 'not_interest') {
                        if (requestBody.not_interested) {
                            notInterestedJobUrls.add(actualJob.job_url);
                            appliedJobUrls.delete(actualJob.job_url);
                        } else {
                            notInterestedJobUrls.delete(actualJob.job_url);
                        }
                    }

                    renderJobs(); // Re-render to show updated indicators
                    const statusText = statusType === 'applied' ? 'applied' : 'not interested';
                    const action = requestBody[statusType === 'applied' ? 'applied' : 'not_interested'] ? 'marked as' : 'removed from';
                    showNotification(`Job ${action} ${statusText}!`, 'success');
                } else {
                    console.error('Status update failed:', data);
                    showNotification('Failed to update job status: ' + (data.message || data.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error updating job status:', error);
                showNotification('Failed to update job status: ' + error.message, 'error');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        async function checkAuthStatus() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                console.log('No auth token found, showing login modal');
                showLoginModal();
                return false;
            }

            try {
                const response = await fetch('/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    displayUserInfo(userData);
                    hideLoginModal();
                    return true;
                } else {
                    console.log('Invalid token, showing login modal');
                    localStorage.removeItem('auth_token');
                    showLoginModal();
                    return false;
                }
            } catch (error) {
                console.error('Error verifying token:', error);
                localStorage.removeItem('auth_token');
                showLoginModal();
                return false;
            }
        }

        function handleLogout() {
            localStorage.removeItem('auth_token');
            currentUser = null;
            showLoginModal();
        }

        function showNotification(message, type) {
            // Create and show sophisticated notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                font-size: 14px;
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                word-wrap: break-word;
            `;

            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                notification.innerHTML = `<span style="margin-right: 8px;">‚úÖ</span>${message}`;
            } else {
                notification.style.background = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
                notification.innerHTML = `<span style="margin-right: 8px;">‚ùå</span>${message}`;
            }

            document.body.appendChild(notification);

            // Trigger animation
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Job Description Modal Functions
        function viewJobDescription(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) {
                showNotification('Job not found', 'error');
                return;
            }

            currentModalJob = job;
            populateJobModal(job);
            showJobModal();
        }

        function populateJobModal(job) {
            // Handle different data structures: filtered jobs vs saved jobs
            let actualJob;
            if (currentView === 'filtered' && job.scraped_job) {
                actualJob = job.scraped_job;
            } else if (currentView === 'saved' && job.job_data) {
                actualJob = job.job_data;
            } else {
                actualJob = job;
            }

            // Populate modal title
            document.getElementById('jobModalTitle').textContent = actualJob.title || 'Job Details';

            // Populate modal content
            const content = document.getElementById('jobModalContent');
            content.innerHTML = `
                <div style="display: grid; gap: 24px;">
                    <!-- Basic Info -->
                    <div>
                        <h3 style="color: #ffffff; font-size: 18px; margin-bottom: 16px; border-bottom: 1px solid #2d3561; padding-bottom: 8px;">Job Information</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <strong style="color: #a0aec0;">Company:</strong><br>
                                <span style="color: #ffffff;">${actualJob.company || 'Not specified'}</span>
                            </div>
                            <div>
                                <strong style="color: #a0aec0;">Location:</strong><br>
                                <span style="color: #ffffff;">${actualJob.location || 'Not specified'}</span>
                            </div>
                            <div>
                                <strong style="color: #a0aec0;">Job Type:</strong><br>
                                <span style="color: #ffffff;">${actualJob.job_type || 'Not specified'}</span>
                            </div>
                            <div>
                                <strong style="color: #a0aec0;">Remote:</strong><br>
                                <span style="color: #ffffff;">${actualJob.is_remote ? 'Yes' : 'No'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Salary Info -->
                    ${actualJob.min_amount || actualJob.max_amount ? `
                    <div>
                        <h3 style="color: #ffffff; font-size: 18px; margin-bottom: 16px; border-bottom: 1px solid #2d3561; padding-bottom: 8px;">Compensation</h3>
                        <div style="color: #ffffff;">
                            ${formatSalaryForModal(actualJob.min_amount, actualJob.max_amount, actualJob.currency)}
                        </div>
                    </div>
                    ` : ''}

                    <!-- AI Scoring (for filtered jobs) -->
                    ${currentView === 'filtered' && (job.enhanced_score || job.ai_relevance) ? `
                    <div>
                        <h3 style="color: #ffffff; font-size: 18px; margin-bottom: 16px; border-bottom: 1px solid #2d3561; padding-bottom: 8px;">AI Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                            ${job.enhanced_score ? `
                            <div>
                                <strong style="color: #a0aec0;">Enhanced Score:</strong><br>
                                <span style="color: #ffffff; font-size: 20px; font-weight: 600;">${Math.round(job.enhanced_score)}/100</span>
                            </div>
                            ` : ''}
                            ${job.ai_relevance ? `
                            <div>
                                <strong style="color: #a0aec0;">AI Relevance:</strong><br>
                                <span style="color: #ffffff; font-weight: 600;">${job.ai_relevance}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Job Description -->
                    <div>
                        <h3 style="color: #ffffff; font-size: 18px; margin-bottom: 16px; border-bottom: 1px solid #2d3561; padding-bottom: 8px;">Job Description</h3>
                        <div style="color: #e2e8f0; line-height: 1.6; white-space: pre-wrap;">
                            ${actualJob.description || 'No description available'}
                        </div>
                    </div>

                    <!-- Job URL -->
                    ${actualJob.job_url ? `
                    <div>
                        <h3 style="color: #ffffff; font-size: 18px; margin-bottom: 16px; border-bottom: 1px solid #2d3561; padding-bottom: 8px;">Application Link</h3>
                        <a href="${actualJob.job_url}" target="_blank" style="color: #667eea; text-decoration: none; word-break: break-all;">
                            ${actualJob.job_url}
                        </a>
                    </div>
                    ` : ''}
                </div>
            `;

            // Update footer buttons
            const applyBtn = document.getElementById('jobModalApplyBtn');
            const saveBtn = document.getElementById('jobModalSaveBtn');

            if (actualJob.job_url) {
                applyBtn.href = actualJob.job_url;
                applyBtn.style.display = 'inline-block';
            } else {
                applyBtn.style.display = 'none';
            }

            // Check if job is already saved
            const isSaved = actualJob.job_url && savedJobUrls.has(actualJob.job_url);
            if (isSaved) {
                saveBtn.textContent = 'Already Saved';
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.6';
            } else {
                saveBtn.textContent = 'Save Job';
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
            }
        }

        function formatSalaryForModal(minAmount, maxAmount, currency) {
            if (!minAmount && !maxAmount) return 'Not specified';

            const curr = currency || 'USD';
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: curr,
                minimumFractionDigits: 0
            });

            if (minAmount && maxAmount) {
                return `${formatter.format(minAmount)} - ${formatter.format(maxAmount)} per year`;
            } else if (minAmount) {
                return `From ${formatter.format(minAmount)} per year`;
            } else {
                return `Up to ${formatter.format(maxAmount)} per year`;
            }
        }

        function showJobModal() {
            const modal = document.getElementById('jobModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeJobModal() {
            const modal = document.getElementById('jobModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
            currentModalJob = null;
        }

        async function saveJobFromModal() {
            if (!currentModalJob) return;

            try {
                // Use the same logic as bulk save but for single job
                const token = localStorage.getItem('auth_token');
                const job = currentModalJob;

                let jobData;
                if (currentView === 'filtered' && job.scraped_job) {
                    jobData = {
                        job_data: {
                            title: job.scraped_job.title,
                            company: job.scraped_job.company,
                            location: job.scraped_job.location,
                            job_url: job.scraped_job.job_url,
                            description: job.scraped_job.description,
                            job_type: job.scraped_job.job_type,
                            is_remote: job.scraped_job.is_remote,
                            min_amount: job.scraped_job.min_amount,
                            max_amount: job.scraped_job.max_amount,
                            currency: job.scraped_job.currency,
                            date_posted: job.scraped_job.date_posted,
                            site: job.scraped_job.site
                        },
                        notes: `Enhanced Score: ${job.enhanced_score || 'N/A'}, AI Relevance: ${job.ai_relevance || 'N/A'}`,
                        tags: ['filtered', 'ai-scored']
                    };
                } else if (currentView === 'saved' && job.job_data) {
                    jobData = {
                        job_data: job.job_data,
                        notes: `Saved from dashboard`,
                        tags: ['dashboard']
                    };
                } else {
                    jobData = {
                        job_data: job,
                        notes: `Saved from dashboard`,
                        tags: ['dashboard']
                    };
                }

                const response = await fetch('/user/save-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(jobData)
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    showNotification('Job saved successfully!', 'success');

                    // Update saved jobs tracking
                    await loadSavedJobsForTracking();

                    // Update modal UI
                    const saveBtn = document.getElementById('jobModalSaveBtn');
                    saveBtn.textContent = 'Already Saved';
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.6';

                    // Re-render jobs to show updated saved indicators
                    renderJobs();
                } else {
                    // Handle different types of errors with user-friendly messages
                    let errorMessage = data.message || data.detail || 'Unknown error';
                    
                    if (errorMessage.includes('already saved') || errorMessage.includes('Job already saved')) {
                        showNotification('This job is already saved!', 'success');
                        
                        // Update modal UI to show already saved state
                        const saveBtn = document.getElementById('jobModalSaveBtn');
                        saveBtn.textContent = 'Already Saved';
                        saveBtn.disabled = true;
                        saveBtn.style.opacity = '0.6';
                    } else {
                        showNotification('Failed to save job: ' + errorMessage, 'error');
                    }
                }
            } catch (error) {
                console.error('Error saving job:', error);
                showNotification('Failed to save job: ' + error.message, 'error');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('jobModal');
            if (e.target === modal) {
                closeJobModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeJobModal();
            }
        });

        // Auto-Scraping Configuration Functions
        let autoScrapingConfig = {
            enabled: false,
            schedule_time: '02:00',
            max_results: 1000,
            sites: ['indeed', 'linkedin'],
            companies: [],
            search_terms: ['software engineer', 'product manager', 'developer'],
            exclude_keywords: '',
            location: '',
            distance: 25,
            min_relevance_score: 60,
            days_old: 7,
            ai_enabled: true,
            ai_model: 'gpt-4.1-mini',
            ai_prompt: 'Evaluate job relevance for product manager/engineer/software roles.\n\nRate as exactly one of: Highly Relevant, Somewhat Relevant, Somewhat Irrelevant, Irrelevant',
            target_roles: 'product manager, engineer, software developer',
            exclude_executive: true,
            executive_keywords: 'president, director, vp, vice president, chief, head of',
            seniority_filter: '',
            default_locations: 'USA'
        };

        function showAutoScrapingContent() {
            const jobList = document.getElementById('jobList');

            // Hide job list headers when showing autoscraping content
            const jobListHeader = document.querySelector('.job-list-header');
            if (jobListHeader) {
                jobListHeader.style.display = 'none';
            }

            jobList.innerHTML = `
                <div style="background: #1a1b3a; padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <!-- Status Indicator -->
                    <div id="autoScrapingStatusIndicator" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #2d3561; border-radius: 8px; margin-bottom: 20px; color: #e2e8f0;">
                        <span id="autoScrapingStatusIcon">‚è∏Ô∏è</span>
                        <span id="autoScrapingStatusText">Auto-scraping is currently disabled</span>
                    </div>

                    <!-- Configuration Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">

                        <!-- Schedule & General Settings -->
                        <div style="background: #2d3561; border-radius: 12px; padding: 25px; border: 1px solid #4a5568;">
                            <h3 style="font-size: 1.4em; color: #ffffff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                üïê Schedule & General
                            </h3>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">Enable Auto-Scraping</label>
                                <label style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                    <input type="checkbox" id="enableScraping" style="opacity: 0; width: 0; height: 0;">
                                    <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4a5568; transition: .4s; border-radius: 34px;"></span>
                                    <span class="toggle-knob" style="position: absolute; content: ''; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                </label>
                                <div style="color: #a0aec0; font-size: 12px; margin-top: 5px;">Turn on/off automatic daily job scraping</div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">Daily Schedule Time</label>
                                <input type="time" id="scheduleTime" value="02:00" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 14px; background: #1a1b3a; color: #ffffff;">
                                <div style="color: #a0aec0; font-size: 12px; margin-top: 5px;">Time when auto-scraping runs daily (24-hour format)</div>
                            </div>

                            <!-- Hidden fields -->
                            <input type="hidden" id="maxResults" value="1000">
                            <input type="hidden" id="jobSites" value="indeed,linkedin">
                        </div>

                        <!-- Target Companies -->
                        <div style="background: #2d3561; border-radius: 12px; padding: 25px; border: 1px solid #4a5568;">
                            <h3 style="font-size: 1.4em; color: #ffffff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                üè¢ Target Companies
                            </h3>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">Add New Company</label>
                                <input type="text" id="newCompany" placeholder="Enter company name" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 14px; background: #1a1b3a; color: #ffffff; margin-bottom: 10px;">
                                <button onclick="addCompany()" style="width: 100%; padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #4a5568; color: #ffffff; transition: all 0.3s ease;">+ Add Company</button>
                            </div>

                            <div id="companiesList" style="max-height: 200px; overflow-y: auto; border: 2px solid #4a5568; border-radius: 8px; padding: 10px; background: #1a1b3a;">
                                <!-- Companies will be loaded here -->
                            </div>

                            <input type="hidden" id="defaultLocations" value="USA">
                        </div>

                        <!-- Search Terms & Filtering -->
                        <div style="background: #2d3561; border-radius: 12px; padding: 25px; border: 1px solid #4a5568;">
                            <h3 style="font-size: 1.4em; color: #ffffff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                üîç Search Terms & Filtering
                            </h3>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">Job Titles / Search Terms</label>
                                <input type="text" id="searchTermsInput" placeholder="Type and press Enter" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 14px; background: #1a1b3a; color: #ffffff;">
                                <div style="color: #a0aec0; font-size: 12px; margin-top: 5px;">Press Enter after each term to add it</div>
                                <div id="searchTermsTags" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                    <!-- Tags will be displayed here -->
                                </div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">Exclude Keywords</label>
                                <input type="text" id="excludeKeywords" placeholder="intern, unpaid, volunteer" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 14px; background: #1a1b3a; color: #ffffff;">
                                <div style="color: #a0aec0; font-size: 12px; margin-top: 5px;">Jobs containing these words will be filtered out</div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">Location</label>
                                <input type="text" id="location" placeholder="San Francisco, CA" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 14px; background: #1a1b3a; color: #ffffff;">
                                <div style="color: #a0aec0; font-size: 12px; margin-top: 5px;">City, state or country to search jobs in</div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">Distance (miles)</label>
                                <select id="distance" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 14px; background: #1a1b3a; color: #ffffff;">
                                    <option value="0">Exact location only</option>
                                    <option value="5">Within 5 miles</option>
                                    <option value="10">Within 10 miles</option>
                                    <option value="25" selected>Within 25 miles</option>
                                    <option value="50">Within 50 miles</option>
                                    <option value="100">Within 100 miles</option>
                                </select>
                                <div style="color: #a0aec0; font-size: 12px; margin-top: 5px;">Search radius from the specified location</div>
                            </div>

                            <!-- Hidden fields -->
                            <input type="hidden" id="minRelevanceScore" value="60">
                            <input type="hidden" id="daysOld" value="7">
                        </div>

                        <!-- AI Configuration -->
                        <div style="background: #2d3561; border-radius: 12px; padding: 25px; border: 1px solid #4a5568;">
                            <h3 style="font-size: 1.4em; color: #ffffff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                ü§ñ AI Relevance Configuration
                            </h3>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">Enable AI Job Evaluation</label>
                                <label style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                    <input type="checkbox" id="aiEnabled" checked style="opacity: 0; width: 0; height: 0;">
                                    <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #667eea; transition: .4s; border-radius: 34px;"></span>
                                    <span class="toggle-knob" style="position: absolute; content: ''; height: 26px; width: 26px; left: 30px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                </label>
                                <div style="color: #a0aec0; font-size: 12px; margin-top: 5px;">Use AI to evaluate job relevance and apply score bonuses</div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">AI Model</label>
                                <select id="aiModel" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 14px; background: #1a1b3a; color: #ffffff;">
                                    <option value="gpt-4.1-mini">GPT-4.1 Mini (Recommended)</option>
                                    <option value="gpt-4.1-nano">GPT-4.1 Nano (Cheaper)</option>
                                    <option value="gpt-4o-mini">GPT-4o Mini (Alternative)</option>
                                </select>
                                <div style="color: #a0aec0; font-size: 12px; margin-top: 5px;">Choose the AI model for job evaluation</div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">Custom AI Evaluation Prompt</label>
                                <textarea id="aiPrompt" placeholder="Customize the AI prompt for job evaluation..." style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 14px; background: #1a1b3a; color: #ffffff; resize: vertical; min-height: 100px;">Evaluate job relevance for product manager/engineer/software roles.

Rate as exactly one of: Highly Relevant, Somewhat Relevant, Somewhat Irrelevant, Irrelevant</textarea>
                                <div style="color: #a0aec0; font-size: 12px; margin-top: 5px;">Customize how AI evaluates job relevance for your needs</div>
                            </div>

                            <!-- Hidden fields -->
                            <input type="hidden" id="targetRoles" value="product manager, engineer, software developer">
                            <input type="hidden" id="excludeExecutive" value="true">
                            <input type="hidden" id="executiveKeywords" value="president, director, vp, vice president, chief, head of">
                            <input type="hidden" id="seniorityFilter" value="">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <button onclick="saveAutoScrapingConfiguration()" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #48bb78; color: white; transition: all 0.3s ease;">üíæ Save Configuration</button>
                        <button onclick="loadAutoScrapingConfiguration()" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #4a5568; color: white; transition: all 0.3s ease;">üîÑ Reset to Saved</button>
                        <button onclick="runAutoScrapingNow()" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transition: all 0.3s ease;">üöÄ Run Scraping Now</button>
                        <button onclick="testAutoScrapingConfiguration()" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #4a5568; color: white; transition: all 0.3s ease;">üß™ Test Configuration</button>
                    </div>
                </div>
            `;

            // Initialize autoscraping functionality
            initializeAutoScrapingEventListeners();
            loadAutoScrapingConfiguration();
            updateAutoScrapingStatus();
        }
        function initializeAutoScrapingEventListeners() {
            // Search terms input
            const searchTermsInput = document.getElementById('searchTermsInput');
            if (searchTermsInput) {
                searchTermsInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addSearchTerm();
                    }
                });
            }

            // Company input
            const newCompanyInput = document.getElementById('newCompany');
            if (newCompanyInput) {
                newCompanyInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCompany();
                    }
                });
            }

            // Auto-update status when form changes
            const formElements = document.querySelectorAll('#enableScraping, #scheduleTime, #aiEnabled');
            formElements.forEach(element => {
                element.addEventListener('change', updateAutoScrapingStatus);
            });

            // Fix toggle switches
            setupToggleSwitches();
        }

        function setupToggleSwitches() {
            // Setup enable scraping toggle
            const enableScraping = document.getElementById('enableScraping');
            if (enableScraping) {
                const slider = enableScraping.nextElementSibling;
                const knob = slider.nextElementSibling;

                // Set initial position based on checked state
                updateTogglePosition(enableScraping, slider, knob);

                enableScraping.addEventListener('change', function() {
                    updateTogglePosition(this, slider, knob);
                });
            }

            // Setup AI enabled toggle
            const aiEnabled = document.getElementById('aiEnabled');
            if (aiEnabled) {
                const slider = aiEnabled.nextElementSibling;
                const knob = slider.nextElementSibling;

                // Set initial position based on checked state
                updateTogglePosition(aiEnabled, slider, knob);

                aiEnabled.addEventListener('change', function() {
                    updateTogglePosition(this, slider, knob);
                });
            }
        }

        function updateTogglePosition(checkbox, slider, knob) {
            if (checkbox.checked) {
                slider.style.backgroundColor = '#667eea';
                knob.style.left = '30px'; // Move to right (ON position)
            } else {
                slider.style.backgroundColor = '#4a5568';
                knob.style.left = '4px'; // Move to left (OFF position)
            }
        }

        function addSearchTerm() {
            const input = document.getElementById('searchTermsInput');
            const term = input.value.trim();

            if (term && !autoScrapingConfig.search_terms.includes(term)) {
                autoScrapingConfig.search_terms.push(term);
                renderSearchTerms();
                input.value = '';
            }
        }

        function removeSearchTerm(term) {
            autoScrapingConfig.search_terms = autoScrapingConfig.search_terms.filter(t => t !== term);
            renderSearchTerms();
        }

        function renderSearchTerms() {
            const container = document.getElementById('searchTermsTags');
            if (container) {
                container.innerHTML = autoScrapingConfig.search_terms.map(term =>
                    `<div style="background: #667eea; color: white; padding: 5px 12px; border-radius: 15px; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                        ${term}
                        <span onclick="removeSearchTerm('${term}')" style="cursor: pointer; font-weight: bold; margin-left: 5px;">√ó</span>
                    </div>`
                ).join('');
            }
        }

        function addCompany() {
            const input = document.getElementById('newCompany');
            const company = input.value.trim();

            if (company && !autoScrapingConfig.companies.some(c => c.name.toLowerCase() === company.toLowerCase())) {
                autoScrapingConfig.companies.push({
                    name: company,
                    active: true
                });
                renderCompanies();
                input.value = '';
            }
        }

        function removeCompany(companyName) {
            autoScrapingConfig.companies = autoScrapingConfig.companies.filter(c => c.name !== companyName);
            renderCompanies();
        }

        function toggleCompany(companyName) {
            const company = autoScrapingConfig.companies.find(c => c.name === companyName);
            if (company) {
                company.active = !company.active;
                renderCompanies();
            }
        }

        function renderCompanies() {
            const container = document.getElementById('companiesList');
            if (container) {
                container.innerHTML = autoScrapingConfig.companies.map(company =>
                    `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 5px; background: #2d3561; border-radius: 5px;">
                        <span style="color: ${company.active ? '#48bb78' : '#a0aec0'};">
                            ${company.active ? '‚úÖ' : '‚è∏Ô∏è'} ${company.name}
                        </span>
                        <div>
                            <button onclick="toggleCompany('${company.name}')" style="font-size: 12px; padding: 5px 10px; margin-right: 5px; background: #4a5568; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ${company.active ? 'Disable' : 'Enable'}
                            </button>
                            <button onclick="removeCompany('${company.name}')" style="font-size: 12px; padding: 5px 10px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                        </div>
                    </div>`
                ).join('');
            }
        }

        function saveAutoScrapingConfiguration() {
            try {
                collectAutoScrapingFormData();

                if (!autoScrapingConfig.schedule_time || !autoScrapingConfig.max_results || !autoScrapingConfig.sites || autoScrapingConfig.sites.length === 0) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const token = localStorage.getItem('auth_token');
                fetch('/api/autoscraping/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(autoScrapingConfig)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showNotification('Configuration saved successfully!', 'success');
                        updateAutoScrapingStatus();
                    } else {
                        showNotification('Error saving configuration: ' + (data.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Save configuration error:', error);
                    showNotification('Error saving configuration: ' + error.message, 'error');
                });
            } catch (error) {
                console.error('Save configuration error:', error);
                showNotification('Error preparing configuration: ' + error.message, 'error');
            }
        }

        function collectAutoScrapingFormData() {
            try {
                autoScrapingConfig.enabled = document.getElementById('enableScraping')?.checked || false;
                autoScrapingConfig.schedule_time = document.getElementById('scheduleTime')?.value || '02:00';
                autoScrapingConfig.max_results = 1000;
                autoScrapingConfig.sites = ['indeed', 'linkedin'];
                autoScrapingConfig.exclude_keywords = document.getElementById('excludeKeywords')?.value || '';
                autoScrapingConfig.location = document.getElementById('location')?.value || '';
                autoScrapingConfig.distance = parseInt(document.getElementById('distance')?.value) || 25;
                autoScrapingConfig.min_relevance_score = 60;
                autoScrapingConfig.days_old = 7;
                autoScrapingConfig.ai_enabled = document.getElementById('aiEnabled')?.checked || false;
                autoScrapingConfig.ai_model = document.getElementById('aiModel')?.value || 'gpt-4.1-mini';
                autoScrapingConfig.ai_prompt = document.getElementById('aiPrompt')?.value || '';
                autoScrapingConfig.target_roles = 'product manager, engineer, software developer';
                autoScrapingConfig.exclude_executive = true;
                autoScrapingConfig.executive_keywords = 'president, director, vp, vice president, chief, head of';
                autoScrapingConfig.seniority_filter = '';
                autoScrapingConfig.default_locations = 'USA';

                if (autoScrapingConfig.sites.length === 0) {
                    autoScrapingConfig.sites = ['indeed'];
                }

                console.log('Collected autoscraping config:', autoScrapingConfig);
            } catch (error) {
                console.error('Error collecting form data:', error);
                showNotification('Error collecting form data: ' + error.message, 'error');
            }
        }

        function loadAutoScrapingConfiguration() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                console.log('No auth token, using default autoscraping config');
                populateAutoScrapingForm();
                return;
            }

            fetch('/api/autoscraping/config', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    autoScrapingConfig = { ...autoScrapingConfig, ...data.config };
                }
                populateAutoScrapingForm();
            })
            .catch(error => {
                console.error('Error loading autoscraping configuration:', error);
                populateAutoScrapingForm();
            });
        }

        function populateAutoScrapingForm() {
            const enableScraping = document.getElementById('enableScraping');
            const scheduleTime = document.getElementById('scheduleTime');
            const excludeKeywords = document.getElementById('excludeKeywords');
            const location = document.getElementById('location');
            const distance = document.getElementById('distance');
            const aiEnabled = document.getElementById('aiEnabled');
            const aiModel = document.getElementById('aiModel');
            const aiPrompt = document.getElementById('aiPrompt');

            if (enableScraping) {
                enableScraping.checked = autoScrapingConfig.enabled;
                // Trigger change event to update toggle appearance
                enableScraping.dispatchEvent(new Event('change'));
            }
            if (scheduleTime) scheduleTime.value = autoScrapingConfig.schedule_time;
            if (excludeKeywords) excludeKeywords.value = autoScrapingConfig.exclude_keywords || '';
            if (location) location.value = autoScrapingConfig.location || '';
            if (distance) distance.value = autoScrapingConfig.distance || 25;
            if (aiEnabled) {
                aiEnabled.checked = autoScrapingConfig.ai_enabled;
                // Trigger change event to update toggle appearance
                aiEnabled.dispatchEvent(new Event('change'));
            }
            if (aiModel) aiModel.value = autoScrapingConfig.ai_model || 'gpt-4.1-mini';
            if (aiPrompt) aiPrompt.value = autoScrapingConfig.ai_prompt || '';

            renderSearchTerms();
            renderCompanies();
            updateAutoScrapingStatus();
        }

        function updateAutoScrapingStatus() {
            const statusIndicator = document.getElementById('autoScrapingStatusIndicator');
            const statusIcon = document.getElementById('autoScrapingStatusIcon');
            const statusText = document.getElementById('autoScrapingStatusText');

            if (statusIndicator && statusIcon && statusText) {
                if (autoScrapingConfig.enabled) {
                    statusIndicator.style.background = '#22543d';
                    statusIndicator.style.color = '#68d391';
                    statusIcon.textContent = '‚úÖ';
                    statusText.textContent = `Auto-scraping is ACTIVE - runs daily at ${autoScrapingConfig.schedule_time}`;
                } else {
                    statusIndicator.style.background = '#742a2a';
                    statusIndicator.style.color = '#fc8181';
                    statusIcon.textContent = '‚è∏Ô∏è';
                    statusText.textContent = 'Auto-scraping is currently DISABLED';
                }
            }
        }

        function testAutoScrapingConfiguration() {
            collectAutoScrapingFormData();

            fetch('/api/autoscraping/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(autoScrapingConfig)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Test completed! Check logs for results.', 'success');
                } else {
                    showNotification('Test failed: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('Test error: ' + error.message, 'error');
            });
        }

        function runAutoScrapingNow() {
            if (!confirm('Are you sure you want to run job scraping now with current settings?')) {
                return;
            }

            collectAutoScrapingFormData();

            // Validate required fields
            const errors = [];

            if (!autoScrapingConfig.companies || autoScrapingConfig.companies.length === 0) {
                errors.push('At least one target company must be added');
            }

            if (!autoScrapingConfig.search_terms || autoScrapingConfig.search_terms.length === 0) {
                errors.push('At least one job title/search term must be added');
            }

            if (errors.length > 0) {
                showNotification('Cannot start scraping: ' + errors.join('. '), 'error');
                return;
            }

            const token = localStorage.getItem('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            fetch('/api/autoscraping/run', {
                method: 'POST',
                headers,
                body: JSON.stringify(autoScrapingConfig)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Scraping started! Check your email for results.', 'success');
                } else {
                    const errorMessage = data.message || data.error || 'Unknown error occurred';
                    showNotification('Failed to start scraping: ' + errorMessage, 'error');
                }
            })
            .catch(error => {
                const errorMessage = error.message || 'Network error or server unavailable';
                showNotification('Error starting scraping: ' + errorMessage, 'error');
            });
        }

        // Fix the existing loadAutoScrapingConfig function to use the new name
        function loadAutoScrapingConfig() {
            showAutoScrapingContent();
        }

        // Location parsing utilities
        function parseLocation(locationString) {
            if (!locationString) return {};

            const location = locationString.trim();
            const parts = location.split(',').map(part => part.trim());

            let city, state, country;

            // Define countries that should not be treated as states
            const countries = new Set([
                'UNITED STATES', 'US', 'USA', 'CANADA', 'CA', 'UNITED KINGDOM', 'UK',
                'AUSTRALIA', 'GERMANY', 'FRANCE', 'INDIA', 'CHINA', 'JAPAN', 'BRAZIL'
            ]);

            // Define valid US state abbreviations and names
            const validStates = new Set([
                'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID',
                'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS',
                'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK',
                'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV',
                'WI', 'WY', 'DC',
                'ALABAMA', 'ALASKA', 'ARIZONA', 'ARKANSAS', 'CALIFORNIA', 'COLORADO',
                'CONNECTICUT', 'DELAWARE', 'FLORIDA', 'GEORGIA', 'HAWAII', 'IDAHO',
                'ILLINOIS', 'INDIANA', 'IOWA', 'KANSAS', 'KENTUCKY', 'LOUISIANA', 'MAINE',
                'MARYLAND', 'MASSACHUSETTS', 'MICHIGAN', 'MINNESOTA', 'MISSISSIPPI',
                'MISSOURI', 'MONTANA', 'NEBRASKA', 'NEVADA', 'NEW HAMPSHIRE', 'NEW JERSEY',
                'NEW MEXICO', 'NEW YORK', 'NORTH CAROLINA', 'NORTH DAKOTA', 'OHIO',
                'OKLAHOMA', 'OREGON', 'PENNSYLVANIA', 'RHODE ISLAND', 'SOUTH CAROLINA',
                'SOUTH DAKOTA', 'TENNESSEE', 'TEXAS', 'UTAH', 'VERMONT', 'VIRGINIA',
                'WASHINGTON', 'WEST VIRGINIA', 'WISCONSIN', 'WYOMING'
            ]);

            if (parts.length >= 2) {
                city = parts[0];

                if (parts.length === 2) {
                    const secondPart = parts[1].toUpperCase();

                    // Check if second part is a country
                    if (countries.has(secondPart)) {
                        // Format: "New York, United States" - try to infer state from city
                        country = secondPart;

                        // Map well-known cities to states when country is specified
                        const cityToState = {
                            'NEW YORK': 'NY', 'MANHATTAN': 'NY', 'BROOKLYN': 'NY', 'QUEENS': 'NY',
                            'LOS ANGELES': 'CA', 'SAN FRANCISCO': 'CA', 'SAN JOSE': 'CA', 'OAKLAND': 'CA',
                            'CHICAGO': 'IL', 'HOUSTON': 'TX', 'DALLAS': 'TX', 'AUSTIN': 'TX',
                            'PHOENIX': 'AZ', 'PHILADELPHIA': 'PA', 'SAN ANTONIO': 'TX', 'SAN DIEGO': 'CA',
                            'BOSTON': 'MA', 'SEATTLE': 'WA', 'DENVER': 'CO', 'WASHINGTON': 'DC',
                            'MIAMI': 'FL', 'ATLANTA': 'GA', 'DETROIT': 'MI', 'PORTLAND': 'OR',
                            'LAS VEGAS': 'NV', 'MINNEAPOLIS': 'MN', 'BALTIMORE': 'MD', 'NASHVILLE': 'TN'
                        };

                        const cityUpper = city.toUpperCase();
                        state = cityToState[cityUpper] || null;
                    } else if (validStates.has(secondPart)) {
                        // Format: "San Jose, CA" - valid state
                        state = secondPart;
                        country = 'US';
                    } else {
                        // Assume it's a state/region for non-US
                        state = secondPart;
                        country = 'Unknown';
                    }
                } else if (parts.length >= 3) {
                    // Format: "San Jose, CA, US"
                    state = parts[1].toUpperCase();
                    country = parts[2].toUpperCase();
                }

                // Convert full state names to abbreviations
                if (state && validStates.has(state)) {
                    const stateAbbreviations = {
                        'CALIFORNIA': 'CA', 'NEW YORK': 'NY', 'TEXAS': 'TX', 'FLORIDA': 'FL',
                        'ILLINOIS': 'IL', 'PENNSYLVANIA': 'PA', 'OHIO': 'OH', 'GEORGIA': 'GA',
                        'NORTH CAROLINA': 'NC', 'MICHIGAN': 'MI', 'NEW JERSEY': 'NJ',
                        'VIRGINIA': 'VA', 'WASHINGTON': 'WA', 'ARIZONA': 'AZ', 'MASSACHUSETTS': 'MA',
                        'TENNESSEE': 'TN', 'INDIANA': 'IN', 'MISSOURI': 'MO', 'MARYLAND': 'MD',
                        'WISCONSIN': 'WI', 'COLORADO': 'CO', 'MINNESOTA': 'MN', 'SOUTH CAROLINA': 'SC',
                        'ALABAMA': 'AL', 'LOUISIANA': 'LA', 'KENTUCKY': 'KY', 'OREGON': 'OR',
                        'OKLAHOMA': 'OK', 'CONNECTICUT': 'CT', 'UTAH': 'UT', 'IOWA': 'IA',
                        'NEVADA': 'NV', 'ARKANSAS': 'AR', 'MISSISSIPPI': 'MS', 'KANSAS': 'KS',
                        'NEW MEXICO': 'NM', 'NEBRASKA': 'NE', 'WEST VIRGINIA': 'WV', 'IDAHO': 'ID',
                        'HAWAII': 'HI', 'NEW HAMPSHIRE': 'NH', 'MAINE': 'ME', 'MONTANA': 'MT',
                        'RHODE ISLAND': 'RI', 'DELAWARE': 'DE', 'SOUTH DAKOTA': 'SD',
                        'NORTH DAKOTA': 'ND', 'ALASKA': 'AK', 'VERMONT': 'VT', 'WYOMING': 'WY'
                    };
                    state = stateAbbreviations[state] || state;
                }
            } else {
                // Handle single word locations or special cases
                city = location;
            }

            return {
                original: location,
                city: city,
                state: state,
                country: country,
                isRemote: /remote|work from home|wfh|anywhere/i.test(location)
            };
        }

        function getUniqueStates(jobs) {
            const states = new Set();
            jobs.forEach(job => {
                let actualJob;
                if (currentView === 'filtered' && job.scraped_job) {
                    actualJob = job.scraped_job;
                } else if (currentView === 'saved' && job.job_data) {
                    actualJob = job.job_data;
                } else {
                    actualJob = job;
                }

                const parsed = parseLocation(actualJob.location);

                // Only add valid US states (not countries or null values)
                if (parsed.state && parsed.state !== 'UNITED STATES' && parsed.state !== 'US' && parsed.state !== 'USA') {
                    states.add(parsed.state);
                }
                if (parsed.isRemote) {
                    states.add('REMOTE');
                }
            });
            return Array.from(states).sort();
        }

        // Salary parsing utilities
        function parseSalaryInput(input) {
            if (!input || typeof input !== 'string') return null;

            // Remove spaces and convert to lowercase for parsing
            const cleanInput = input.trim().toLowerCase();

            // Handle various formats: 70k, 70000, $70k, $70,000, 70K, etc.
            let numericValue = cleanInput
                .replace(/[$,\s]/g, '') // Remove $, commas, spaces
                .replace(/k$/, '000')   // Convert k to 000
                .replace(/m$/, '000000'); // Convert m to 000000

            const parsed = parseFloat(numericValue);
            return isNaN(parsed) ? null : parsed;
        }

        function parseSalaryData(job) {
            // Handle different data structures for filtered vs saved jobs
            let actualJob;
            if (currentView === 'filtered' && job.scraped_job) {
                actualJob = job.scraped_job;
            } else if (currentView === 'saved' && job.job_data) {
                actualJob = job.job_data;
            } else {
                actualJob = job;
            }

            const minAmount = actualJob.min_amount;
            const maxAmount = actualJob.max_amount;

            return {
                hasSpecifiedSalary: minAmount || maxAmount,
                minSalary: minAmount ? parseFloat(minAmount) : null,
                maxSalary: maxAmount ? parseFloat(maxAmount) : null,
                averageSalary: (minAmount && maxAmount) ? (parseFloat(minAmount) + parseFloat(maxAmount)) / 2 : (minAmount ? parseFloat(minAmount) : (maxAmount ? parseFloat(maxAmount) : null))
            };
        }

        function handleSalaryTypeChange() {
            const typeFilter = document.getElementById('salaryTypeFilter').value;

            // Hide salary range inputs
            document.getElementById('salaryRangeFilter').style.display = 'none';

            // Show range inputs if range is selected
            if (typeFilter === 'range') {
                document.getElementById('salaryRangeFilter').style.display = 'block';
            }

            // Apply filters after changing type
            applyFilters();
        }

        // Location filtering functions
        function handleLocationTypeChange() {
            const typeFilter = document.getElementById('locationTypeFilter').value;

            // Hide all location filter options
            document.getElementById('locationFilter').style.display = 'none';
            document.getElementById('stateFilter').style.display = 'none';
            document.getElementById('distanceFilter').style.display = 'none';

            // Show appropriate filter based on selection
            switch(typeFilter) {
                case 'exact':
                    document.getElementById('locationFilter').style.display = 'block';
                    break;
                case 'state':
                    document.getElementById('stateFilter').style.display = 'block';
                    populateStateFilter();
                    break;
                case 'distance':
                    document.getElementById('distanceFilter').style.display = 'block';
                    break;
                default:
                    // 'all' - no additional filter needed
                    break;
            }

            // Apply filters after changing type
            applyFilters();
        }

        function populateStateFilter() {
            const stateFilter = document.getElementById('stateFilter');
            if (!stateFilter) return;

            const states = getUniqueStates(allJobs);

            // Clear existing options except "All States"
            stateFilter.innerHTML = '<option value="">All States</option>';

            // Add state options
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateFilter.appendChild(option);
            });
        }

        // Filtering Functions
        function clearAllFilters() {
            // Reset all filter dropdowns
            document.getElementById('jobFilter').value = '';
            document.getElementById('companyFilter').value = '';
            document.getElementById('locationTypeFilter').value = 'all';
            document.getElementById('locationFilter').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('zipcodeInput').value = '';
            document.getElementById('radiusSelect').value = '25';
            document.getElementById('salaryTypeFilter').value = 'all';
            document.getElementById('minSalaryInput').value = '';
            document.getElementById('maxSalaryInput').value = '';
            document.getElementById('dateFilter').value = '';

            // Reset filter displays
            handleLocationTypeChange();
            handleSalaryTypeChange();

            // Reset activeFilters object
            activeFilters = {
                job: '',
                company: '',
                locationType: 'all',
                location: '',
                state: '',
                zipcode: '',
                radius: '25',
                salaryType: 'all',
                minSalary: '',
                maxSalary: '',
                date: ''
            };

            // Reset jobs array to show all jobs
            jobs = [...allJobs];
            renderJobs();
            console.log('All filters cleared, showing all jobs:', jobs.length);
        }

        function applyFilters() {
            // Get current filter values
            activeFilters.job = document.getElementById('jobFilter')?.value || '';
            activeFilters.company = document.getElementById('companyFilter')?.value || '';
            activeFilters.date = document.getElementById('dateFilter')?.value || '';

            // Handle different location filter types
            activeFilters.locationType = document.getElementById('locationTypeFilter')?.value || 'all';
            activeFilters.location = document.getElementById('locationFilter')?.value || '';
            activeFilters.state = document.getElementById('stateFilter')?.value || '';
            activeFilters.zipcode = document.getElementById('zipcodeInput')?.value || '';
            activeFilters.radius = document.getElementById('radiusSelect')?.value || '25';

            // Handle different salary filter types
            activeFilters.salaryType = document.getElementById('salaryTypeFilter')?.value || 'all';
            activeFilters.minSalary = document.getElementById('minSalaryInput')?.value || '';
            activeFilters.maxSalary = document.getElementById('maxSalaryInput')?.value || '';

            console.log('Applying filters:', activeFilters);
            console.log('Date filter value specifically:', document.getElementById('dateFilter')?.value, 'activeFilters.date:', activeFilters.date);
            console.log('Total jobs before filtering:', allJobs.length);

            // Filter jobs based on active filters
            let filteredJobs = allJobs.filter(job => {
                const jobMatch = matchesJobFilter(job);
                const companyMatch = matchesCompanyFilter(job);
                const locationMatch = matchesLocationFilter(job);
                const salaryMatch = matchesSalaryFilter(job);
                const dateMatch = matchesDateFilter(job);

                const overallMatch = jobMatch && companyMatch && locationMatch && salaryMatch && dateMatch;

                // Debug filter results for jobs that fail date filter
                if (!dateMatch && activeFilters.date) {
                    console.log(`Job filtered out by date: ${job.scraped_job?.title || job.job_data?.title || job.title} - dateMatch: ${dateMatch}`);
                }

                // Debug overall filter logic
                if (!overallMatch) {
                    console.log(`Job filtered out: jobMatch=${jobMatch}, companyMatch=${companyMatch}, locationMatch=${locationMatch}, salaryMatch=${salaryMatch}, dateMatch=${dateMatch}`);
                }

                return overallMatch;
            });

            console.log('Jobs after filtering:', filteredJobs.length);

            // Log sample location and salary data for analysis
            if (filteredJobs.length > 0) {
                console.log('Sample location formats:', filteredJobs.slice(0, 10).map(job => {
                    let actualJob;
                    if (currentView === 'filtered' && job.scraped_job) {
                        actualJob = job.scraped_job;
                    } else if (currentView === 'saved' && job.job_data) {
                        actualJob = job.job_data;
                    } else {
                        actualJob = job;
                    }
                    return actualJob.location;
                }));

                console.log('Sample salary data:', filteredJobs.slice(0, 5).map(job => {
                    let actualJob;
                    if (currentView === 'filtered' && job.scraped_job) {
                        actualJob = job.scraped_job;
                    } else if (currentView === 'saved' && job.job_data) {
                        actualJob = job.job_data;
                    } else {
                        actualJob = job;
                    }
                    return {
                        title: actualJob.title,
                        min_amount: actualJob.min_amount,
                        max_amount: actualJob.max_amount,
                        parsed: parseSalaryData(job)
                    };
                }));
            }

            // Update the jobs array and re-render
            jobs = filteredJobs;
            renderJobs();
        }

        function matchesJobFilter(job) {
            if (!activeFilters.job) return true;

            // Handle different data structures for filtered vs saved jobs
            let actualJob;
            if (currentView === 'filtered' && job.scraped_job) {
                actualJob = job.scraped_job;
            } else if (currentView === 'saved' && job.job_data) {
                actualJob = job.job_data;
            } else {
                actualJob = job;
            }

            if (!actualJob.job_url) return false;

            // Status hierarchy: applied > not_interested > saved > new
            // Each job should only show in ONE status category
            const isApplied = appliedJobUrls.has(actualJob.job_url);
            const isNotInterested = notInterestedJobUrls.has(actualJob.job_url);
            const isSaved = savedJobUrls.has(actualJob.job_url);

            switch(activeFilters.job) {
                case 'new':
                    // New = not saved, not applied, not marked as not interested
                    return !isSaved && !isApplied && !isNotInterested;
                case 'saved':
                    // Saved = saved but NOT applied and NOT not interested
                    return isSaved && !isApplied && !isNotInterested;
                case 'applied':
                    // Applied = marked as applied (regardless of saved status)
                    return isApplied;
                case 'not_interested':
                    // Not interested = marked as not interested (regardless of saved status)
                    return isNotInterested;
                default:
                    return true;
            }
        }

        function matchesCompanyFilter(job) {
            if (!activeFilters.company) return true;

            // Handle different data structures for filtered vs saved jobs
            let actualJob;
            if (currentView === 'filtered' && job.scraped_job) {
                actualJob = job.scraped_job;
            } else if (currentView === 'saved' && job.job_data) {
                actualJob = job.job_data;
            } else {
                actualJob = job;
            }

            const company = (actualJob.company || '').trim();
            return company === activeFilters.company;
        }

        function matchesLocationFilter(job) {
            // If no location filtering is applied, show all jobs
            if (activeFilters.locationType === 'all') return true;

            // Handle different data structures for filtered vs saved jobs
            let actualJob;
            if (currentView === 'filtered' && job.scraped_job) {
                actualJob = job.scraped_job;
            } else if (currentView === 'saved' && job.job_data) {
                actualJob = job.job_data;
            } else {
                actualJob = job;
            }

            const parsedLocation = parseLocation(actualJob.location);

            switch(activeFilters.locationType) {
                case 'exact':
                    if (!activeFilters.location) return true;
                    return parsedLocation.original === activeFilters.location;

                case 'state':
                    if (!activeFilters.state) return true;
                    if (activeFilters.state === 'REMOTE') {
                        return parsedLocation.isRemote;
                    }
                    return parsedLocation.state === activeFilters.state;

                case 'distance':
                    if (!activeFilters.zipcode) return true;
                    // For now, implement basic distance filtering
                    // This would ideally use a proper geocoding service
                    return matchesDistanceFilter(parsedLocation, activeFilters.zipcode, activeFilters.radius);

                default:
                    return true;
            }
        }

        function matchesDistanceFilter(parsedLocation, zipcode, radius) {
            // Simplified distance filtering
            // In a real implementation, you'd use geocoding APIs to get coordinates
            // and calculate actual distances

            // For now, let's implement a basic city/state matching
            // If the job location contains the same state as the zipcode, consider it a match

            // Basic zipcode to state mapping for major zipcodes
            const zipcodeToState = {
                '94': 'CA', '95': 'CA', '90': 'CA', '91': 'CA', '92': 'CA', '93': 'CA',
                '10': 'NY', '11': 'NY', '12': 'NY', '13': 'NY', '14': 'NY',
                '60': 'IL', '75': 'TX', '77': 'TX', '33': 'FL', '32': 'FL',
                '20': 'DC', '22': 'VA', '30': 'GA', '80': 'CO', '85': 'AZ',
                '98': 'WA', '97': 'OR', '02': 'MA', '19': 'PA'
            };

            const zipPrefix = zipcode.substring(0, 2);
            const estimatedState = zipcodeToState[zipPrefix];

            if (estimatedState && parsedLocation.state === estimatedState) {
                return true;
            }

            // If remote work, always include in distance searches
            if (parsedLocation.isRemote) {
                return true;
            }

            // Default to false if we can't determine location match
            return false;
        }

        function matchesSalaryFilter(job) {
            // If no salary filtering is applied, show all jobs
            if (activeFilters.salaryType === 'all') return true;

            const salaryData = parseSalaryData(job);

            switch(activeFilters.salaryType) {
                case 'not_specified':
                    return !salaryData.hasSpecifiedSalary;

                case 'range':
                    if (!salaryData.hasSpecifiedSalary) return false;

                    const userMinSalary = parseSalaryInput(activeFilters.minSalary);
                    const userMaxSalary = parseSalaryInput(activeFilters.maxSalary);

                    // If no range specified, show all jobs with salary
                    if (!userMinSalary && !userMaxSalary) return true;

                    const jobMinSalary = salaryData.minSalary;
                    const jobMaxSalary = salaryData.maxSalary;

                    // STRICT range filtering logic:
                    // User min: Job's MIN salary must be >= user's min (job GUARANTEES at least user's minimum)
                    // User max: Job's MAX salary must be <= user's max (job doesn't exceed user's maximum)

                    let matchesRange = true;

                    if (userMinSalary) {
                        // STRICT: Job's MINIMUM salary must be >= user's minimum (guarantees at least user's minimum)
                        // Use job's min salary if available, otherwise use max salary
                        const jobBottomSalary = jobMinSalary || jobMaxSalary;
                        if (!jobBottomSalary || jobBottomSalary < userMinSalary) {
                            console.log(`Job filtered out by min salary: Job min ${jobBottomSalary} < User min ${userMinSalary}`);
                            matchesRange = false;
                        }
                    }

                    if (userMaxSalary) {
                        // Job's MAXIMUM salary must not exceed user's maximum
                        // Use job's max salary if available, otherwise use min salary
                        const jobTopSalary = jobMaxSalary || jobMinSalary;
                        if (!jobTopSalary || jobTopSalary > userMaxSalary) {
                            console.log(`Job filtered out by max salary: Job max ${jobTopSalary} > User max ${userMaxSalary}`);
                            matchesRange = false;
                        }
                    }

                    if (matchesRange && (userMinSalary || userMaxSalary)) {
                        console.log(`Job matches salary range: ${jobMinSalary}-${jobMaxSalary} vs user ${userMinSalary}-${userMaxSalary}`);
                    }

                    return matchesRange;

                default:
                    return true;
            }
        }

        function matchesDateFilter(job) {
            if (!activeFilters.date) return true;

            // Handle different data structures for filtered vs saved jobs
            let actualJob;
            if (currentView === 'filtered' && job.scraped_job) {
                actualJob = job.scraped_job;
            } else if (currentView === 'saved' && job.job_data) {
                actualJob = job.job_data;
            } else {
                actualJob = job;
            }

            // Use the same date field selection logic as the display function
            let date;
            if (currentView === 'filtered') {
                date = actualJob.scraped_at || job.filter_date || actualJob.date_posted;
            } else if (currentView === 'saved') {
                date = actualJob.scraped_at || job.created_at || actualJob.date_posted;
            } else {
                date = actualJob.scraped_at || actualJob.date_saved || actualJob.created_at;
            }

            if (!date) return true;

            const jobDate = new Date(date);
            const now = new Date();

            console.log(`Raw date from job: "${date}", Parsed jobDate: ${jobDate.toString()}, Now: ${now.toString()}`);

            // Check if date parsing failed
            if (isNaN(jobDate.getTime())) {
                console.warn(`Invalid date found: "${date}"`);
                return true; // Show jobs with invalid dates
            }

            // Get dates without time components for accurate day comparison
            const jobDateOnly = new Date(jobDate.getFullYear(), jobDate.getMonth(), jobDate.getDate());
            const nowDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            const diffTime = nowDateOnly.getTime() - jobDateOnly.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            console.log(`Date filter debug: Job date ${jobDateOnly.toDateString()}, Today ${nowDateOnly.toDateString()}, Diff days: ${diffDays}, Filter: ${activeFilters.date}`);

            switch(activeFilters.date) {
                case 'today':
                    const isToday = diffDays === 0;
                    console.log(`Today filter result: ${isToday} (diffDays: ${diffDays}) for job on ${jobDateOnly.toDateString()}`);
                    return isToday;
                case '3days':
                    return diffDays >= 0 && diffDays <= 3; // Past 3 days including today
                case 'week':
                    return diffDays >= 0 && diffDays <= 7; // Past 7 days including today
                case '14days':
                    return diffDays >= 0 && diffDays <= 14; // Past 14 days including today
                case 'month':
                    return diffDays >= 0 && diffDays <= 30; // Past 30 days including today
                default:
                    return true;
            }
        }

        function populateFilterDropdowns() {
            populateCompanyFilter();
            populateLocationFilter();
        }

        function populateCompanyFilter() {
            const companyFilter = document.getElementById('companyFilter');
            if (!companyFilter) return;

            const companies = new Set();
            allJobs.forEach(job => {
                // Handle different data structures for filtered vs saved jobs
                let actualJob;
                if (currentView === 'filtered' && job.scraped_job) {
                    actualJob = job.scraped_job;
                } else if (currentView === 'saved' && job.job_data) {
                    actualJob = job.job_data;
                } else {
                    actualJob = job;
                }

                const company = actualJob.company;
                if (company && company.trim()) {
                    companies.add(company.trim());
                }
            });

            // Clear existing options except "All Companies"
            companyFilter.innerHTML = '<option value="">All Companies</option>';

            // Add company options sorted alphabetically
            Array.from(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companyFilter.appendChild(option);
            });
        }

        function populateLocationFilter() {
            const locationFilter = document.getElementById('locationFilter');
            if (!locationFilter) return;

            const locations = new Set();
            allJobs.forEach(job => {
                // Handle different data structures for filtered vs saved jobs
                let actualJob;
                if (currentView === 'filtered' && job.scraped_job) {
                    actualJob = job.scraped_job;
                } else if (currentView === 'saved' && job.job_data) {
                    actualJob = job.job_data;
                } else {
                    actualJob = job;
                }

                const location = actualJob.location;
                if (location && location.trim()) {
                    locations.add(location.trim());
                }
            });

            // Clear existing options except "All Locations"
            locationFilter.innerHTML = '<option value="">All Locations</option>';

            // Add location options sorted alphabetically
            Array.from(locations).sort().forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });
        }


    </script>
</body>
</html>